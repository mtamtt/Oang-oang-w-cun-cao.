<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OƒÉng oƒÉng w c√∫n c√°o ‚Äî Trang ch·ªß</title>
  <style>
    :root{--bg:#0b0d10;--fg:#e6e8eb;--muted:#98a1b3;--card:#0f1216;--bd:#1a1f29;--accent:#8b5cf6;}
    *{box-sizing:border-box} html,body{margin:0;padding:0;height:100%}
    body{background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(11,13,16,.98), rgba(11,13,16,.90));border-bottom:1px solid var(--bd);backdrop-filter:saturate(180%) blur(10px)}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .title{font-weight:700;letter-spacing:.2px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);background:var(--card);border-radius:999px}
    select,button{color:var(--fg);background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:8px 10px;cursor:pointer}
    .grow{flex:1}
    .grid{display:grid;gap:12px}
    .meta{color:var(--muted);font-size:13px}
    .viewer{display:flex;flex-direction:column;gap:0}
    .page{width:100%;display:block;border-radius:0;border:none;background:#0a0c0f}
    .card{padding:14px;border:1px solid var(--bd);background:var(--card);border-radius:14px}
    .hint{font-size:13px;color:var(--muted)}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bd);background:var(--card);cursor:pointer}
    .btn:hover{border-color:#2a3242}
    .toc-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .footer{padding:28px 0;color:var(--muted);text-align:center}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    /* Dock */
    .dock{position:fixed;top:56px;right:0;bottom:0;width:440px;max-width:95vw;background:var(--card);border-left:1px solid var(--bd);transform:translateX(100%);transition:transform .25s ease;z-index:50;display:flex;flex-direction:column}
    .dock.open{transform:translateX(0)}
    .dock-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--bd)}
    .dock-title{font-weight:600}
    .dock-body{flex:1;overflow:auto;display:flex;flex-direction:column}
    .tabs{display:flex;gap:8px;padding:8px 12px;border-bottom:1px solid var(--bd)}
    .tab{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:var(--card);cursor:pointer}
    .tab.active{border-color:#2a3242;background:#161a22}
    .links{display:flex;flex-wrap:wrap;gap:6px;padding:8px 12px}
    .chip{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:var(--card);cursor:pointer;font-size:13px}
    .like{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px solid var(--bd);border-radius:9999px;background:var(--card);cursor:pointer}
    .like.liked{background:#1b1f2a;border-color:#2a3242}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <a href="#home" id="homeLink" class="title">üê∂ OƒÉng oƒÉng w c√∫n c√°o</a>
      <div class="pill" id="readerControls" style="display:none">
        <label for="chapterSel">Ch∆∞∆°ng</label>
        <select id="chapterSel"></select>
      </div>
      <div class="pill" id="fitControls" style="display:none">
        <label for="fitSel">Hi·ªÉn th·ªã</label>
        <select id="fitSel">
          <option value="fit">V·ª´a khung</option>
          <option value="full">K√≠ch th∆∞·ªõc g·ªëc</option>
        </select>
      </div>
      <div class="pill" id="navControls" style="display:none">
        <button id="prevBtn">‚üµ Tr∆∞·ªõc</button>
        <button id="nextBtn">Sau ‚ü∂</button>
      </div>
      <div class="grow"></div>
      <button id="toggleDock" class="btn" title="B√¨nh lu·∫≠n (B)">üí¨ B√¨nh lu·∫≠n</button>
      <div class="meta">Ph√≠m t·∫Øt: N/P, G l√™n ƒë·∫ßu, B m·ªü/ƒë√≥ng cmt, ESC ƒë√≥ng</div>
    </div>
  </header>

  <!-- Comments dock -->
  <aside id="commentDock" class="dock" aria-hidden="true">
    <div class="dock-head">
      <div class="dock-title" id="dockTitle">B√¨nh lu·∫≠n</div>
      <div class="row">
        <span id="dockContext" class="chip">Trang: <b>‚Äî</b></span>
        <button id="closeDock" class="btn">ƒê√≥ng</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" id="tab-current">Trang n√†y</button>
      <button class="tab" id="tab-overall">T·ªïng (c·∫£ chap)</button>
      <button class="tab" id="tab-links">Trang #</button>
    </div>
    <div class="dock-body">
      <div id="giscusHost" style="min-height:300px"></div>
      <div id="linksHost" class="links" style="display:none"></div>
    </div>
  </aside>

  <main class="wrap grid">
    <!-- HOME VIEW -->
    <section id="homeView" class="grid">
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)</div>
      </div>
      <div class="grid" style="grid-template-columns: 280px 1fr;gap:16px;align-items:start">
        <div class="card">
          <img id="coverImg" alt="cover" style="width:100%;border-radius:10px;border:1px solid var(--bd);background:#0a0c0f"
               src="assets/cover.jpg"
               onerror="this.onerror=null; this.src='assets/Cover.jpg';">
        </div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:10px">M·ª•c l·ª•c</div>
          <div id="homeTOC" class="toc-list"></div>
        </div>
      </div>
    </section>

    <!-- READER VIEW -->
    <section id="readerView" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div id="chapTitle" style="font-weight:700">...</div>
          <div class="row">
            <a class="btn" href="#home">V·ªÅ trang ch·ªß</a>
            <a class="btn" href="#toc">T·ªõi m·ª•c l·ª•c</a>
            <button class="btn" id="openOverall">üí¨ B√¨nh lu·∫≠n t·ªïng</button>
          </div>
        </div>
      </div>

      <div id="viewer" class="viewer"></div>

      <div class="card" id="bottomNav">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button class="btn" id="prevBtnBottom">‚üµ Tr∆∞·ªõc</button>
            <button class="btn" id="nextBtnBottom">Sau ‚ü∂</button>
          </div>
          <a class="btn" href="#home">V·ªÅ trang ch·ªß</a>
        </div>
      </div>

      <div class="card" id="toc" style="margin-top:8px">
        <div style="font-weight:600;margin-bottom:10px">M·ª•c l·ª•c</div>
        <div id="readerTOC" class="toc-list"></div>
      </div>

      <div class="card" id="overallCard">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row">
            <button class="btn" id="openOverall2">üí¨ M·ªü b√¨nh lu·∫≠n t·ªïng</button>
            <span class="hint">Tip: k√©o-th·∫£ ·∫£nh/GIF v√†o b√¨nh lu·∫≠n (Discussions h·ªó tr·ª£).</span>
          </div>
          <div class="like" id="heartBtn">
            <span id="heartIcon">‚ô°</span>
            <span id="heartText">Th·∫£ tim</span>
            <span class="hint" id="heartCount" style="margin-left:6px"></span>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">Made for reading on GitHub Pages. Comments via giscus.</div>
  </main>

<script>
// ====== CONFIG ======
const SERIES_TITLE = "C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)";
const MAX_CHAPTERS_GUESS = 999;
const MAX_PAGES_GUESS = 2000;
const EXTS = ["jpg","jpeg","png","gif","webp"];
// giscus config ‚Äî using repo WITH trailing dot (the one you installed app for)
const GISCUS = {
  enabled: true,
  repo: "mtamtt/Oang-oang-w-cun-cao.",
  repoId: "R_kgDOPcLS9A",
  category: "General",
  categoryId: "DIC_kwDOPcLS9M4CuDfL",
  mapping: "specific",
  theme: "dark",
  lang: "vi",
  reactions: "1",
  emit: "0",
  inputPos: "top"
};

// ====== HELPERS ======
const $ = (q, el=document) => el.querySelector(q);
const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
function setHash(h){ location.hash = h }
function getHash(){ return decodeURIComponent(location.hash.replace(/^#/,'')) }
function enc(s){ return encodeURIComponent(s) } // keep %20 for spaces
function fileName(ch, i, ext){ return `C${ch} (${i}).${ext}` }
function fileUrl(chPath, ch, i, ext){ return `${chPath}/${enc(fileName(ch,i,ext))}` }

function imgOk(url){
  return new Promise((resolve)=>{ const img=new Image(); img.onload=()=>resolve(true); img.onerror=()=>resolve(false); img.src=url; });
}
async function findExistingUrl(chPath, ch, i){
  for(const ext of EXTS){
    const url = fileUrl(chPath, ch, i, ext);
    if(await imgOk(url)) return url;
  }
  return null;
}
async function chapExists(n){ return await findExistingUrl(`chapters/chap-${n}`, n, 1) !== null }

async function buildChaptersAuto(){
  const chapters=[];
  for(let i=1;i<=MAX_CHAPTERS_GUESS;i++){
    if(!(await chapExists(i))) break;
    chapters.push({ id:`chap-${i}`, index:i, title:`Chap ${i}`, path:`chapters/chap-${i}` });
  }
  return chapters;
}

// ====== STATE ======
let CHAPTERS=[];
let currentChapter=null;
let currentTerm=null;
let io=null;

// ====== COMMENTS (single widget, reused) ======
function ensureGiscus(term){
  if(!GISCUS.enabled) return;
  const host = $("#giscusHost");
  if(host.dataset.ready==="1"){
    setGiscusTerm(term);
    return;
  }
  // inject script once
  const s = document.createElement('script');
  s.src = 'https://giscus.app/client.js';
  s.async = true;
  s.crossOrigin = 'anonymous';
  s.setAttribute('data-repo', GISCUS.repo);
  s.setAttribute('data-repo-id', GISCUS.repoId);
  s.setAttribute('data-category', GISCUS.category);
  s.setAttribute('data-category-id', GISCUS.categoryId);
  s.setAttribute('data-mapping', GISCUS.mapping);
  s.setAttribute('data-term', term);
  s.setAttribute('data-reactions-enabled', GISCUS.reactions);
  s.setAttribute('data-emit-metadata', GISCUS.emit);
  s.setAttribute('data-input-position', GISCUS.inputPos);
  s.setAttribute('data-theme', GISCUS.theme);
  s.setAttribute('data-lang', GISCUS.lang);
  host.innerHTML = "";
  host.appendChild(s);
  host.dataset.ready="1";
  currentTerm = term;
}

function setGiscusTerm(term){
  if(currentTerm===term) return;
  currentTerm = term;
  const frame = document.querySelector('iframe.giscus-frame');
  if(!frame) return; // not yet loaded
  frame.contentWindow.postMessage({ giscus: { setConfig: { term, mapping: GISCUS.mapping } } }, 'https://giscus.app');
  $("#dockContext").innerHTML = 'Trang: <b>'+term.replace(/.*img-/,'#')+'</b>';
}

// ====== DOCK ======
function openDock(){ const d=$("#commentDock"); d.classList.add('open'); d.setAttribute('aria-hidden','false'); }
function closeDock(){ const d=$("#commentDock"); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }
function toggleDock(){ const d=$("#commentDock"); d.classList.contains('open') ? closeDock() : openDock(); }
$("#toggleDock").addEventListener('click', ()=> toggleDock());
$("#closeDock").addEventListener('click', ()=> closeDock());
document.addEventListener('keydown', (e)=>{ if(e.key==='b'||e.key==='B') toggleDock(); if(e.key==='Escape') closeDock(); });

// Tabs
function showTab(which){
  $("#tab-current").classList.toggle("active", which==='current');
  $("#tab-overall").classList.toggle("active", which==='overall');
  $("#tab-links").classList.toggle("active", which==='links');
  $("#linksHost").style.display = which==='links' ? 'flex' : 'none';
  $("#giscusHost").style.display = which==='links' ? 'none' : 'block';
  if(which==='overall' && currentChapter){
    ensureGiscus(`${currentChapter.id}-overall`);
    setGiscusTerm(`${currentChapter.id}-overall`);
    $("#dockContext").innerHTML = 'Trang: <b>t·ªïng</b>';
  } else if(which==='current' && currentTerm){
    ensureGiscus(currentTerm);
    setGiscusTerm(currentTerm);
  }
}
$("#tab-current").onclick = ()=> showTab('current');
$("#tab-overall").onclick = ()=> showTab('overall');
$("#tab-links").onclick = ()=> showTab('links');

// ====== HEART (local) ======
function heartKey(chId){ return 'heart:'+chId }
function renderHeart(chId){
  const btn = $("#heartBtn");
  const count = $("#heartCount");
  const icon = $("#heartIcon");
  const text = $("#heartText");
  const liked = localStorage.getItem(heartKey(chId))==='1';
  icon.textContent = liked ? '‚ù§' : '‚ô°';
  text.textContent = liked ? 'ƒê√£ th·∫£ tim' : 'Th·∫£ tim';
  count.textContent = liked ? '(thi·∫øt b·ªã n√†y)' : '';
  btn.classList.toggle('liked', liked);
  btn.onclick = ()=>{
    const cur = localStorage.getItem(heartKey(chId))==='1';
    localStorage.setItem(heartKey(chId), cur ? '0' : '1');
    renderHeart(chId);
  };
}

// ====== RENDER CHAPTER ======
async function renderChapter(ch){
  // show reader ui
  $('#homeView').style.display='none';
  $('#readerView').style.display='block';
  $('#readerControls').style.display='inline-flex';
  $('#fitControls').style.display='inline-flex';
  $('#navControls').style.display='inline-flex';

  currentChapter = ch;
  $('#chapterSel').value = ch.id;
  $('#chapTitle').textContent = `${SERIES_TITLE} ‚Äî ${ch.title}`;
  const viewer = $('#viewer'); viewer.innerHTML='';

  // load pages
  let missing=0, count=0;
  const imgEls = [];
  for(let i=1;i<=MAX_PAGES_GUESS;i++){
    const url = await findExistingUrl(ch.path, ch.index, i);
    if(!url){
      missing++;
      if(missing>=3 || i===1) break;
      continue;
    }
    missing=0; count++;
    const img = document.createElement('img');
    img.src = url; img.className='page'; img.loading='lazy'; img.alt = `${ch.title} ‚Äî trang ${i}`;
    img.dataset.term = `${ch.id}-img-${i}`;
    img.addEventListener('click', ()=>{ ensureGiscus(img.dataset.term); openDock(); setGiscusTerm(img.dataset.term); showTab('current'); });
    viewer.appendChild(img);
    imgEls.push(img);
  }

  if(count===0){
    const hint=document.createElement('div'); hint.className='hint';
    hint.textContent='Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o cho ch∆∞∆°ng n√†y.';
    viewer.appendChild(hint);
  }

  // bottom & top nav
  const prevId = neighborChapter(ch.id,-1);
  const nextId = neighborChapter(ch.id, 1);
  $('#prevBtn').onclick = ()=> prevId && (location.hash=prevId);
  $('#nextBtn').onclick = ()=> nextId && (location.hash=nextId);
  $('#prevBtnBottom').onclick = ()=> prevId && (location.hash=prevId);
  $('#nextBtnBottom').onclick = ()=> nextId && (location.hash=nextId);

  // overall comment buttons
  $('#openOverall').onclick = ()=>{ ensureGiscus(`${ch.id}-overall`); openDock(); showTab('overall'); };
  $('#openOverall2').onclick = ()=>{ ensureGiscus(`${ch.id}-overall`); openDock(); showTab('overall'); };

  // heart
  renderHeart(ch.id);

  // build link chips for each page
  const links = $("#linksHost"); links.innerHTML='';
  imgEls.forEach((img, idx)=>{
    const chip = document.createElement('button');
    chip.className='chip'; chip.textContent='P'+(idx+1);
    chip.onclick = ()=>{ ensureGiscus(img.dataset.term); setGiscusTerm(img.dataset.term); showTab('current'); };
    links.appendChild(chip);
  });

  // observer to auto-switch per-image term when dock is open
  if(io) io.disconnect();
  io = new IntersectionObserver((entries)=>{
    const visible = entries.filter(e=>e.isIntersecting).sort((a,b)=>b.intersectionRatio - a.intersectionRatio)[0];
    if(!visible) return;
    const term = visible.target.dataset.term;
    currentTerm = term;
    if($("#commentDock").classList.contains('open') && $("#tab-current").classList.contains('active')) setGiscusTerm(term);
    $("#dockContext").innerHTML = 'Trang: <b>'+term.replace(/.*img-/,'#')+'</b>';
  }, { root:null, rootMargin:'-40% 0px -50% 0px', threshold:[0.25,0.5,0.75,1] });
  imgEls.forEach(el=> io.observe(el));
}

// ====== ROUTER & INIT ======
let CHSEL;
function populateChapterSelect(){
  const sel = $('#chapterSel'); sel.innerHTML='';
  CHAPTERS.forEach(ch=>{
    const opt=document.createElement('option'); opt.value=ch.id; opt.textContent=ch.title; sel.appendChild(opt);
  });
  sel.addEventListener('change', ()=> location.hash = sel.value);
  CHSEL=sel;
}

function neighborChapter(id, dir){
  const idx = CHAPTERS.findIndex(c=>c.id===id);
  const next = CHAPTERS[idx+dir];
  return next ? next.id : null;
}

function route(){
  const h = getHash() || 'home';
  if(h==='home'){
    $('#homeView').style.display='grid';
    $('#readerView').style.display='none';
    $('#readerControls').style.display='none';
    $('#fitControls').style.display='none';
    $('#navControls').style.display='none';
    closeDock();
  } else {
    const ch = CHAPTERS.find(c=>c.id===h) || CHAPTERS[0];
    renderChapter(ch);
    if(CHSEL) CHSEL.value = ch.id;
  }
}

(async function init(){
  CHAPTERS = await buildChaptersAuto();
  // TOCs
  function buildTOC(containerId){
    const container = document.querySelector(containerId); container.innerHTML='';
    CHAPTERS.forEach(ch=>{
      const a=document.createElement('a'); a.href=`#${ch.id}`; a.textContent=ch.title; a.className='btn';
      a.addEventListener('click', (e)=>{ e.preventDefault(); location.hash = ch.id; });
      container.appendChild(a);
    });
  }
  buildTOC('#homeTOC'); buildTOC('#readerTOC');
  populateChapterSelect();
  document.querySelector('#fitSel').addEventListener('change', ()=>{
    document.querySelectorAll('.page').forEach(img=>{
      const mode = document.querySelector('#fitSel').value;
      if(mode==='fit'){ img.style.width='100%'; img.style.maxWidth='100%' }
      else{ img.style.width='auto'; img.style.maxWidth='none' }
    });
  });
  window.addEventListener('hashchange', route);
  route();
})();
</script>
</body>
</html>
