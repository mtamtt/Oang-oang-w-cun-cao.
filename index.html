<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oăng Oăng w cún cáo — Truyện</title>
  <style>
    :root{
      --bg:#0b0d10; --fg:#e6e8eb; --muted:#98a1b3; --card:#0f1216; --bd:#1a1f29;
      --accent:#f59e0b; --pink:#ec4899; --green:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(11,13,16,.98),rgba(11,13,16,.92));
      border-bottom:1px solid var(--bd);backdrop-filter:saturate(180%) blur(10px)}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .brand{display:flex;align-items:center;font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);background:var(--card);border-radius:999px}
    select,button,input,textarea{color:var(--fg);background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bd);background:var(--card);display:inline-flex;align-items:center;gap:6px}
    .btn:hover{border-color:#2a3242}
    .grow{flex:1}
    .grid{display:grid;gap:12px}
    .viewer{display:flex;flex-direction:column;gap:0}
    .page{width:100%;display:block;background:#0a0c0f}
    .card{padding:14px;border:1px solid var(--bd);background:var(--card);border-radius:14px}
    .nav3{display:grid;grid-template-columns:auto 1fr auto;align-items:center;column-gap:16px}
    .meta{color:var(--muted);font-size:13px}
    .hidden{display:none}
    /* Comments */
    .comment{border:1px solid var(--bd);border-radius:12px;padding:10px;margin-bottom:10px}
    .comment .head{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .comment .name{font-weight:700}
    .comment .time{color:var(--muted);font-size:12px}
    .comment .actions{display:flex;gap:10px;align-items:center;margin-top:6px}
    .reply-box{margin-left:14px;margin-top:6px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end}
    .replies{margin-left:14px;margin-top:6px;display:grid;gap:8px}
    .like-btn{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);padding:6px 10px;border-radius:999px}
    .like-btn.active{border-color:#f87171}
    /* Mini notif panel */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:70}
    .backdrop.open{opacity:1;pointer-events:auto}
    .mini{position:fixed;z-index:71;right:16px;bottom:70px;border:1px solid var(--bd);background:var(--card);
      border-radius:20px;box-shadow:0 16px 32px rgba(0,0,0,.5);
      width:360px;height:420px;max-width:95vw;max-height:85vh;
      display:flex;flex-direction:column;transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:transform .22s ease,opacity .22s ease;overflow:hidden;}
    .mini.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
    .mini-body{flex:1;overflow:auto;padding:8px;-webkit-overflow-scrolling:touch}
    #notifBell{position:fixed;right:18px;bottom:18px;border:1px solid var(--bd);background:var(--card);border-radius:999px;padding:10px 12px;box-shadow:0 2px 8px rgba(0,0,0,.4);z-index:72}
    /* Admin menu */
    .more-menu{position:absolute;right:0;top:36px;z-index:5;display:grid;gap:6px;min-width:160px}
    .icon-btn{padding:8px;width:42px;min-width:42px}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">Oăng Oăng w cún cáo</div>
      <a href="#home" class="btn" id="homeBtn">🏠 Trang chủ</a>
      <div class="pill"><label for="chapterSelTop">Mục lục</label> <select id="chapterSelTop"></select></div>
      <div class="pill"><label for="fitSel">Hiển thị</label>
        <select id="fitSel"><option value="fit">Vừa khung</option><option value="full">Kích thước gốc</option></select>
      </div>
      <div class="grow"></div>
      <div id="authArea" class="pill"><span id="authBadge" style="margin-right:8px;padding:2px 6px;border-radius:8px;background:#1f2937;color:#9ca3af;font-size:12px">auth:…</span>
        <span id="authText">Đang kiểm tra đăng nhập…</span>
        <button id="loginBtn" class="btn hidden">Đăng nhập GitHub</button>
        <button id="logoutBtn" class="btn hidden">Đăng xuất</button>
      </div>
    </div>
  </header>

  <div id="backdrop" class="backdrop"></div>
  <aside id="notifPanel" class="mini" aria-hidden="true">
    <div class="mini-body">
      <div class="comment" style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Thông báo</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="markAllRead" class="btn">Đánh dấu đã đọc</button>
            <button id="notifClose" class="btn icon-btn" aria-label="Đóng">✕</button>
          </div>
        </div>
      </div>
      <div id="notifList"></div>
      <div id="notifEmpty" class="meta hidden">Chưa có thông báo</div>
    </div>
  </aside>
  <button id="notifBell">🔔</button>

  <main class="wrap grid">
    <section id="homeView" class="grid">
      <div class="card"><div style="font-weight:700;margin-bottom:6px" id="seriesTitle">Truyện</div></div>
      <div class="grid" style="grid-template-columns: 280px 1fr;gap:16px;align-items:start">
        <div class="card"><img id="coverImg" alt="cover" style="width:100%;border-radius:10px;border:1px solid var(--bd);background:#0a0c0f" src="assets/cover.jpg"></div>
        <div class="card"><div style="font-weight:600;margin-bottom:10px">Mục lục</div><div id="homeTOC" class="toc-list"></div></div>
      </div>
    </section>

    <section id="readerView" style="display:none">
      <div class="card"><div id="chapTitle" style="font-weight:700">...</div></div>
      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevTop">⟵ Chap trước</button></div>
          <div class="center"><label for="chapterSelMid" style="display:block;text-align:center;margin-bottom:6px">Mục lục</label><select id="chapterSelMid"></select></div>
          <div class="right"><button class="btn" id="nextTop">Chap sau ⟶</button></div>
        </div>
      </div>
      <div id="viewer" class="viewer"></div>
      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevBottom">⟵ Chap trước</button></div>
          <div class="center"><label for="chapterSelBottom" style="display:block;text-align:center;margin-bottom:6px">Mục lục</label><select id="chapterSelBottom"></select></div>
          <div class="right"><button class="btn" id="nextBottom">Chap sau ⟶</button></div>
        </div>
      </div>
      <div class="card" id="chapBox">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="font-weight:700">Bình luận chap</div>
            <div class="meta">Khách đọc được, đăng nhập để cmt & tim</div>
          </div>
          <button id="chap-like" class="like-btn" disabled><span>❤️</span><span id="chap-like-count">0</span></button>
        </div>
        <div class="card" style="margin-top:6px">
          <div class="reply-box" style="margin:0">
            <textarea id="chap-input" placeholder="Viết gì đó…" disabled></textarea>
            <button id="chap-send" class="btn icon-btn" disabled aria-label="Gửi">➤</button>
          </div>
          <div id="chap-list" style="margin-top:10px"></div>
          <div id="chap-empty" class="meta hidden">Chưa có bình luận. Đăng nhập để mở chủ đề đầu tiên</div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ==== CONFIG ====
    const SUPABASE_URL = "https://kmhypppsljaxvqnnfxfa.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttaHlwcHBzbGpheHZxbm5meGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzUyODgsImV4cCI6MjA3MDUxMTI4OH0.XtcNReQ7J8B9KThtKsaAJ2XXbWwnZat3LVF2y4LMZh4";
    const SERIES_TITLE = "Cạnh tranh thân thiện (Friendly Rivalry)";
    const ADMIN_USERNAMES = ["mtamtt", "mtamm"];

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.sb = sb;

    // ==== STATE ====
    const EXTS = ["jpg","jpeg","png","gif","webp","JPG","JPEG","PNG","GIF","WEBP"];
    let CHAPTERS = [];
    let currentChapter = null;
    let user = null;
    let isAdmin = false;
    let chapThread = null;

    // ==== HELPERS ====
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => el.querySelectorAll(q);
    const show = (el,on)=> el && el.classList.toggle("hidden", !on);
    const enable = (el,on)=> el && (el.disabled = !on);
    const fmtTime = s => { try{ return new Date(s).toLocaleString("vi-VN"); }catch{ return s; } };
    const escapeHtml = s => (s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // ==== AUTH ====
    async function ensureAuth(){
      const { data:{ session } } = await sb.auth.getSession();
      user = session?.user || null;
      isAdmin = !!(user?.user_metadata?.user_name && ADMIN_USERNAMES.includes(user.user_metadata.user_name));
      onAuthUI();
      if(user){ await upsertProfile(); subscribeNotifications(); refreshNotif(); }
    }
    function onAuthUI(){
      const badge = $("#authBadge"), authText=$("#authText");
      if(user){
        badge.textContent = "auth: logged-in";
        authText.textContent = user?.user_metadata?.user_name ? `Hi @${user.user_metadata.user_name}` : "Đã đăng nhập";
        enable($("#chap-input"), true); enable($("#chap-send"), true); enable($("#chap-like"), true);
        $("#loginBtn").classList.add("hidden"); $("#logoutBtn").classList.remove("hidden");
      }else{
        badge.textContent = "auth: guest";
        authText.textContent = "Khách đang xem";
        enable($("#chap-input"), false); enable($("#chap-send"), false); enable($("#chap-like"), false);
        $("#loginBtn").classList.remove("hidden"); $("#logoutBtn").classList.add("hidden");
      }
    }
    $("#loginBtn").addEventListener("click", async ()=>{
      await sb.auth.signInWithOAuth({ provider:"github", options:{ redirectTo: location.origin + location.pathname + location.search } });
    });
    $("#logoutBtn").addEventListener("click", async ()=>{ await sb.auth.signOut(); location.reload(); });
    sb.auth.onAuthStateChange(async (_e, session)=>{ user = session?.user || null; isAdmin = !!(user?.user_metadata?.user_name && ADMIN_USERNAMES.includes(user.user_metadata.user_name)); onAuthUI(); if(currentChapter){ await renderThread(); } if(user){ subscribeNotifications(); refreshNotif(); } });

    async function upsertProfile(){
      const u = (await sb.auth.getUser()).data.user;
      const name = u?.user_metadata?.user_name || u?.user_metadata?.name || "User";
      const avatar = u?.user_metadata?.avatar_url || `https://avatars.githubusercontent.com/u/0?v=4`;
      await sb.from("profiles").upsert({ id:u.id, display_name:name, username:u?.user_metadata?.user_name || null, avatar_url:avatar }, { onConflict:"id" });
    }

    // ==== CHAPTERS ====
    $("#seriesTitle").textContent = SERIES_TITLE;
    const getHash = () => decodeURIComponent(location.hash.replace(/^#/,""));
    function fileName(ch, i, ext){ return `C${ch} (${i}).${ext}`; }
    function imgOk(url){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res(true); img.onerror=()=>res(false); img.src=url; }); }
    const CHAP_EXT_CACHE = new Map();
    async function pickExtForChapter(chPath, ch){
      if(CHAP_EXT_CACHE.has(ch)) return CHAP_EXT_CACHE.get(ch);
      for(const ext of EXTS){ const url = `${chPath}/${encodeURIComponent(fileName(ch,1,ext))}`; if(await imgOk(url)){ CHAP_EXT_CACHE.set(ch,ext); return ext; } }
      CHAP_EXT_CACHE.set(ch, null); return null;
    }
    async function findExistingUrl(chPath, ch, i){
      const known = CHAP_EXT_CACHE.get(ch);
      if(known){ const u=`${chPath}/${encodeURIComponent(fileName(ch,i,known))}`; if(await imgOk(u)) return u; }
      for(const ext of EXTS){ const u=`${chPath}/${encodeURIComponent(fileName(ch,i,ext))}`; if(await imgOk(u)){ CHAP_EXT_CACHE.set(ch,ext); return u; } }
      return null;
    }
    async function chapExists(n){ return await findExistingUrl(`chapters/chap-${n}`, n, 1) !== null; }
    async function buildChaptersAuto(){ const cs=[]; for(let i=1;i<=999;i++){ if(!(await chapExists(i))) break; cs.push({ id:`chap-${i}`, index:i, title:`Chap ${i}`, path:`chapters/chap-${i}` }); } return cs; }

    function populateSelect(id){ const sel=document.getElementById(id); sel.innerHTML=''; CHAPTERS.forEach(ch=>{ const o=document.createElement('option'); o.value=ch.id; o.textContent=ch.title; sel.appendChild(o); }); sel.addEventListener('change', ()=> location.hash = sel.value); }
    function neighborChapter(id, dir){ const idx=CHAPTERS.findIndex(c=>c.id===id); const nx=CHAPTERS[idx+dir]; return nx?nx.id:null; }
    function route(){ const h=getHash()||'home'; if(h==='home'){ document.getElementById('homeView').style.display='grid'; document.getElementById('readerView').style.display='none'; } else { const ch=CHAPTERS.find(c=>c.id===h) || CHAPTERS[0]; renderChapter(ch); } }

    async function renderChapter(ch){
      document.getElementById('homeView').style.display='none'; document.getElementById('readerView').style.display='block'; currentChapter=ch;
      document.getElementById('chapTitle').textContent = `${SERIES_TITLE} — ${ch.title}`;
      ['Top','Mid','Bottom'].forEach(pos=>{ const sel=document.getElementById("chapterSel"+pos); if(sel) sel.value=ch.id; });
      const viewer=document.getElementById('viewer'); viewer.innerHTML='';
      await pickExtForChapter(ch.path, ch.index);
      let missing=0;
      for(let i=1;i<=2000;i++){ 
        const url = await findExistingUrl(ch.path, ch.index, i);
        if(!url){ missing++; if(missing>=3 || i===1) break; continue; }
        missing=0;
        const img=document.createElement('img'); img.src=url; img.className='page'; img.loading='lazy'; img.alt=`${ch.title} — trang ${i}`;
        viewer.appendChild(img);
      }
      const prevId=neighborChapter(ch.id,-1), nextId=neighborChapter(ch.id,1);
      document.getElementById('prevTop').onclick = ()=> prevId && (location.hash=prevId);
      document.getElementById('nextTop').onclick = ()=> nextId && (location.hash=nextId);
      document.getElementById('prevBottom').onclick = ()=> prevId && (location.hash=prevId);
      document.getElementById('nextBottom').onclick = ()=> nextId && (location.hash=nextId);

      chapThread = await getOrCreateThread('chap', `chap:${ch.index}`, { createIfMissing:false });
      await renderThread();
    }

    // ==== THREAD & COMMENTS ====
    async function getOrCreateThread(type, key, {createIfMissing=false}={}){
      let { data:t } = await sb.from('threads').select('id,type,key').eq('key', key).maybeSingle();
      if(t) return t;
      if(!createIfMissing || !user) return null;
      const { data:ins } = await sb.from('threads').insert({ type, key }).select('id,type,key').single();
      return ins;
    }
    async function listLikes(threadId){
      const { count } = await sb.from('likes').select('*', { count:'exact', head:true }).eq('thread_id', threadId);
      return count||0;
    }
    async function myLiked(threadId){
      if(!user) return false;
      const { data } = await sb.from('likes').select('thread_id').eq('thread_id', threadId).eq('user_id', user.id).maybeSingle();
      return !!data;
    }
    async function toggleLike(th){
      if(!user) return document.getElementById('loginBtn').click();
      let thread = th || await getOrCreateThread('chap', `chap:${currentChapter.index}`, { createIfMissing:true });
      const liked = await myLiked(thread.id);
      if(liked){ await sb.from('likes').delete().eq('thread_id', thread.id).eq('user_id', user.id); }
      else{ await sb.from('likes').upsert({ thread_id:thread.id, user_id:user.id }, { onConflict:'thread_id,user_id' }); }
      document.getElementById('chap-like-count').textContent = await listLikes(thread.id);
      document.getElementById('chap-like').classList.toggle('active', !liked);
      chapThread = thread;
    }

    async function listCommentsWithProfiles(threadId){
      const { data: rows } = await sb.from('comments')
        .select('id,thread_id,user_id,parent_id,content,is_hidden,created_at,updated_at')
        .eq('thread_id', threadId).order('created_at',{ascending:true});
      const ids = [...new Set((rows||[]).map(r=>r.user_id))];
      const { data: pf } = ids.length ? await sb.from('profiles').select('id,display_name,username,avatar_url').in('id', ids) : { data:[] };
      const map = new Map((pf||[]).map(p=>[p.id,p]));
      return (rows||[]).map(r=>({ ...r, profile: map.get(r.user_id)||null }));
    }
    function nest(rows){
      const byId=new Map(); rows.forEach(r=>byId.set(r.id,{...r,replies:[]}));
      const roots=[]; rows.forEach(r=>{ const n=byId.get(r.id); if(r.parent_id && byId.get(r.parent_id)) byId.get(r.parent_id).replies.push(n); else roots.push(n); });
      return roots;
    }
    function commentNode(c, threadId){
      const el=document.createElement('div'); el.className='comment'; el.dataset.id=c.id;
      const name = c.profile?.display_name || (c.user_id?.slice(0,6)+'…');
      const avatar = c.profile?.avatar_url || 'https://avatars.githubusercontent.com/u/0?v=4';
      const me = user?.id === c.user_id;
      const canAdmin = isAdmin;
      const bodyText = c.is_hidden ? '<i class="meta">Bình luận đã bị ẩn</i>' : escapeHtml(c.content);
      el.innerHTML = `
        <div class="head">
          <img src="${avatar}" alt="" style="width:28px;height:28px;border-radius:50%;border:1px solid var(--bd)">
          <div class="name">${name}</div>
          <div class="time">· ${fmtTime(c.created_at)}</div>
          <div style="margin-left:auto;position:relative">
            <button class="btn icon-btn more-btn">⋯</button>
            <div class="card more-menu hidden">
              ${me?'<button class="btn edit-btn">Sửa</button>':''}
              ${(me||canAdmin)?'<button class="btn del-btn">Xóa</button>':''}
              ${canAdmin?'<button class="btn hide-btn>'+(c.is_hidden?'Bỏ ẩn':'Ẩn')+'</button>':''}
              <button class="btn close-menu">Đóng</button>
            </div>
          </div>
        </div>
        <div class="body">${bodyText}</div>
        <div class="actions">
          <button class="btn reply-btn">Trả lời</button>
          <button class="btn toggle-replies hidden">Ẩn/Hiện trả lời</button>
        </div>
        <div class="reply-box hidden">
          <textarea rows="2" placeholder="Phản hồi…"></textarea>
          <button class="btn icon-btn send-reply" aria-label="Gửi">➤</button>
        </div>
        <div class="replies"></div>
      `;
      const menu = el.querySelector('.more-menu');
      el.querySelector('.more-btn').addEventListener('click', ()=> menu.classList.toggle('hidden'));
      el.querySelector('.close-menu').addEventListener('click', ()=> menu.classList.add('hidden'));
      const body = el.querySelector('.body');

      const editBtn = el.querySelector('.edit-btn');
      if(editBtn){
        editBtn.addEventListener('click', ()=>{
          menu.classList.add('hidden');
          const raw = c.content;
          body.innerHTML = `
            <div class="reply-box" style="margin:0">
              <textarea class="edit-ta">${raw.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</textarea>
              <button class="btn save-edit">Lưu</button>
            </div>`;
          body.querySelector('.save-edit').addEventListener('click', async ()=>{
            const newText = body.querySelector('.edit-ta').value.trim();
            if(!newText){ body.textContent = raw; return; }
            await sb.from('comments').update({ content:newText, updated_at:new Date().toISOString() }).eq('id', c.id);
          });
        });
      }
      const delBtn = el.querySelector('.del-btn');
      if(delBtn){
        delBtn.addEventListener('click', async ()=>{
          menu.classList.add('hidden');
          if(!confirm('Xóa bình luận này')) return;
          await sb.from('comments').delete().eq('id', c.id);
        });
      }
      const hideBtn = el.querySelector('.hide-btn');
      if(hideBtn){
        hideBtn.addEventListener('click', async ()=>{
          menu.classList.add('hidden');
          await sb.from('comments').update({ is_hidden: !c.is_hidden }).eq('id', c.id);
        });
      }

      // reply
      el.querySelector('.reply-btn').addEventListener('click', ()=>{
        el.querySelector('.reply-box').classList.toggle('hidden');
      });
      el.querySelector('.send-reply').addEventListener('click', async ()=>{
        if(!user) return document.getElementById('loginBtn').click();
        const t = el.querySelector('.reply-box textarea');
        const content = t.value.trim(); if(!content) return;
        await sb.from('comments').insert({ thread_id:threadId, content, parent_id:c.id, user_id:user.id });
        t.value=''; el.querySelector('.reply-box').classList.add('hidden');
      });

      // render replies
      const repliesEl = el.querySelector('.replies');
      if((c.replies||[]).length){
        el.querySelector('.toggle-replies').classList.remove('hidden');
        el.querySelector('.toggle-replies').addEventListener('click', ()=> repliesEl.classList.toggle('hidden'));
        c.replies.forEach(r=> repliesEl.appendChild(commentNode(r, threadId)));
      }
      return el;
    }

    async function renderThread(){
      const likeBtn = document.getElementById('chap-like'); const likeCountEl = document.getElementById('chap-like-count');
      const listEl = document.getElementById('chap-list'); const emptyEl = document.getElementById('chap-empty');
      if(!chapThread){
        likeCountEl.textContent = 0; listEl.innerHTML = ''; show(emptyEl, true);
        likeBtn.onclick = async () => { chapThread = await getOrCreateThread('chap', `chap:${currentChapter.index}`, { createIfMissing:true }); await toggleLike(chapThread); await renderThread(); };
        return;
      }
      show(emptyEl, false);

      likeCountEl.textContent = await listLikes(chapThread.id);
      likeBtn.classList.toggle('active', await myLiked(chapThread.id));
      likeBtn.onclick = ()=> toggleLike(chapThread);

      const prevScroll = listEl.scrollTop;
      listEl.innerHTML = '<div class="meta">Đang tải bình luận…</div>';
      const rows = await listCommentsWithProfiles(chapThread.id);
      listEl.innerHTML = '';
      nest(rows).forEach(c=> listEl.appendChild(commentNode(c, chapThread.id)));
      listEl.scrollTop = prevScroll;

      // composer
      document.getElementById('chap-send').onclick = async ()=>{
        if(!user) return document.getElementById('loginBtn').click();
        let th = chapThread;
        if(!th){ th = await getOrCreateThread('chap', `chap:${currentChapter.index}`, { createIfMissing:true }); chapThread = th; }
        const content = document.getElementById('chap-input').value.trim(); if(!content) return;
        await sb.from('comments').insert({ thread_id:th.id, content, parent_id:null, user_id:user.id });
        document.getElementById('chap-input').value='';
      };

      // realtime updates
      const channel = sb.channel('rt:'+chapThread.id);
      channel
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'comments', filter:`thread_id=eq.${chapThread.id}` }, async ()=>{
          const rows = await listCommentsWithProfiles(chapThread.id); listEl.innerHTML=''; nest(rows).forEach(c=> listEl.appendChild(commentNode(c, chapThread.id)));
        })
        .on('postgres_changes', { event:'UPDATE', schema:'public', table:'comments', filter:`thread_id=eq.${chapThread.id}` }, async ()=>{
          const rows = await listCommentsWithProfiles(chapThread.id); listEl.innerHTML=''; nest(rows).forEach(c=> listEl.appendChild(commentNode(c, chapThread.id)));
        })
        .on('postgres_changes', { event:'DELETE', schema:'public', table:'comments', filter:`thread_id=eq.${chapThread.id}` }, async ()=>{
          const rows = await listCommentsWithProfiles(chapThread.id); listEl.innerHTML=''; nest(rows).forEach(c=> listEl.appendChild(commentNode(c, chapThread.id)));
        })
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'likes', filter:`thread_id=eq.${chapThread.id}` }, async ()=>{
          likeCountEl.textContent = await listLikes(chapThread.id);
        })
        .on('postgres_changes', { event:'DELETE', schema:'public', table:'likes', filter:`thread_id=eq.${chapThread.id}` }, async ()=>{
          likeCountEl.textContent = await listLikes(chapThread.id);
        })
        .subscribe();
    }

    // ==== NOTIFICATIONS ====
    function notifItem(n){
      const wrap = document.createElement('div'); wrap.className='comment';
      const msg = (n.payload&&n.payload.message) || (n.type==='reply'?'Có người trả lời bạn':'Có bình luận mới');
      wrap.innerHTML = `
        <div class="head">
          <div class="name">${escapeHtml(msg)}</div>
          <div class="time">· ${fmtTime(n.created_at)} ${n.read_at? '· đã đọc':''}</div>
        </div>`;
      return wrap;
    }
    async function listNotifications(){
      if(!user) return [];
      const { data } = await sb.from('notifications').select('id,type,payload,created_at,read_at').eq('user_id', user.id).order('created_at',{ascending:false}).limit(50);
      return data||[];
    }
    async function markAllRead(){
      if(!user) return;
      await sb.from('notifications').update({ read_at:new Date().toISOString() }).is('read_at', null).eq('user_id', user.id);
    }
    async function refreshNotif(){
      const list = await listNotifications();
      const box = document.getElementById('notifList'); const emp = document.getElementById('notifEmpty');
      box.innerHTML=''; if(!list.length){ show(emp,true); return; } show(emp,false);
      list.forEach(n=> box.appendChild(notifItem(n)));
    }
    function openNotif(){ document.getElementById('backdrop').classList.add('open'); document.getElementById('notifPanel').classList.add('open'); document.getElementById('notifPanel').setAttribute('aria-hidden','false'); }
    function closeNotif(){ document.getElementById('backdrop').classList.remove('open'); document.getElementById('notifPanel').classList.remove('open'); document.getElementById('notifPanel').setAttribute('aria-hidden','true'); }
    document.getElementById('notifBell').addEventListener('click', openNotif);
    document.getElementById('notifClose').addEventListener('click', closeNotif);
    document.getElementById('backdrop').addEventListener('click', closeNotif);
    document.getElementById('markAllRead').addEventListener('click', async ()=>{ await markAllRead(); await refreshNotif(); });

    function subscribeNotifications(){
      if(!user) return;
      try{
        const ch = sb.channel('rt-notif:'+user.id);
        ch.on('postgres_changes',{event:'INSERT',schema:'public',table:'notifications',filter:`user_id=eq.${user.id}`}, refreshNotif).subscribe();
      }catch(e){ console.warn('subscribe notif failed', e); }
    }

    // ==== INIT ====
    try{
      const urlNow = new URL(window.location.href);
      if(urlNow.searchParams.get('code')){
        await sb.auth.exchangeCodeForSession(window.location.href);
        history.replaceState({}, document.title, urlNow.pathname + urlNow.search + urlNow.hash);
      }
    }catch(e){}
    (async function init(){
      await ensureAuth();
      CHAPTERS = await buildChaptersAuto();
      function buildTOC(id){ const box=document.querySelector(id); box.innerHTML=''; CHAPTERS.forEach(ch=>{ const a=document.createElement('a'); a.href=`#${ch.id}`; a.textContent=ch.title; a.className='btn'; a.addEventListener('click',e=>{ e.preventDefault(); location.hash=ch.id; }); box.appendChild(a); }); }
      buildTOC('#homeTOC');
      ['chapterSelTop','chapterSelMid','chapterSelBottom'].forEach(populateSelect);
      document.getElementById('fitSel').addEventListener('change', ()=>{
        document.querySelectorAll('.page').forEach(img=>{
          const mode=document.getElementById('fitSel').value;
          if(mode==='fit'){ img.style.width='100%'; img.style.maxWidth='100%'; }
          else{ img.style.width='auto'; img.style.maxWidth='none'; }
        });
      });
      window.addEventListener('hashchange', route);
      route();
    })();
  </script>
</body>
</html>
