<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OƒÉng oƒÉng w c√∫n c√°o ‚Äî ƒê·ªçc truy·ªán</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--bg:#0b0d10;--fg:#e6e8eb;--muted:#9aa4b2;--card:#0f1216;--bd:#1a1f29;--hi:#22d3ee;--hi2:#fbbf24}
html{color-scheme:dark;background:var(--bg)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:15.5px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
a{color:inherit;text-decoration:none}
/* force text white in inputs */
input,select,textarea,button{color:var(--fg)!important;background:var(--card);border:1px solid var(--bd);border-radius:10px}
::placeholder{color:#cbd5e1;opacity:.8}
/* layout */
.wrap{max-width:980px;margin:0 auto;padding:14px}
header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(11,13,16,.98),rgba(11,13,16,.92));border-bottom:1px solid var(--bd);backdrop-filter:saturate(180%) blur(10px)}
.bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 14px}
.brand{display:flex;align-items:center;font-weight:800;gap:6px}
.brand .ico{font-size:22px}
.pill,.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);background:var(--card);border-radius:999px;cursor:pointer}
.card{padding:14px;border:1px solid var(--bd);background:var(--card);border-radius:14px}
.grid{display:grid;gap:12px}.small{font-size:13px}.note{color:var(--muted);font-size:13px}
.viewer{display:flex;flex-direction:column}.page{width:100%;display:block;margin-left:auto;margin-right:auto;background:#0a0c0f}
.page-wrap{position:relative}
.badge{position:absolute;top:10px;right:-12px;transform:translateX(40%);background:linear-gradient(135deg,var(--hi),var(--hi2));border:1px solid rgba(148,163,184,.35);border-radius:999px;width:26px;height:26px;display:none;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(0,0,0,.45)}
.badge svg{width:14px;height:14px;color:#0b0d10}
.nav3{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}.nav3 .left{justify-self:start}.nav3 .center{justify-self:center}.nav3 .right{justify-self:end}
.footer{padding:26px 0;color:var(--muted);text-align:center}
/* panel */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:70}
.backdrop.open{opacity:1;pointer-events:auto}
.mini{position:fixed;z-index:71;right:16px;bottom:70px;border:1px solid var(--bd);background:var(--card);border-radius:20px;box-shadow:0 16px 32px rgba(0,0,0,.5);width:360px;height:360px;max-width:95vw;max-height:85vh;display:flex;flex-direction:column;transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:transform .22s ease,opacity .22s ease;overflow:hidden}
.mini.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}.mini.min{height:auto}
.mini-head{display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--bd)}
.mini-hint{color:var(--muted);font-size:12px;text-align:center}
.mini-body{flex:1;overflow:auto;padding:8px;-webkit-overflow-scrolling:touch}
.cmt-item{border-top:1px dashed #223;padding:8px 6px}.cmt-meta{color:#9fb0c0;font-size:12px;margin-bottom:4px}.cmt-actions{display:flex;gap:8px;margin-top:6px}
/* to top */
#toTopBtn{position:fixed;right:18px;bottom:18px;z-index:55;border-radius:999px;width:46px;height:46px;display:none;align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.35);background:linear-gradient(135deg,#1e293b,#0f172a);box-shadow:0 8px 18px rgba(0,0,0,.45)}
#toTopBtn svg{width:22px;height:22px;color:#e5e7eb}
@media (max-width:640px){.mini{width:320px;height:320px;right:12px;bottom:64px}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand"><span class="ico">üê∂</span><span class="ico">ü¶ä</span><span>OƒÉng oƒÉng w c√∫n c√°o</span></div>
    <a href="#home" class="btn">üè† Trang ch·ªß</a>
    <label class="pill">M·ª•c l·ª•c <select id="tocTop"></select></label>
    <label class="pill">Hi·ªÉn th·ªã
      <select id="fitSel"><option value="fit">V·ª´a khung</option><option value="full">K√≠ch th∆∞·ªõc g·ªëc</option></select>
    </label>
    <div class="grow" style="flex:1"></div>
    <button id="authBtn" class="btn">ü¶ä ƒêƒÉng nh·∫≠p GitHub</button>
    <div class="note">Ph√≠m t·∫Øt: <b>B</b> ƒë√≥ng cmt ¬∑ <b>G</b> l√™n ƒë·∫ßu</div>
  </div>
</header>

<!-- mini panel -->
<div id="backdrop" class="backdrop"></div>
<aside id="mini" class="mini" aria-hidden="true">
  <div class="mini-head">
    <div id="panelTitle" style="font-weight:700">B√¨nh lu·∫≠n</div>
    <div class="mini-hint">Vu·ªët tr√°i ‚Üí ph·∫£i ƒë·ªÉ ƒë√≥ng ¬∑ nh·∫•n <b>B</b></div>
    <button id="btnMin" class="btn small">Thu g·ªçn</button>
    <button id="btnClose" class="btn small">ƒê√≥ng</button>
  </div>
  <div id="miniBody" class="mini-body">
    <div id="panelList"></div>
    <div class="card" style="margin-top:8px" id="panelComposer">
      <div class="small" style="margin-bottom:6px">ƒêƒÉng nh·∫≠p GitHub ƒë·ªÉ b√¨nh lu·∫≠n ho·∫∑c b√¨nh lu·∫≠n ·∫©n danh</div>
      <textarea id="panelText" placeholder="N·ªôi dung b√¨nh lu·∫≠n..."></textarea>
      <button id="panelSend" class="btn">G·ª≠i</button>
      <div id="panelMsg" class="note" style="margin-top:6px"></div>
    </div>
  </div>
</aside>

<!-- to top -->
<button id="toTopBtn" title="L√™n ƒë·∫ßu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>

<main class="wrap grid">
  <!-- HOME -->
  <section id="homeView" class="grid">
    <div class="card"><div style="font-weight:700;margin-bottom:6px">C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)</div></div>
    <div class="grid" style="grid-template-columns:280px 1fr;gap:16px;align-items:start">
      <div class="card"><img src="assets/cover.jpg" onerror="this.onerror=null;this.src='assets/Cover.jpg';" style="width:100%;border-radius:10px;border:1px solid var(--bd)"></div>
      <div class="card">
        <div style="font-weight:600;margin-bottom:8px">M·ª•c l·ª•c</div>
        <div id="homeTOC" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px"></div>
      </div>
    </div>
  </section>

  <!-- READER -->
  <section id="readerView" style="display:none">
    <div class="card"><div id="chapTitle" style="font-weight:700">...</div></div>
    <div class="card"><div class="nav3">
      <div class="left"><button id="prevTop" class="btn">‚üµ Chap tr∆∞·ªõc</button></div>
      <div class="center"><label class="small">M·ª•c l·ª•c</label><select id="tocMid"></select></div>
      <div class="right"><button id="nextTop" class="btn">Chap sau ‚ü∂</button></div>
    </div></div>

    <div id="viewer" class="viewer"></div>

    <div class="card"><div class="nav3">
      <div class="left"><button id="prevBot" class="btn">‚üµ Chap tr∆∞·ªõc</button></div>
      <div class="center"><label class="small">M·ª•c l·ª•c</label><select id="tocBot"></select></div>
      <div class="right"><button id="nextBot" class="btn">Chap sau ‚ü∂</button></div>
    </div></div>

    <!-- Aggregated -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div style="font-weight:700">B√¨nh lu·∫≠n chap</div>
        <div>Sort <select id="sortSel" class="small"><option value="new">M·ªõi nh·∫•t</option><option value="old">C≈© nh·∫•t</option></select></div>
      </div>
      <div class="card" style="margin:8px 0">
        <div class="small" style="margin-bottom:6px">ƒêƒÉng nh·∫≠p GH ho·∫∑c ·∫©n danh</div>
        <textarea id="chapText" placeholder="N·ªôi dung b√¨nh lu·∫≠n cho c·∫£ chap..."></textarea>
        <button id="chapSend" class="btn">G·ª≠i</button>
        <div id="chapMsg" class="note" style="margin-top:6px"></div>
      </div>
      <div id="aggMixed"></div>
      <button id="moreMixed" class="btn small" style="margin-top:8px;display:none">Xem th√™m</button>
    </div>
  </section>

  <div class="footer">Comments: GitHub login (tu·ª≥ ch·ªçn) ‚Ä¢ ·∫®n danh ·ªïn ƒë·ªãnh ‚Ä¢ Reply/S·ª≠a/Xo√° ch·ªß cmt ‚Ä¢ Badge trang c√≥ cmt ‚Ä¢ Manifest tƒÉng t·ªëc TOC.</div>
</main>

<script>
/* ===== Config ===== */
const SUPABASE_URL="https://kmhypppsljaxvqnnfxfa.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttaHlwcHBzbGpheHZxbm5meGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzUyODgsImV4cCI6MjA3MDUxMTI4OH0.XtcNReQ7J8B9KThtKsaAJ2XXbWwnZat3LVF2y4LMZh4";
const SERIES="C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)";
const EXTS=["jpg","jpeg","png","gif","webp","JPG","JPEG","PNG","GIF","WEBP"];
const MAX_CHAPS=999, MAX_PAGES=2000;

/* ===== Helpers ===== */
const $=(q,el=document)=>el.querySelector(q);
function uuid(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16))}
const deviceToken=(()=>{let t=localStorage.getItem('dev_tok');if(!t){t=uuid();localStorage.setItem('dev_tok',t)}return t})();
function esc(s){return(s||"").replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))}
function imgOk(u){return new Promise(r=>{const i=new Image();i.onload=()=>r(true);i.onerror=()=>r(false);i.src=u})}
function fileCandidates(ch,i){return[`C${ch} (${i})`,`C${ch}-#${i}`,`C${ch}-${i}`,`C${ch}_${i}`,`C${ch} ${i}`]}
async function findImg(chPath,ch,i){for(const n of fileCandidates(ch,i)){for(const e of EXTS){const u=`${chPath}/${encodeURIComponent(n+'.'+e)}`;if(await imgOk(u))return u}}return null}
function anonName(){let n=localStorage.getItem('anon_n');if(!n){n=String(Math.floor(Math.random()*9000)+1000);localStorage.setItem('anon_n',n)}return "·∫®n danh "+n}
function now(){return Math.floor(Date.now()/1000)}
function cdKey(scope){return "cd_"+scope}function leftCD(scope,sec=10){const k=cdKey(scope);const last=parseInt(localStorage.getItem(k)||"0",10);const d=now()-last;return d<sec?sec-d:0}function setCD(scope){localStorage.setItem(cdKey(scope),String(now()))}

/* ===== Supabase (with graceful fallback) ===== */
let sb=null, demo=false, user=null;
async function initDB(){
  if(!window.supabase){demo=true;console.warn("Supabase lib not loaded -> demo");return}
  sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON,{auth:{persistSession:true}});
  try{
    const test=await sb.from('comments').select('id,chapter,page,body').limit(1);
    if(test.error){throw test.error}
  }catch(e){
    demo=true;
    console.warn("Supabase table/columns thi·∫øu => ch·∫°y demo (localStorage).",e.message||e);
    const inf=document.createElement('div');inf.className='card';inf.innerHTML=`<b>Note:</b> Ch∆∞a t·∫°o b·∫£ng <code>comments(chapter,page,name,body,edit_token,created_at)</code> trong Supabase.<br>Site ƒëang ch·∫°y <i>demo local</i> ‚Äî cmt s·∫Ω l∆∞u ·ªü tr√¨nh duy·ªát.`;
    document.querySelector('.wrap').prepend(inf);
  }
}
async function getUser(){ if(demo||!sb) return null; const {data:{user:u}}=await sb.auth.getUser(); user=u; updateAuthBtn(); return u }
async function loginGH(){ if(demo||!sb) return alert("Server ƒëang ch·∫°y demo (local)."); await sb.auth.signInWithOAuth({provider:'github'}) }
async function logoutGH(){ if(!sb) return; await sb.auth.signOut(); user=null; updateAuthBtn() }
function displayName(){ return user ? (user.user_metadata?.user_name||user.email?.split("@")[0]||"GitHub user") : anonName() }
function updateAuthBtn(){ const b=$("#authBtn"); if(user){ b.textContent="üëã "+displayName()+" (ƒêƒÉng xu·∫•t)"; b.onclick=logoutGH } else { b.textContent="ü¶ä ƒêƒÉng nh·∫≠p GitHub"; b.onclick=loginGH }}

/* ===== Data layer ===== */
function localRead(ch){return JSON.parse(localStorage.getItem('demo_cmt_'+ch)||"[]")}
function localWrite(ch,arr){localStorage.setItem('demo_cmt_'+ch,JSON.stringify(arr))}
async function cmt_fetch(ch){ if(demo) return localRead(ch).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)); const {data,error}=await sb.from('comments').select('*').eq('chapter',ch).order('created_at',{ascending:false}); if(error) throw error; return data||[] }
async function cmt_add(row){ if(demo){const a=localRead(row.chapter);a.push(row);localWrite(row.chapter,a);return row} const {data,error}=await sb.from('comments').insert(row).select().single(); if(error) throw error; return data }
async function cmt_edit(id,body,token,ch){ if(demo){const a=localRead(ch);const i=a.findIndex(x=>x.id===id);if(i>=0){a[i].body=body;localWrite(ch,a);return true}throw new Error("not found")} const {error}=await sb.from('comments').update({body}).eq('id',id).eq('edit_token',token); if(error) throw error; return true }
async function cmt_del(id,token,ch){ if(demo){localWrite(ch,localRead(ch).filter(x=>x.id!==id));return true} const {error}=await sb.from('comments').delete().eq('id',id).eq('edit_token',token); if(error) throw error; return true }

/* ===== State ===== */
let CHAPS=[], cur=null, cache=[], pageForPanel=null, mixedLimit=20, pagesWith=new Set();

/* ===== Panel ===== */
function renderList(el,list){
  el.innerHTML=list.map(it=>{
    const who=it.name?.trim()?esc(it.name):"·∫®n danh"; const when=new Date(it.created_at).toLocaleString(); const owner=localStorage.getItem('tok_'+it.id)===it.edit_token;
    return `<div class="cmt-item" data-id="${it.id}">
      <div class="cmt-meta"><b>${who}</b> ‚Äî #${it.page} ¬∑ <span>${esc(when)}</span></div>
      <div class="cmt-body" data-body>${esc(it.body)}</div>
      ${owner?`<div class="cmt-actions"><button class="btn small" data-act="e">S·ª≠a</button><button class="btn small" data-act="d">Xo√°</button></div>`:""}
    </div>`
  }).join("") || '<div class="note">Ch∆∞a c√≥ b√¨nh lu·∫≠n cho trang n√†y.</div>';
  el.querySelectorAll('[data-act="e"]').forEach(btn=>{
    btn.onclick=async()=>{const w=btn.closest('.cmt-item');const id=w.dataset.id;const body=w.querySelector('[data-body]');const old=body.textContent;const ta=document.createElement('textarea');ta.value=old;ta.style.width='100%';body.replaceWith(ta);btn.textContent='L∆∞u';btn.onclick=async()=>{try{await cmt_edit(id,ta.value.trim(),localStorage.getItem('tok_'+id),cur.index);const o=cache.find(x=>x.id===id);if(o)o.body=ta.value.trim();openPanel(pageForPanel)}catch(e){alert('L·ªói s·ª≠a: '+(e.message||e))}}}
  });
  el.querySelectorAll('[data-act="d"]').forEach(btn=>{
    btn.onclick=async()=>{if(!confirm('Xo√° b√¨nh lu·∫≠n n√†y?'))return;const id=btn.closest('.cmt-item').dataset.id;try{await cmt_del(id,localStorage.getItem('tok_'+id),cur.index);cache=cache.filter(x=>x.id!==id);openPanel(pageForPanel);renderMixed()}catch(e){alert('L·ªói xo√°: '+(e.message||e))}}
  });
}
function openPanel(page){pageForPanel=page;$("#panelTitle").textContent="B√¨nh lu·∫≠n ‚Äî #"+page;renderList($("#panelList"),cache.filter(x=>x.page===page));$("#panelText").value="";$("#panelMsg").textContent="";$("#backdrop").classList.add("open");$("#mini").classList.add("open");$("#mini").setAttribute("aria-hidden","false")}
function closePanel(){ $("#backdrop").classList.remove("open"); $("#mini").classList.remove("open"); $("#mini").setAttribute("aria-hidden","true") }
$("#btnClose").onclick=closePanel; $("#backdrop").onclick=closePanel;
document.addEventListener("keydown",e=>{ if(e.key==='b'||e.key==='B') closePanel(); if(e.key==='g'||e.key==='G') window.scrollTo({top:0,behavior:'smooth'}) });
(()=>{const el=$("#mini");let sx=0,sy=0,move=false; el.addEventListener("touchstart",e=>{const t=e.changedTouches[0];sx=t.clientX;sy=t.clientY;move=false},{passive:true}); el.addEventListener("touchmove",e=>{const t=e.changedTouches[0];const dx=t.clientX-sx;const dy=Math.abs(t.clientY-sy); if(Math.abs(dx)>20&&dy<25) move=true},{passive:true}); el.addEventListener("touchend",e=>{const t=e.changedTouches[0];const dx=t.clientX-sx;const dy=Math.abs(t.clientY-sy); if(move&&dx>70&&dy<40) closePanel()},{passive:true}); })();
$("#btnMin").onclick=()=>$("#mini").classList.toggle("min");
$("#panelSend").onclick=async()=>{
  const body=$("#panelText").value.trim(); const msg=$("#panelMsg"); if(!body){msg.textContent="Ghi g√¨ ƒë√≥ ƒë√£ nha üòÖ";return}
  const left=leftCD("page",10); if(left){msg.textContent="Ch·∫≠m l·∫°i "+left+"s nha ~";return}
  try{
    const row={id:uuid(),chapter:cur.index,page:pageForPanel,name:displayName(),body,edit_token:uuid(),created_at:new Date().toISOString()};
    const saved=await cmt_add(row); localStorage.setItem('tok_'+saved.id,row.edit_token); cache.unshift(saved); setCD("page"); openPanel(pageForPanel); renderMixed();
  }catch(e){ msg.textContent="L·ªói g·ª≠i: "+(e.message||e) }
};

/* ===== Mixed (chapter) ===== */
function renderMixed(){
  const box=$("#aggMixed"); const sort=$("#sortSel").value;
  const arr=[...cache].sort((a,b)=>sort==='new'?new Date(b.created_at)-new Date(a.created_at):new Date(a.created_at)-new Date(b.created_at));
  const show=arr.slice(0,mixedLimit);
  box.innerHTML=show.map(it=>{
    const who=it.name?.trim()?esc(it.name):"·∫®n danh"; const tag=it.page?` ‚Äî #${it.page}`:""; const when=new Date(it.created_at).toLocaleString();
    const owner=localStorage.getItem('tok_'+it.id)===it.edit_token;
    return `<div class="cmt-item" data-id="${it.id}">
      <div class="cmt-meta"><b>${who}</b>${tag} ¬∑ <span>${esc(when)}</span></div>
      <div class="cmt-body" data-body>${esc(it.body)}</div>
      ${owner?`<div class="cmt-actions"><button class="btn small" data-act="e">S·ª≠a</button><button class="btn small" data-act="d">Xo√°</button></div>`:""}
    </div>`
  }).join("") || '<div class="note">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>';
  $("#moreMixed").style.display=arr.length>mixedLimit?'inline-flex':'none';
  // bind edit/del
  box.querySelectorAll('[data-act="e"]').forEach(btn=>{
    btn.onclick=async()=>{const w=btn.closest('.cmt-item');const id=w.dataset.id;const body=w.querySelector('[data-body]');const old=body.textContent;const ta=document.createElement('textarea');ta.value=old;ta.style.width='100%';body.replaceWith(ta);btn.textContent='L∆∞u';btn.onclick=async()=>{try{await cmt_edit(id,ta.value.trim(),localStorage.getItem('tok_'+id),cur.index);const o=cache.find(x=>x.id===id);if(o)o.body=ta.value.trim();renderMixed()}catch(e){alert('L·ªói s·ª≠a: '+(e.message||e))}}}
  });
  box.querySelectorAll('[data-act="d"]').forEach(btn=>{
    btn.onclick=async()=>{if(!confirm('Xo√° b√¨nh lu·∫≠n n√†y?'))return;const id=btn.closest('.cmt-item').dataset.id;try{await cmt_del(id,localStorage.getItem('tok_'+id),cur.index);cache=cache.filter(x=>x.id!==id);renderMixed()}catch(e){alert('L·ªói xo√°: '+(e.message||e))}}
  });
}
$("#moreMixed").onclick=()=>{mixedLimit+=20;renderMixed()}
$("#sortSel").onchange=()=>renderMixed();
$("#chapSend").onclick=async()=>{
  const body=$("#chapText").value.trim(); const msg=$("#chapMsg"); if(!body){msg.textContent="Vi·∫øt g√¨ ƒë√≥ ƒë√£ nha.";return}
  const left=leftCD("chap",10); if(left){msg.textContent="Ch·∫≠m l·∫°i "+left+"s nha ~";return}
  try{
    const row={id:uuid(),chapter:cur.index,page:null,name:displayName(),body,edit_token:uuid(),created_at:new Date().toISOString()};
    const saved=await cmt_add(row); localStorage.setItem('tok_'+saved.id,row.edit_token); cache.unshift(saved); $("#chapText").value=""; msg.textContent="ƒê√£ g·ª≠i!"; setCD("chap"); renderMixed();
  }catch(e){ msg.textContent="L·ªói g·ª≠i: "+(e.message||e) }
};

/* ===== TOC speedup: optional manifest =====
   Option 1: chapters/index.json => { "chapters":[ { "id":"chap-1","pages":179 }, ... ] }
   Option 2: chapters/manifest.txt => lines: chap-1, chap-2, ...
*/
async function loadManifest(){
  try{ const r=await fetch('chapters/index.json',{cache:'no-store'}); if(r.ok){ const j=await r.json(); if(Array.isArray(j.chapters)){ return j.chapters.map((x,i)=>({id:x.id||`chap-${i+1}`,index:i+1,title:`Chap ${i+1}`,path:`chapters/${x.id||`chap-${i+1}`}`})) } } }catch{}
  try{ const r=await fetch('chapters/manifest.txt',{cache:'no-store'}); if(r.ok){ const t=(await r.text()).split(/\r?\n/).map(s=>s.trim()).filter(Boolean); return t.map((id,i)=>({id,index:i+1,title:`Chap ${i+1}`,path:`chapters/${id}`})) } }catch{}
  return null
}

async function chapExists(n){return (await findImg(`chapters/chap-${n}`,n,1))!==null}
async function scanChaps(){const out=[];for(let i=1;i<=MAX_CHAPS;i++){if(!(await chapExists(i)))break;out.push({id:`chap-${i}`,index:i,title:`Chap ${i}`,path:`chapters/chap-${i}`})}return out}

function fillSelect(id){const sel=$(id); sel.innerHTML=""; CHAPS.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.title;sel.appendChild(o)}); sel.onchange=()=>location.hash=sel.value}
function neighbour(id,dir){const i=CHAPS.findIndex(c=>c.id===id);const nxt=CHAPS[i+dir];return nxt?nxt.id:null}

async function renderChap(ch){
  $("#homeView").style.display="none"; $("#readerView").style.display="block"; cur=ch;
  $("#chapTitle").textContent=`${SERIES} ‚Äî ${ch.title}`; ["#tocTop","#tocMid","#tocBot"].forEach(s=>{$(s).value=ch.id});
  const viewer=$("#viewer"); viewer.innerHTML="";
  let miss=0;
  for(let i=1;i<=MAX_PAGES;i++){
    const url=await findImg(ch.path,ch.index,i);
    if(!url){miss++; if(miss>=3||i===1)break; else continue}
    miss=0;
    const wrap=document.createElement('div'); wrap.className="page-wrap";
    const img=document.createElement('img'); img.src=url; img.className="page"; img.loading="lazy"; img.alt=`${ch.title} ‚Äî trang ${i}`;
    img.onclick=()=>openPanel(i);
    const badge=document.createElement('div'); badge.className="badge"; badge.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>';
    wrap.appendChild(img); wrap.appendChild(badge); viewer.appendChild(wrap);
  }
  const prev=neighbour(ch.id,-1), next=neighbour(ch.id,1);
  $("#prevTop").onclick=$("#prevBot").onclick=()=>prev&&(location.hash=prev);
  $("#nextTop").onclick=$("#nextBot").onclick=()=>next&&(location.hash=next);
  await renderAgg(); window.scrollTo({top:0,behavior:'smooth'}); updateTopBtn()
}

async function renderAgg(){ cache=await cmt_fetch(cur.index); pagesWith=new Set(cache.filter(x=>x.page!=null).map(x=>x.page)); document.querySelectorAll('.page-wrap').forEach((w,idx)=>{const p=idx+1;const b=w.querySelector('.badge');b.style.display=pagesWith.has(p)?'flex':'none'}); renderMixed() }

function updateTopBtn(){ $("#toTopBtn").style.display=(window.scrollY>600 && $("#readerView").style.display!=='none')?'flex':'none' }
window.addEventListener('scroll',updateTopBtn); $("#toTopBtn").onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
function route(){const h=decodeURIComponent(location.hash.replace(/^#/,""))||"home"; if(h==="home"){$("#homeView").style.display="grid";$("#readerView").style.display="none"} else {const ch=CHAPS.find(c=>c.id===h)||CHAPS[0]; renderChap(ch)}}

/* ===== Boot ===== */
(async()=>{
  await initDB(); await getUser(); updateAuthBtn();
  CHAPS=await loadManifest() || await scanChaps();
  const h=$("#homeTOC"); h.innerHTML=""; CHAPS.forEach(c=>{const a=document.createElement('a'); a.href="#"+c.id; a.textContent=c.title; a.className="btn"; a.onclick=(e)=>{e.preventDefault(); location.hash=c.id}; h.appendChild(a) });
  ["#tocTop","#tocMid","#tocBot"].forEach(fillSelect);
  $("#fitSel").onchange=()=>{document.querySelectorAll('.page').forEach(img=>{const m=$("#fitSel").value; if(m==='fit'){img.style.width='100%'; img.style.maxWidth='100%';} else {img.style.width='auto'; img.style.maxWidth='none'; img.style.marginLeft='auto'; img.style.marginRight='auto';}})};
  window.addEventListener('hashchange',route); route(); updateTopBtn();
})();
</script>
</body>
</html>
