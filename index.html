<!doctype html>
<html lang="vi" class="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OƒÉng oƒÉng w c√∫n c√°o ‚Äî Reader</title>
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--bg:#0b0d10;--fg:#e6e8eb;--muted:#9aa3b2;--card:#0f1216;--bd:#1a1f29;--blue:#60a5fa;--yellow:#fde047;--pink:#ec4899}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
a{color:inherit;text-decoration:none}
.wrap{max-width:980px;margin:0 auto;padding:16px}
header{position:sticky;top:0;z-index:40;background:rgba(11,13,16,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--bd)}
.bar{display:flex;align-items:center;gap:12px;padding:10px 16px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:4px;font-weight:800}
.brand svg{height:42px;width:auto}
.pill, .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--bd);background:var(--card);border-radius:999px;padding:8px 12px;cursor:pointer}
select,textarea,input{background:var(--card);color:var(--fg);border:1px solid var(--bd);border-radius:10px;padding:8px}
.card{border:1px solid var(--bd);background:var(--card);border-radius:14px;padding:14px}
.viewer{display:flex;flex-direction:column}
.page{display:block;margin:0 auto;background:#0a0c0f;max-width:100%}
.page-wrap{position:relative}
.badge{position:absolute;top:50%;right:-12px;transform:translate(50%,-50%);width:28px;height:28px;border-radius:999px;
background:linear-gradient(135deg,var(--blue),var(--yellow));display:none;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(0,0,0,.5)}
.badge svg{width:16px;height:16px;color:#0b1220}
.nav3{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
.nav3 .left{justify-self:start} .nav3 .center{justify-self:center} .nav3 .right{justify-self:end}
.meta{color:var(--muted);font-size:13px}
#toTop{position:fixed;right:16px;bottom:18px;z-index:55;border-radius:999px;width:46px;height:46px;display:none;align-items:center;justify-content:center;border:1px solid #334; background:#0f172a}
#toTop svg{width:22px;height:22px;color:#e5e7eb}
/* Panel */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:.2s;z-index:70}
.backdrop.open{opacity:1;pointer-events:auto}
.panel{position:fixed;right:16px;bottom:70px;z-index:71;width:380px;height:380px;max-width:95vw;max-height:85vh;border:1px solid var(--bd);background:var(--card);border-radius:16px;box-shadow:0 16px 32px rgba(0,0,0,.5);display:flex;flex-direction:column;opacity:0;pointer-events:none;transform:translateY(10px);transition:.2s}
.panel.open{opacity:1;pointer-events:auto;transform:none}
.panel-head{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--bd)}
.panel-body{flex:1;overflow:auto;padding:8px}
.cmt{border-top:1px dashed #223;padding:8px 6px} .cmt .meta{font-size:12px;color:#9fb0c0;margin-bottom:4px} .reply{margin-left:20px;border-left:2px solid #223;padding-left:8px}
.rx{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);border-radius:999px;padding:4px 8px;margin-right:6px}
.rx.active{background:linear-gradient(135deg,rgba(59,130,246,.2),rgba(250,204,21,.1));border-color:#2a3242}
@media(max-width:640px){.panel{width:340px;height:340px}}
.heart{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--bd)}
.heart.active{background:linear-gradient(135deg,rgba(236,72,153,.12),rgba(236,72,153,.04));border-color:#4b2638}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <!-- Dog & Fox flat (kh√¥ng bo tr√≤n) -->
      <svg viewBox="0 0 64 64"><circle cx="32" cy="34" r="16" fill="#FFE3C3" stroke="#0f172a" stroke-width="1.4"/><path d="M20 26q6-12 12-7v7z" fill="#c1936f"/><path d="M44 26q-6-12-12-7v7z" fill="#c1936f"/><circle cx="27" cy="32" r="2.2"/><circle cx="37" cy="32" r="2.2"/></svg>
      <svg viewBox="0 0 64 64"><circle cx="32" cy="34" r="16" fill="#FFC068" stroke="#0f172a" stroke-width="1.4"/><path d="M24 24L28 16l2 10z" fill="#FF7A3D"/><path d="M40 24L36 16l-2 10z" fill="#FF7A3D"/><circle cx="27" cy="31.5" r="2.1"/><circle cx="37" cy="31.5" r="2.1"/></svg>
      <b>OƒÉng oƒÉng w c√∫n c√°o</b>
    </div>
    <a class="btn" href="#home">üè† Trang ch·ªß</a>
    <div class="pill">M·ª•c l·ª•c <select id="selTop"></select></div>
    <div class="pill">Hi·ªÉn th·ªã <select id="fitSel"><option value="fit">V·ª´a khung</option><option value="full">K√≠ch th∆∞·ªõc g·ªëc</option></select></div>
    <div class="pill" id="ghBtn">üêô <span id="ghLabel">ƒêƒÉng nh·∫≠p GitHub</span></div>
    <div class="meta">Ph√≠m t·∫Øt: <b>B</b> ƒë√≥ng cmt ¬∑ <b>G</b> l√™n ƒë·∫ßu</div>
  </div>
</header>

<div id="backdrop" class="backdrop"></div>
<div id="panel" class="panel" aria-hidden="true">
  <div class="panel-head"><b id="panelTitle">B√¨nh lu·∫≠n</b><div class="meta" style="margin-left:8px">Vu·ªët tr√°i‚Üíph·∫£i ƒë·ªÉ ƒë√≥ng ¬∑ nh·∫•n B</div><div style="flex:1"></div><button class="btn" id="panelClose">ƒê√≥ng</button></div>
  <div class="panel-body">
    <div id="rxBar"></div>
    <div id="panelList"></div>
    <div class="card" style="margin-top:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="font-weight:600">Vi·∫øt b√¨nh lu·∫≠n cho trang n√†y</div>
        <div id="panelUser" class="meta"></div>
      </div>
      <textarea id="panelText" placeholder="N·ªôi dung b√¨nh lu·∫≠n..."></textarea>
      <button class="btn" id="panelSend">G·ª≠i</button>
      <div id="panelMsg" class="meta" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<button id="toTop" title="L√™n ƒë·∫ßu chap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>

<main class="wrap">
  <section id="homeView" class="card">
    <div style="font-weight:700;margin-bottom:8px">C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)</div>
    <div id="homeTOC"></div>
  </section>

  <section id="readerView" style="display:none">
    <div class="card"><div id="chapTitle" style="font-weight:700">...</div></div>
    <div class="card"><div class="nav3">
      <div class="left"><button class="btn" id="prevTop">‚üµ Chap tr∆∞·ªõc</button></div>
      <div class="center">M·ª•c l·ª•c <select id="selMid"></select></div>
      <div class="right"><button class="btn" id="nextTop">Chap sau ‚ü∂</button></div>
    </div></div>

    <div id="viewer" class="viewer"></div>

    <div class="card"><div class="nav3">
      <div class="left"><button class="btn" id="prevBot">‚üµ Chap tr∆∞·ªõc</button></div>
      <div class="center">M·ª•c l·ª•c <select id="selBot"></select></div>
      <div class="right"><button class="btn" id="nextBot">Chap sau ‚ü∂</button></div>
    </div></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div style="font-weight:700">B√¨nh lu·∫≠n chap</div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="sortSel" class="btn"><option value="new">M·ªõi nh·∫•t</option><option value="old">C≈© nh·∫•t</option></select>
          <button id="heartBtn" class="heart"><span id="heartTxt">Th·∫£ tim</span></button>
          <span id="heartCnt" class="meta"></span>
        </div>
      </div>
      <div class="card" style="margin-top:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-weight:600">Vi·∫øt b√¨nh lu·∫≠n cho chap</div>
          <div id="chapUser" class="meta"></div>
        </div>
        <textarea id="chapText" placeholder="N·ªôi dung b√¨nh lu·∫≠n cho c·∫£ chap..."></textarea>
        <button class="btn" id="chapSend">G·ª≠i</button>
        <div id="chapMsg" class="meta" style="margin-top:6px"></div>
      </div>
      <div style="font-weight:600;margin:8px 0 4px">D√≤ng b√¨nh lu·∫≠n (xen k·∫Ω)</div>
      <div id="agg"></div>
      <button id="more" class="btn" style="margin-top:6px;display:none">Xem th√™m</button>
    </div>
  </section>
</main>

<script>
const SUPABASE_URL="https://kmhypppsljaxvqnnfxfa.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttaHlwcHBzbGpheHZxbm5meGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzUyODgsImV4cCI6MjA3MDUxMTI4OH0.XtcNReQ7J8B9KThtKsaAJ2XXbWwnZat3LVF2y4LMZh4";
const EXTS=["jpg","jpeg","png","webp","gif"];
const MAX_CHAPTERS=999, MAX_PAGES=2000;
const RX=[{k:'like',l:'üëç'},{k:'love',l:'‚ù§Ô∏è'},{k:'laugh',l:'üòÇ'},{k:'wow',l:'üòÆ'},{k:'sad',l:'üò¢'}];

let sb=null, user=null, demo=false;
function uid(){return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16))}
const device=(()=>{let t=localStorage.getItem('dev_token'); if(!t){t=uid(); localStorage.setItem('dev_token',t);} return t;})();
function aliasN(){let h=0; for(const ch of device) h=(h*31+ch.charCodeAt(0))>>>0; return (h%999)+1;}
function alias(){return user? (user.user_metadata?.user_name||user.email):("·∫®n danh "+aliasN())}

function initDB(){
  if(window.supabase){ sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{persistSession:true}}); demo=false;
    sb.auth.getUser().then(({data})=>{user=data?.user||null; updAuth();});
    sb.auth.onAuthStateChange((_e,s)=>{user=s?.user||null; updAuth();});
  }else demo=true;
}
async function login(){ if(demo){alert('Demo mode.'); return;} await sb.auth.signInWithOAuth({provider:'github', options:{redirectTo:location.href}}); }
async function logout(){ if(demo) return; await sb.auth.signOut(); }
function updAuth(){
  const b=document.getElementById('ghBtn'), l=document.getElementById('ghLabel');
  const cu=document.getElementById('chapUser'), pu=document.getElementById('panelUser');
  if(user){ l.textContent='ƒêƒÉng xu·∫•t'; b.onclick=logout; cu.textContent=pu.textContent='ƒêƒÉng nh·∫≠p: '+alias(); }
  else{ l.textContent='ƒêƒÉng nh·∫≠p GitHub'; b.onclick=login; cu.textContent=pu.textContent='Kh√¥ng ƒëƒÉng nh·∫≠p ‚Üí '+alias(); }
}

// -------- DB helpers + demo fallback
async function rpc(name,args){ if(demo){throw new Error('demo');} const {data,error}=await sb.rpc(name,args||{}); if(error) throw error; return data; }
async function addC({chapter,page,parent,body}){
  const name=user? alias():null; const uid=user? user.id:null; const editToken=uid?null:uid(); // set token for anonymous
  if(demo){ const store=JSON.parse(localStorage.getItem('cmts')||'[]'); const row={id:uid(),chapter,page,parent_id:parent,name,body,edit_token:editToken,user_id:uid,created_at:new Date().toISOString()}; store.push(row); localStorage.setItem('cmts',JSON.stringify(store)); localStorage.setItem('cmt_token_'+row.id, editToken); return row; }
  const row=await rpc('comment_add_v2',{p_chapter:chapter,p_page:page,p_parent:parent,p_name:name,p_user:uid,p_body:body,p_edit_token:editToken});
  localStorage.setItem('cmt_token_'+row.id, row.edit_token||editToken); return row;
}
async function editC(id,body){ const tok=localStorage.getItem('cmt_token_'+id); if(demo){ const s=JSON.parse(localStorage.getItem('cmts')||'[]'); const i=s.findIndex(x=>x.id===id); if(i>=0){s[i].body=body; localStorage.setItem('cmts',JSON.stringify(s));} return; } await rpc('comment_edit_v2',{p_id:id,p_edit_token:tok,p_body:body}); }
async function delC(id){ const tok=localStorage.getItem('cmt_token_'+id); if(demo){ let s=JSON.parse(localStorage.getItem('cmts')||'[]'); s=s.filter(x=>x.id!==id); localStorage.setItem('cmts',JSON.stringify(s)); return; } await rpc('comment_delete_v2',{p_id:id,p_edit_token:tok}); }
async function fetchC(ch, newFirst){ if(demo){ const s=JSON.parse(localStorage.getItem('cmts')||'[]'); const arr=s.filter(x=>x.chapter===ch); arr.sort((a,b)=> new Date(newFirst?b.created_at:a.created_at)-new Date(newFirst?a.created_at:b.created_at)); return arr;} const {data,error}=await sb.from('comments_v2').select('*').eq('chapter',ch).order('created_at',{ascending:!newFirst}); if(error) throw error; return data; }
async function heartGet(ch){ if(demo){ const k='heart:'+ch; const set=new Set(JSON.parse(localStorage.getItem(k)||'[]')); return {active:set.has(device),count:set.size}; } return await rpc('get_heart',{p_chapter:ch,p_device:device}); }
async function heartToggle(ch){ if(demo){ const k='heart:'+ch; const set=new Set(JSON.parse(localStorage.getItem(k)||'[]')); if(set.has(device)) set.delete(device); else set.add(device); localStorage.setItem(k,JSON.stringify([...set])); return {active:set.has(device),count:set.size}; } return await rpc('toggle_heart',{p_chapter:ch,p_device:device}); }
async function rxPageGet(ch,pg){ if(demo){ const out={}; for(const r of RX){const k=`rxp:${ch}:${pg}:${r.k}`; const set=new Set(JSON.parse(localStorage.getItem(k)||'[]')); out[r.k]={active:set.has(device),count:set.size};} return out;} return await rpc('get_page_reactions',{p_chapter:ch,p_page:pg,p_device:device,p_user:user?.id||null}); }
async function rxPageToggle(ch,pg,kind){ if(demo){ const k=`rxp:${ch}:${pg}:${kind}`; const set=new Set(JSON.parse(localStorage.getItem(k)||'[]')); if(set.has(device)) set.delete(device); else set.add(device); localStorage.setItem(k,JSON.stringify([...set])); return {active:set.has(device),count:set.size};} return await rpc('toggle_page_reaction',{p_chapter:ch,p_page:pg,p_kind:kind,p_device:device,p_user:user?.id||null}); }
async function rxCGet(id){ if(demo){ const out={}; for(const r of RX){const k=`rxc:${id}:${r.k}`; const set=new Set(JSON.parse(localStorage.getItem(k)||'[]')); out[r.k]={active:set.has(device),count:set.size};} return out;} return await rpc('get_comment_reactions',{p_target:id,p_device:device,p_user:user?.id||null}); }
async function rxCToggle(id,kind){ if(demo){ const k=`rxc:${id}:${kind}`; const set=new Set(JSON.parse(localStorage.getItem(k)||'[]')); if(set.has(device)) set.delete(device); else set.add(device); localStorage.setItem(k,JSON.stringify([...set])); return {active:set.has(device),count:set.size};} return await rpc('toggle_comment_reaction',{p_target:id,p_kind:kind,p_device:device,p_user:user?.id||null}); }

// -------- UI
const $=q=>document.querySelector(q);
let CH=[], cur=null, cmts=[], pagesWithC=new Set(), orderNew=true, limit=12, curPageForPanel=null;

function fileName(ch,i,ext){return `C${ch} (${i}).${ext}`}
function urlFor(path,ch,i,ext){return `${path}/${encodeURIComponent(fileName(ch,i,ext))}`}
function testImg(u){return new Promise(r=>{const im=new Image(); im.onload=()=>r(true); im.onerror=()=>r(false); im.src=u;})}
async function findUrl(p,ch,i){for(const e of EXTS){const u=urlFor(p,ch,i,e); if(await testImg(u)) return u;} return null;}
async function chapExists(n){return (await findUrl(`chapters/chap-${n}`,n,1))!==null}
async function buildCh(){const out=[]; for(let i=1;i<=MAX_CHAPTERS;i++){ if(!(await chapExists(i))) break; out.push({id:`chap-${i}`,index:i,title:`Chap ${i}`,path:`chapters/chap-${i}`});} return out;}

function fillSel(id){const s=$(id); s.innerHTML=''; CH.forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.textContent=c.title; s.appendChild(o);}); s.onchange=()=>location.hash=s.value;}
function neigh(id,dir){const k=CH.findIndex(c=>c.id===id); const nx=CH[k+dir]; return nx?nx.id:null;}

function rxRender(container, st, onT){ container.innerHTML = RX.map(r=>{const x=st?.[r.k]||{}; return `<span class="rx ${x.active?'active':''}" data-k="${r.k}">${r.l} <span class='meta'>${x.count||0}</span></span>`;}).join(''); container.querySelectorAll('.rx').forEach(el=>{el.onclick=async()=>{const k=el.dataset.k; const res=await onT(k); await openPanel(curPageForPanel);};}); }

function cmtHTML(it,isReply=false){ const who=it.user_id?(it.name||'(user)'):(it.name||`·∫®n danh ${aliasN()}`); const when=new Date(it.created_at).toLocaleString(); return `<div class="cmt ${isReply?'reply':''}" data-id="${it.id}" data-page="${it.page||''}"><div class="meta"><b>${who}</b>${it.page?` ‚Äî #${it.page}`:''} ¬∑ ${when}</div><div class="body">${(it.body||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}</div><div class="meta" data-rx></div><div class="meta"><button class="btn" data-act="reply">Tr·∫£ l·ªùi</button> <button class="btn" data-act="edit">S·ª≠a</button> <button class="btn" data-act="del">Xo√°</button></div></div>`; }

function bindCmtActions(scope){ scope.querySelectorAll('[data-id]').forEach(async el=>{const id=el.dataset.id; const bar=el.querySelector('[data-rx]'); const st=await rxCGet(id); rxRender(bar,st,(k)=>rxCToggle(id,k)); el.querySelector('[data-act="reply"]').onclick=()=>{if(el.querySelector('textarea')) return; const ta=document.createElement('textarea'); const send=document.createElement('button'); send.className='btn'; send.textContent='G·ª≠i'; el.appendChild(ta); el.appendChild(send); send.onclick=async()=>{ const body=ta.value.trim(); if(!body) return; const pg=Number(el.dataset.page||null); await addC({chapter:cur.index,page:pg,parent:id,body}); await loadAgg(); };}; el.querySelector('[data-act="edit"]').onclick=async()=>{const body=prompt('S·ª≠a n·ªôi dung:', el.querySelector('.body').textContent); if(body==null) return; await editC(id,body); await loadAgg();}; el.querySelector('[data-act="del"]').onclick=async()=>{if(!confirm('Xo√° b√¨nh lu·∫≠n?')) return; await delC(id); await loadAgg();}; }); }

async function openPanel(pg){ curPageForPanel=pg; $('#panelTitle').textContent='B√¨nh lu·∫≠n ‚Äî #'+pg; const list=$('#panelList'); list.innerHTML='ƒêang t·∫£i‚Ä¶'; const st=await rxPageGet(cur.index,pg); rxRender($('#rxBar'), st, (k)=>rxPageToggle(cur.index,pg,k)); const arr=cmts.filter(c=>c.page===pg && !c.parent_id); arr.forEach(c=>c.replies=cmts.filter(x=>x.parent_id===c.id)); list.innerHTML = arr.map(c=> cmtHTML(c)+ (c.replies||[]).map(r=>cmtHTML(r,true)).join('')).join('') || '<div class="meta">Ch∆∞a c√≥ b√¨nh lu·∫≠n cho trang n√†y.</div>'; bindCmtActions(list); $('#panelText').value=''; $('#panelMsg').textContent=''; $('#backdrop').classList.add('open'); $('#panel').classList.add('open'); $('#panel').setAttribute('aria-hidden','false'); }
function closePanel(){ $('#backdrop').classList.remove('open'); $('#panel').classList.remove('open'); $('#panel').setAttribute('aria-hidden','true'); }
$('#panelClose').onclick=closePanel; $('#backdrop').onclick=closePanel; document.addEventListener('keydown',e=>{ if(e.key==='b'||e.key==='B') closePanel(); if(e.key==='g'||e.key==='G') window.scrollTo({top:0,behavior:'smooth'}); });

$('#panelSend').onclick=async()=>{ const body=$('#panelText').value.trim(); if(!body) return; await addC({chapter:cur.index,page:curPageForPanel,parent:null,body}); $('#panelMsg').textContent='ƒê√£ g·ª≠i!'; await loadAgg(); await openPanel(curPageForPanel); };

async function loadAgg(){ cmts = await fetchC(cur.index, orderNew); pagesWithC=new Set(cmts.filter(c=>c.page!=null).map(c=>c.page)); document.querySelectorAll('.page-wrap').forEach((w,i)=>{ w.querySelector('.badge').style.display = pagesWithC.has(i+1)?'flex':'none'; }); const root=cmts.filter(c=>!c.parent_id); const show=root.slice(0,limit); $('#agg').innerHTML = show.map(c=> cmtHTML(c,false)).join('') || '<div class="meta">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>'; bindCmtActions($('#agg')); $('#more').style.display = root.length>limit?'inline-flex':'none'; }

$('#more').onclick=()=>{ limit+=12; loadAgg(); }
$('#sortSel').onchange=e=>{ orderNew=(e.target.value==='new'); loadAgg(); }

async function renderChap(ch){ $('#homeView').style.display='none'; $('#readerView').style.display='block'; cur=ch; $('#chapTitle').textContent='C·∫°nh tranh th√¢n thi·ªán ‚Äî '+ch.title; ['#selTop','#selMid','#selBot'].forEach(id=>{document.querySelector(id).value=ch.id}); const v=$('#viewer'); v.innerHTML=''; let miss=0; for(let i=1;i<=MAX_PAGES;i++){ const u=await findUrl(ch.path,ch.index,i); if(!u){ miss++; if(miss>=3||i===1) break; else continue; } miss=0; const w=document.createElement('div'); w.className='page-wrap'; const img=document.createElement('img'); img.className='page'; img.src=u; img.alt=`${ch.title} ‚Äî trang ${i}`; img.onclick=()=>openPanel(i); const b=document.createElement('div'); b.className='badge'; b.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>'; w.appendChild(img); w.appendChild(b); v.appendChild(w);}}
  const prev=neigh(ch.id,-1), next=neigh(ch.id,1); document.getElementById('prevTop').onclick=()=>prev&&(location.hash=prev); document.getElementById('nextTop').onclick=()=>next&&(location.hash=next); document.getElementById('prevBot').onclick=()=>prev&&(location.hash=prev); document.getElementById('nextBot').onclick=()=>next&&(location.hash=next);
  await updateHeart(); await loadAgg(); window.scrollTo({top:0,behavior:'smooth'}); updToTop();
}

async function updateHeart(){ const s=await heartGet(cur.index); document.getElementById('heartBtn').classList.toggle('active',!!s.active); document.getElementById('heartTxt').textContent=s.active?'ƒê√£ th·∫£ tim':'Th·∫£ tim'; document.getElementById('heartCnt').textContent='('+ (s.count||0)+')'; document.getElementById('heartBtn').onclick=async()=>{ const r=await heartToggle(cur.index); document.getElementById('heartBtn').classList.toggle('active',!!r.active); document.getElementById('heartTxt').textContent=r.active?'ƒê√£ th·∫£ tim':'Th·∫£ tim'; document.getElementById('heartCnt').textContent='('+ (r.count||0)+')'; }; }

function updToTop(){ document.getElementById('toTop').style.display = (window.scrollY>600 && document.getElementById('readerView').style.display!=='none')?'flex':'none'; }
window.addEventListener('scroll',updToTop);
document.getElementById('fitSel').onchange=()=>{ const mode=document.getElementById('fitSel').value; document.querySelectorAll('.page').forEach(im=>{ if(mode==='fit'){ im.style.width='100%'; im.style.maxWidth='100%'; } else{ im.style.width='auto'; im.style.maxWidth='none'; im.style.margin='0 auto'; }}); }

function route(){ const h=decodeURIComponent(location.hash.slice(1)||'home'); if(h==='home'){ document.getElementById('homeView').style.display='block'; document.getElementById('readerView').style.display='none'; } else { const ch=CH.find(c=>c.id===h)||CH[0]; renderChap(ch);} }
window.addEventListener('hashchange',route);

(async function init(){ initDB(); CH=await buildCh(); const home=document.getElementById('homeTOC'); home.innerHTML=''; CH.forEach(c=>{ const a=document.createElement('a'); a.href='#'+c.id; a.textContent=c.title; a.className='btn'; home.appendChild(a); }); ['#selTop','#selMid','#selBot'].forEach(fillSel); document.querySelector('#ghBtn').onclick=login; route(); updToTop(); })();
</script>
</body>
</html>
