<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OƒÉng oƒÉng w c√∫n c√°o ‚Äî ƒê·ªçc truy·ªán (Supabase Comments v4)</title>
  <style>
    :root{--bg:#0b0d10;--fg:#e6e8eb;--muted:#98a1b3;--card:#0f1216;--bd:#1a1f29;--accent:#f59e0b;--pink:#ec4899;--green:#22c55e;--basic:#94a3b8}
    *{box-sizing:border-box} html,body{margin:0;padding:0;height:100%}
    body{background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(11,13,16,.98), rgba(11,13,16,.92));border-bottom:1px solid var(--bd);backdrop-filter:saturate(180%) blur(10px)}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .brand span{font-weight:800;margin-left:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);background:var(--card);border-radius:999px}
    select,button,input,textarea{color:var(--fg);background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    .grow{flex:1}
    .grid{display:grid;gap:12px}
    .viewer{display:flex;flex-direction:column;gap:0}
    .page{width:100%;display:block;border-radius:0;border:none;background:#0a0c0f;margin-left:auto;margin-right:auto}
    .card{padding:14px;border:1px solid var(--bd);background:var(--card);border-radius:14px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bd);background:var(--card);cursor:pointer}
    .btn:hover{border-color:#2a3242}
    .nav3{display:grid;grid-template-columns:auto 1fr auto;align-items:center;column-gap:16px}
    .nav3 .left .btn{margin-right:8px}
    .nav3 .right .btn{margin-left:8px}
    .meta{color:var(--muted);font-size:13px}
    #toTopBtn{ position:fixed;right:18px;bottom:18px;z-index:55;border-radius:999px;width:46px;height:46px;display:none;
      align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.35);
      background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);box-shadow:0 8px 18px rgba(0,0,0,.45);}
    #toTopBtn svg{width:22px;height:22px;display:block;color:#e5e7eb}
    .hidden{display:none}

    /* Mini panel */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:70}
    .backdrop.open{opacity:1;pointer-events:auto}
    .mini{
      position:fixed;z-index:71;right:16px;bottom:70px;border:1px solid var(--bd);background:var(--card);
      border-radius:20px;box-shadow:0 16px 32px rgba(0,0,0,.5);
      width:360px;height:420px;max-width:95vw;max-height:85vh;
      display:flex;flex-direction:column;transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:transform .22s ease,opacity .22s ease;
      overflow:hidden;
    }
    .mini.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
    .mini-body{flex:1;overflow:auto;padding:8px;-webkit-overflow-scrolling:touch}
    .composer{display:flex;gap:8px;margin:8px 0}
    .composer textarea{flex:1;resize:vertical;min-height:56px}
    .comment{border:1px solid var(--bd);border-radius:12px;padding:10px;margin-bottom:10px}
    .comment .head{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .comment .name{font-weight:700}
    .comment .time{color:var(--muted);font-size:12px}
    .comment .actions{display:flex;gap:10px;align-items:center;margin-top:6px}
    .comment .reply{color:var(--basic);cursor:pointer}
    .reply-box{margin-left:14px;margin-top:6px}
    .replies{margin-left:14px;margin-top:6px;display:grid;gap:8px}
    .like-btn{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);padding:6px 10px;border-radius:999px}
    .like-btn.active{border-color:#f87171}
    .reaction{cursor:pointer}
    #sb-chap .thread-head, #sb-page .thread-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    #sb-chap .thread-head .title, #sb-page .thread-head .title{font-weight:700}
    .empty{color:var(--muted);font-size:14px;padding:8px 4px}
  
/* Notifications panel */
#notifPanel {position:fixed;z-index:72;right:16px;bottom:70px;border:1px solid var(--bd);background:var(--card);
  border-radius:20px;box-shadow:0 16px 32px rgba(0,0,0,.5);width:360px;height:420px;max-width:95vw;max-height:85vh;
  display:flex;flex-direction:column;transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:transform .22s ease,opacity .22s ease;overflow:hidden;}
#notifPanel.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto;}
#notifList{flex:1;overflow:auto;padding:10px;display:grid;gap:8px}
.notif-item{display:grid;grid-template-columns:auto 1fr;gap:8px;border:1px solid var(--bd);border-radius:12px;padding:10px;cursor:pointer}
.notif-item:hover{border-color:#2a3242}
.notif-item .meta{font-size:12px;color:var(--muted)}
.highlight{animation: hi 1.6s ease 1}
@keyframes hi{0%{box-shadow:0 0 0 0 rgba(245,158,11,.0)}30%{box-shadow:0 0 0 6px rgba(245,158,11,.25)}100%{box-shadow:0 0 0 0 rgba(245,158,11,.0)}}
.reaction{cursor:pointer;border:1px solid var(--bd);padding:4px 8px;border-radius:999px;display:inline-flex;gap:6px;align-items:center}
.reaction.active{border-color:#f59e0b}

/* Notifications unread highlight + preview text */
.notif-item.unread{border-color:#f59e0b;background:rgba(245,158,11,.06)}
.notif-preview{color:var(--muted);font-size:13px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Reaction buttons */
.react-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.react-btn{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);padding:6px 10px;border-radius:999px;background:var(--card);
  user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}
.react-btn:hover{border-color:#2a3242}
.react-btn.active{border-color:#f59e0b}
.react-btn .icon{width:18px;height:18px;display:inline-block}
.react-btn .count{font-size:13px;color:var(--fg)}



/* Speech bubble marker (replaces red dot) */
.page-wrap{position:relative;margin:0 auto 0 auto;max-width:100%}
.page-wrap + .page-wrap{margin-top:0}
.page-wrap .cmt-bubble{position:absolute;right:10px;top:10px;display:none;width:18px;height:14px;background:#ff4571;border-radius:10px;padding:0 0 2px 0;box-shadow:0 2px 6px rgba(0,0,0,.35)}
.page-wrap .cmt-bubble::after{content:'';position:absolute;right:4px;bottom:-4px;border-width:4px 4px 0 0;border-style:solid;border-color:#ff4571 transparent transparent transparent}
.page-wrap.has-cmt .cmt-bubble{display:block}

/* Join pages: remove gaps */
#viewer img.page{display:block;width:100%;height:auto;margin:0;border-radius:0}

/* Composer plane button inside input */
.composer{position:relative;display:flex;gap:8px;margin:8px 0}
.composer textarea{flex:1;min-height:56px;resize:vertical;padding-right:56px}
.composer .icon-btn{position:absolute;right:12px;bottom:12px;width:36px;height:36px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center}


/* --- Patch v5.3: UI tweaks (scoped classes only) --- */
:root{ --accent:#ff4470; --bd2:#2a2a2a }
.actions.react-row{display:flex;gap:6px;align-items:center;margin-top:6px}
.react-btn{padding:2px 6px;border-radius:10px;border:1px solid var(--bd2);background:var(--card);display:inline-flex;align-items:center;gap:4px}
.react-btn .emoji{font-size:16px;line-height:1;font-family:'Apple Color Emoji','Segoe UI Emoji','Noto Color Emoji',sans-serif}
.react-btn .count{font-size:12px;opacity:.9}
.replies.collapsed{display:none !important}
.toggle-replies{display:block;width:calc(100% - 34px);margin:6px 0 0 34px;padding:8px 12px;border-radius:10px;border:1px solid var(--bd2);
 background:var(--card);text-align:left;font-size:13px;color:var(--muted);cursor:pointer}
.toggle-replies .arrow{float:right;opacity:.7}
/* TOC / nav layout fix on desktop */
.nav3{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px}
.nav3 .center{justify-self:center;display:flex;align-items:center;gap:8px}
/* Scroll to top button */
#toTop{position:fixed;right:16px;bottom:16px;width:40px;height:40px;border-radius:999px;display:none;align-items:center;justify-content:center;
background:var(--card);border:1px solid var(--bd);box-shadow:0 4px 12px rgba(0,0,0,.25);z-index:60}
#toTop.show{display:flex}
/* Notification panel overlay click-to-close */
#notifOverlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:49}
#notifOverlay.show{display:block}
/* Speech bubble marker for page comments */
.page-wrap .cmt-bubble{position:absolute;right:10px;top:10px;display:none;width:18px;height:14px;background:var(--accent);border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.35)}
.page-wrap .cmt-bubble::after{content:'';position:absolute;right:4px;bottom:-4px;border-width:4px 4px 0 0;border-style:solid;border-color:var(--accent) transparent transparent transparent}
.page-wrap.has-cmt .cmt-bubble{display:block}

</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand"><span>OƒÉng oƒÉng w c√∫n c√°o</span></div>
      <a href="#home" id="homeBtn" class="btn">üè† Trang ch·ªß</a>
      <div class="pill"><label for="chapterSelTop">M·ª•c l·ª•c</label> <select id="chapterSelTop"></select></div>
      <div class="pill"><label for="fitSel">Hi·ªÉn th·ªã</label>
        <select id="fitSel"><option value="fit">V·ª´a khung</option><option value="full">K√≠ch th∆∞·ªõc g·ªëc</option></select>
      </div>
      <div class="grow"></div>
      <div id="authArea" class="pill"><button id="notifBtn" class="btn" style="position:relative;margin-right:6px">üîî<span id="notifBadge" style="position:absolute;top:-6px;right:-6px;font-size:12px;background:#ef4444;color:#fff;border-radius:999px;padding:1px 6px;min-width:18px;text-align:center;display:none">0</span></button>
        <span id="authText">ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p‚Ä¶</span>
        <button id="loginBtn" class="btn hidden">ƒêƒÉng nh·∫≠p GitHub</button>
        <button id="logoutBtn" class="btn hidden">ƒêƒÉng xu·∫•t</button>
      </div>
      <div class="meta">Ph√≠m t·∫Øt: B m·ªü cmt ¬∑ G l√™n ƒë·∫ßu</div>
    </div>
  </header>

  <div id="backdrop" class="backdrop"></div>
  <aside id="miniPanel" class="mini" aria-hidden="true">
    <div class="mini-body">
      <div id="sb-page">
        <div class="thread-head">
          <div class="title">B√¨nh lu·∫≠n ·∫£nh</div>
          <button id="page-like" class="like-btn" disabled><span>‚ù§Ô∏è</span><span id="page-like-count">0</span></button>
        </div>
        <div id="page-auth-hint" class="meta">Kh√°ch xem ƒë∆∞·ª£c. ƒêƒÉng nh·∫≠p ƒë·ªÉ cmt & tim.</div>
        <div class="composer">
          <textarea id="page-input" placeholder="Vi·∫øt g√¨ ƒë√≥‚Ä¶" disabled></textarea>
          <button id="page-send" class="btn icon-btn" aria-label="G·ª≠i" disabled><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18"><path d="M3.4 11.2l16.7-7.3c.9-.4 1.8.5 1.4 1.4l-7.3 16.7c-.4 1-1.8 1-2.2 0l-2.5-5.4-5.4-2.5c-1-.4-1-1.8 0-2.2zM9.7 14.3l3.9 3.9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
        </div>
        <div id="page-list"></div>
        <div id="page-empty" class="empty hidden">Ch∆∞a c√≥ b√¨nh lu·∫≠n. ƒêƒÉng nh·∫≠p ƒë·ªÉ m·ªü ch·ªß ƒë·ªÅ ƒë·∫ßu ti√™n.</div>
      </div>
    </div>
  </aside>

  <aside id="notifPanel" aria-hidden="true"><div class="bar" style="padding:10px"><div style="font-weight:700">Th√¥ng b√°o</div></div><div id="notifList"></div><div class="empty meta" id="notifEmpty" style="padding:10px;display:none">Ch∆∞a c√≥ th√¥ng b√°o</div></aside>

  <button id="toTopBtn" aria-label="L√™n ƒë·∫ßu chap" title="L√™n ƒë·∫ßu chap">‚¨Ü</button>

  <main class="wrap grid">
    <section id="homeView" class="grid">
      <div class="card"><div style="font-weight:700;margin-bottom:6px">C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)</div></div>
      <div class="grid" style="grid-template-columns: 280px 1fr;gap:16px;align-items:start">
        <div class="card"><img id="coverImg" alt="cover" style="width:100%;border-radius:10px;border:1px solid var(--bd);background:#0a0c0f" src="assets/cover.jpg"></div>
        <div class="card"><div style="font-weight:600;margin-bottom:10px">M·ª•c l·ª•c</div><div id="homeTOC" class="toc-list"></div></div>
      </div>
    </section>

    <section id="readerView" style="display:none">
      <div class="card"><div id="chapTitle" style="font-weight:700">...</div></div>
      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevTop">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center"><label for="chapterSelMid" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label><select id="chapterSelMid"></select></div>
          <div class="right"><button class="btn" id="nextTop">Chap sau ‚ü∂</button></div>
        </div>
      </div>
      <div id="viewer" class="viewer"></div>
      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevBottom">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center"><label for="chapterSelBottom" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label><select id="chapterSelBottom"></select></div>
          <div class="right"><button class="btn" id="nextBottom">Chap sau ‚ü∂</button></div>
        </div>
      </div>
      <div class="card" id="aggCard">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="font-weight:700">B√¨nh lu·∫≠n chap</div>
            <div class="meta">Kh√°ch xem ƒë∆∞·ª£c. ƒêƒÉng nh·∫≠p ƒë·ªÉ cmt & tim.</div>
          </div>
          <button id="chap-like" class="like-btn" disabled><span>‚ù§Ô∏è</span><span id="chap-like-count">0</span></button>
        </div>
        <div id="sb-chap" class="card" style="margin-top:6px">
          <div class="composer">
            <textarea id="chap-input" placeholder="Vi·∫øt g√¨ ƒë√≥‚Ä¶" disabled></textarea>
            <button id="chap-send" class="btn icon-btn" aria-label="G·ª≠i" disabled><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18"><path d="M3.4 11.2l16.7-7.3c.9-.4 1.8.5 1.4 1.4l-7.3 16.7c-.4 1-1.8 1-2.2 0l-2.5-5.4-5.4-2.5c-1-.4-1-1.8 0-2.2zM9.7 14.3l3.9 3.9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
          </div>
          <div id="chap-list"></div>
          <div id="chap-empty" class="empty hidden">Ch∆∞a c√≥ b√¨nh lu·∫≠n. ƒêƒÉng nh·∫≠p ƒë·ªÉ m·ªü ch·ªß ƒë·ªÅ ƒë·∫ßu ti√™n.</div>
        </div>
      </div>
    </section>

    <div class="footer">Supabase comments. Public read. Auth required to post.</div>
  </main>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE = {
  url: "https://kmhypppsljaxvqnnfxfa.supabase.co",
  anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttaHlwcHBzbGpheHZxbm5meGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzUyODgsImV4cCI6MjA3MDUxMTI4OH0.XtcNReQ7J8B9KThtKsaAJ2XXbWwnZat3LVF2y4LMZh4",
  redirectTo: (typeof location!=='undefined' ? (location.origin + location.pathname) : undefined)
};
const sb = createClient(SUPABASE.url, SUPABASE.anonKey);
window.sb = sb;

// basic helpers / state
const $$ = (sel) => document.querySelector(sel);
let user = null;
let CHAPTERS = [];

// notifications state
let notifChannel=null;

// --- auth ---
async function ensureAuth(){
  const authText = document.getElementById('authText');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  function render(){
    if(user){
      authText.textContent = user.user_metadata?.user_name || 'ƒê√£ ƒëƒÉng nh·∫≠p';
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
    }else{
      authText.textContent = 'Kh√°ch';
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
    }
  }

  loginBtn?.addEventListener('click', async ()=>{
    await sb.auth.signInWithOAuth({ provider:'github', options:{ redirectTo: SUPABASE.redirectTo } });
  });

  logoutBtn?.addEventListener('click', async ()=>{
    await sb.auth.signOut();
    user = null;
    render();
  });

  const { data:{ session } } = await sb.auth.getSession();
  user = session?.user || null;
  render();

  sb.auth.onAuthStateChange((_evt, sess)=>{ user = sess?.user || null; render(); });
}

// --- chapters / routing ---
async function buildChaptersAuto(){
  // basic static chapter list; extend if chapters/index.json is added
  return [
    {
      id:'chap-1',
      title:'Ch∆∞∆°ng 1',
      pages:[
        'chapters/chap-1/C1 (1).jpg',
        'chapters/chap-1/C1 (2).jpg',
        'chapters/chap-1/C1 (3).jpg',
        'chapters/chap-1/C1 (4).jpg'
      ]
    }
  ];
}

function populateSelect(id){
  const sel = document.getElementById(id);
  if(!sel) return;
  sel.innerHTML='';
  CHAPTERS.forEach(ch=>{
    const opt = document.createElement('option');
    opt.value = ch.id;
    opt.textContent = ch.title;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', ()=>{ location.hash = sel.value; });
}

function route(){
  const hash = location.hash.replace('#','');
  const home = document.getElementById('homeView');
  const reader = document.getElementById('readerView');
  if(!hash){
    home.style.display='grid';
    reader.style.display='none';
    return;
  }
  const chap = CHAPTERS.find(c=>c.id===hash);
  if(!chap) return;
  home.style.display='none';
  reader.style.display='';
  document.getElementById('chapTitle').textContent = chap.title;
  const viewer = document.getElementById('viewer');
  viewer.innerHTML='';
  chap.pages.forEach(p=>{
    const wrap=document.createElement('div');
    wrap.className='page-wrap';
    const img=document.createElement('img');
    img.className='page';
    img.src=p;
    wrap.appendChild(img);
    viewer.appendChild(wrap);
  });
  ['chapterSelTop','chapterSelMid','chapterSelBottom'].forEach(id=>{
    const s=document.getElementById(id); if(s) s.value=chap.id;
  });
}

// reactions toggle helper
async function toggleReaction(commentId, emoji){
  if(!user){ $$('#loginBtn').click(); return; }
  const { data: existed } = await sb.from('reactions').select('comment_id,emoji').eq('comment_id',commentId).eq('user_id', user.id).eq('emoji', emoji).maybeSingle();
  if(existed){
    await sb.from('reactions').delete().eq('comment_id', commentId).eq('user_id', user.id).eq('emoji', emoji);
  }else{
    await sb.from('reactions').insert({ comment_id: commentId, user_id: user.id, emoji });
  }
}

// notifications
async function refreshNotifCount(){
  if(!user) { const b=$$('#notifBadge'); if(b) b.style.display='none'; return;}
  const { count } = await sb.from('notifications').select('*', { count:'exact', head:true })
    .eq('recipient_id', user.id).eq('read', false);
  const b=$$('#notifBadge');
  if(count>0){ b.textContent = String(count); b.style.display='inline-block'; }
  else { b.style.display='none'; }
}


async function listNotifs(){
  if(!user) return [];
  const { data: rows } = await sb.from('notifications')
    .select('id,created_at,recipient_id,actor_id,type,thread_id,comment_id,read')
    .eq('recipient_id', user.id)
    .order('created_at', { ascending:false })
    .limit(100);
  if(!rows || !rows.length) return [];
  const actorIds = [...new Set(rows.map(r=>r.actor_id))];
  const threadIds = [...new Set(rows.map(r=>r.thread_id))];
  const commentIds = [...new Set(rows.map(r=>r.comment_id).filter(Boolean))];
  let actors=[], threads=[], comments=[];
  if(actorIds.length){ const { data } = await sb.from('profiles').select('id,display_name,avatar_url').in('id', actorIds); actors = data||[]; }
  if(threadIds.length){ const { data } = await sb.from('threads').select('id,type,key').in('id', threadIds); threads = data||[]; }
  if(commentIds.length){ const { data } = await sb.from('comments').select('id,content').in('id', commentIds); comments = data||[]; }
  const aMap = new Map(actors.map(a=>[a.id,a]));
  const tMap = new Map(threads.map(t=>[t.id,t]));
  const cMap = new Map(comments.map(c=>[c.id,c]));
  return rows.map(r=> ({ ...r, actor: aMap.get(r.actor_id)||null, thread: tMap.get(r.thread_id)||null, comment: cMap.get(r.comment_id)||null }));
}


notifOverlay?.addEventListener('click', closeNotifPanel);
document.getElementById('notifCloseBtn')?.addEventListener('click', closeNotifPanel);


// --- Safe hook for notif panel overlay (no re-declare) ---
(function(){
  const panel = document.getElementById('notifPanel');
  let overlay = document.getElementById('notifOverlay');
  if(!overlay){
    overlay = document.createElement('div');
    overlay.id = 'notifOverlay';
    document.body.appendChild(overlay);
  }
  function show(){ overlay.classList.add('show'); }
  function hide(){ overlay.classList.remove('show'); }

  if(!window.__notifPatched){
    const _open  = window.openNotifPanel  || function(){ panel?.classList.add('open'); panel?.setAttribute('aria-hidden','false'); };
    const _close = window.closeNotifPanel || function(){ panel?.classList.remove('open'); panel?.setAttribute('aria-hidden','true'); };
    window.openNotifPanel  = function(){ const r = _open.apply(this, arguments);  show(); return r; };
    window.closeNotifPanel = function(){ const r = _close.apply(this, arguments); hide(); return r; };
    overlay.addEventListener('click', ()=> window.closeNotifPanel());
    document.getElementById('notifCloseBtn')?.addEventListener('click', ()=> window.closeNotifPanel());
    window.__notifPatched = true;
  }
})(); 


// --- v5.3.2 guard: ensure notifOverlay exists & is globally accessible ---
(function(){
  try{
    let el = document.getElementById('notifOverlay');
    if(!el){
      el = document.createElement('div');
      el.id = 'notifOverlay';
      document.body.appendChild(el);
    }
    // make it available both as window.notifOverlay and a var for legacy code
    window.notifOverlay = el;
    if (typeof notifOverlay === 'undefined') { window.notifOverlay_alias = el; /* alias */ }
  }catch(e){ console.warn('notifOverlay guard failed', e); }
})();

// init
(async function init(){
  await ensureAuth();
  CHAPTERS = await buildChaptersAuto();
  function buildTOC(containerId){ const box=document.querySelector(containerId); box.innerHTML=''; CHAPTERS.forEach(ch=>{ const a=document.createElement('a'); a.href=`#${ch.id}`; a.textContent=ch.title; a.className='btn'; a.addEventListener('click',(e)=>{ e.preventDefault(); location.hash=ch.id; }); box.appendChild(a); }); }
  buildTOC('#homeTOC');
  ['chapterSelTop','chapterSelMid','chapterSelBottom'].forEach(populateSelect);
  document.querySelector('#fitSel').addEventListener('change', ()=>{
    document.querySelectorAll('.page').forEach(img=>{
      const mode=document.querySelector('#fitSel').value;
      if(mode==='fit'){ img.style.width='100%'; img.style.maxWidth='100%'; }
      else{ img.style.width='auto'; img.style.maxWidth='none'; }
    });
  });

  window.addEventListener('hashchange', route);
  route();
})();
</script>

<script>
try{ if(typeof notifOverlay === 'undefined' && window.notifOverlay){ var notifOverlay = window.notifOverlay; } }catch(e){}
</script>

</body>
</html>
