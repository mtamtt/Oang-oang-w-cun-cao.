<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oăng Oăng w cún cáo — Truyện</title>
  <style>
    :root{ --bg:#0b0d10; --fg:#e6e8eb; --muted:#98a1b3; --card:#0f1216; --bd:#1a1f29; --accent:#f59e0b; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--fg); font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
    a{ color:inherit; text-decoration:none }
    header{ position:sticky; top:0; z-index:40; background:rgba(11,13,16,.96); border-bottom:1px solid var(--bd); backdrop-filter:blur(8px) }
    .bar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; padding:10px 16px; max-width:980px; margin:0 auto }
    .brand{ font-weight:800 }
    .pill, .btn, select, input, textarea{ color:var(--fg); background:var(--card); border:1px solid var(--bd); border-radius:10px; padding:8px 10px }
    .btn{ display:inline-flex; align-items:center; gap:6px; cursor:pointer }
    .wrap{ max-width:980px; margin:0 auto; padding:16px }
    .grid{ display:grid; gap:12px }
    .viewer{ display:flex; flex-direction:column; gap:0 }
    .page{ width:100%; display:block; background:#0a0c0f }
    .card{ padding:14px; border:1px solid var(--bd); background:var(--card); border-radius:14px }
    .nav3{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; column-gap:16px }
    .meta{ color:var(--muted); font-size:13px }
    .hidden{ display:none }
    /* Comments */
    .comment{ border:1px solid var(--bd); border-radius:12px; padding:10px; margin-bottom:10px }
    .comment .head{ display:flex; gap:8px; align-items:center; margin-bottom:6px }
    .comment .name{ font-weight:700; display:flex; align-items:center; gap:8px }
    .badge-admin{ font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #7c3aed; color:#c4b5fd; background:#1b1533 }
    .comment .time{ color:var(--muted); font-size:12px }
    .comment .actions{ display:flex; gap:10px; align-items:center; margin-top:6px }
    .reply-box{ margin-left:14px; margin-top:6px; display:grid; grid-template-columns:1fr auto; gap:8px; align-items:end }
    .replies{ margin-left:14px; margin-top:6px; display:grid; gap:8px }
    .like-btn{ display:inline-flex; gap:6px; align-items:center; border:1px solid var(--bd); padding:6px 10px; border-radius:999px }
    .like-btn.active{ border-color:#f87171 }
    /* Notif panel */
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(2px); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:70 }
    .backdrop.open{ opacity:1; pointer-events:auto }
    .mini{ position:fixed; z-index:71; right:16px; top:68px; border:1px solid var(--bd); background:var(--card);
      border-radius:20px; box-shadow:0 16px 32px rgba(0,0,0,.5); width:360px; height:420px; max-width:95vw; display:flex; flex-direction:column;
      transform:translateY(-8px) scale(.98); opacity:0; pointer-events:none; transition:transform .22s,opacity .22s; overflow:hidden; }
    .mini.open{ transform:translateY(0) scale(1); opacity:1; pointer-events:auto }
    .mini-body{ flex:1; overflow:auto; padding:8px }
    .notif-btn{ position:relative }
    .notif-dot{ position:absolute; right:-2px; top:-2px; width:9px; height:9px; border-radius:50%; background:#f59e0b }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">Oăng Oăng w cún cáo</div>
      <a href="#home" class="btn">🏠 Trang chủ</a>
      <div class="pill"><label for="chapterSelTop">Mục lục</label> <select id="chapterSelTop"></select></div>
      <div class="pill"><label for="fitSel">Hiển thị</label>
        <select id="fitSel"><option value="fit">Vừa khung</option><option value="full">Kích thước gốc</option></select>
      </div>
      <div style="flex:1"></div>
      <button id="notifBell" class="btn notif-btn" title="Thông báo">🔔<span id="notifDot" class="notif-dot hidden"></span></button>
      <div id="authArea" class="pill">
        <span id="authBadge" style="margin-right:8px;padding:2px 6px;border-radius:8px;background:#1f2937;color:#9ca3af;font-size:12px">auth:…</span>
        <span id="authText">Đang kiểm tra đăng nhập…</span>
        <span id="authRole" class="badge-admin hidden">admin</span>
        <button id="loginBtn" class="btn hidden">Đăng nhập GitHub</button>
        <button id="logoutBtn" class="btn hidden">Đăng xuất</button>
      </div>
    </div>
  </header>

  <div id="backdrop" class="backdrop"></div>
  <aside id="notifPanel" class="mini" aria-hidden="true">
    <div class="mini-body">
      <div class="comment" style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Thông báo</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="markAllRead" class="btn">Đánh dấu đã đọc</button>
            <button id="notifClose" class="btn" aria-label="Đóng">✕</button>
          </div>
        </div>
      </div>
      <div id="notifList"></div>
      <div id="notifEmpty" class="meta hidden">Chưa có thông báo</div>
    </div>
  </aside>

  <main class="wrap grid">
    <section id="homeView" class="grid">
      <div class="card"><div style="font-weight:700;margin-bottom:6px" id="seriesTitle">Truyện</div></div>
      <div class="grid" style="grid-template-columns: 280px 1fr;gap:16px;align-items:start">
        <div class="card"><img id="coverImg" alt="cover" style="width:100%;border-radius:10px;border:1px solid var(--bd);background:#0a0c0f" src="assets/cover.jpg"></div>
        <div class="card"><div style="font-weight:600;margin-bottom:10px">Mục lục</div><div id="homeTOC" class="toc-list"></div></div>
      </div>
    </section>

    <section id="readerView" style="display:none">
      <div class="card"><div id="chapTitle" style="font-weight:700">...</div></div>
      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevTop">⟵ Chap trước</button></div>
          <div class="center"><label for="chapterSelMid" style="display:block;text-align:center;margin-bottom:6px">Mục lục</label><select id="chapterSelMid"></select></div>
          <div class="right"><button class="btn" id="nextTop">Chap sau ⟶</button></div>
        </div>
      </div>
      <div id="viewer" class="viewer"></div>
      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevBottom">⟵ Chap trước</button></div>
          <div class="center"><label for="chapterSelBottom" style="display:block;text-align:center;margin-bottom:6px">Mục lục</label><select id="chapterSelBottom"></select></div>
          <div class="right"><button class="btn" id="nextBottom">Chap sau ⟶</button></div>
        </div>
      </div>
      <div class="card" id="chapBox">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="font-weight:700">Bình luận chap</div>
            <div class="meta">Khách đọc được, đăng nhập để cmt & tim</div>
          </div>
          <button id="chap-like" class="like-btn" disabled><span>❤️</span><span id="chap-like-count">0</span></button>
        </div>
        <div class="card" style="margin-top:6px">
          <div class="reply-box" style="margin:0">
            <textarea id="chap-input" placeholder="Viết gì đó…" disabled></textarea>
            <button id="chap-send" class="btn" disabled aria-label="Gửi">➤</button>
          </div>
          <div id="chap-list" style="margin-top:10px"></div>
          <div id="chap-empty" class="meta hidden">Chưa có bình luận. Đăng nhập để mở chủ đề đầu tiên</div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import {{ createClient }} from "https://esm.sh/@supabase/supabase-js@2";
    const sb = createClient("https://kmhypppsljaxvqnnfxfa.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttaHlwcHBzbGpheHZxbm5meGZhIiwicm9zZSI6ImFub24iLCJpYXQiOjE3NTQ5MzUyODgsImV4cCI6MjA3MDUxMTI4OH0.XtcNReQ7J8B9KThtKsaAJ2XXbWwnZat3LVF2y4LMZh4");
    const SERIES_TITLE = "Cạnh tranh thân thiện (Friendly Rivalry)";
    let CHAPTERS=[], currentChapter=null, user=null; let ADMIN_IDS=new Set(); let chapThread=null;

    const $=(q,el=document)=>el.querySelector(q), $$=(q,el=document)=>el.querySelectorAll(q);
    const show=(el,on)=>el&&el.classList.toggle('hidden',!on), enable=(el,on)=>el&&(el.disabled=!on);
    const fmtTime=s=>{{try{{return new Date(s).toLocaleString('vi-VN')}}catch{{return s}}}};
    const esc=s=>(s??'').replace(/[&<>\"']/g,m=>({{'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}}[m]));

    // ===== Admin =====
    async function loadAdmins(){{
      const {{data}}=await sb.from('admins').select('user_id');
      ADMIN_IDS=new Set((data||[]).map(x=>x.user_id));
      document.getElementById('authRole')?.classList.toggle('hidden', !(user && ADMIN_IDS.has(user.id)));
    }}

    // ===== Auth =====
    async function ensureAuth(){{
      const {{data:{{session}}}}=await sb.auth.getSession();
      user=session?.user||null;
      if(user){{await upsertProfile(); await loadAdmins(); subscribeNotifications(); refreshNotif();}}
      onAuthUI();
    }}
    function onAuthUI(){{
      const badge=document.getElementById('authBadge'), txt=document.getElementById('authText');
      if(user){{
        badge.textContent='auth: logged-in';
        txt.textContent=user.user_metadata?.user_name?'Hi @'+user.user_metadata.user_name:'Đã đăng nhập';
        enable(document.getElementById('chap-input'),true);
        enable(document.getElementById('chap-send'),true);
        enable(document.getElementById('chap-like'),true);
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        document.getElementById('authRole')?.classList.toggle('hidden', !(ADMIN_IDS.has(user.id)));
      }}else{{
        badge.textContent='auth: guest'; txt.textContent='Khách đang xem';
        enable(document.getElementById('chap-input'),false);
        enable(document.getElementById('chap-send'),false);
        enable(document.getElementById('chap-like'),false);
        document.getElementById('loginBtn').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.add('hidden');
        document.getElementById('authRole')?.classList.add('hidden');
      }}
    }}
    document.getElementById('loginBtn').onclick=async()=>{{await sb.auth.signInWithOAuth({{provider:'github',options:{{redirectTo:location.href}}}})}};
    document.getElementById('logoutBtn').onclick=async()=>{{await sb.auth.signOut(); location.reload();}};
    sb.auth.onAuthStateChange(async(_e,s)=>{{user=s?.user||null; if(user) await loadAdmins(); onAuthUI(); if(currentChapter) renderThread();}});
    async function upsertProfile(){{ const u=(await sb.auth.getUser()).data.user; await sb.from('profiles').upsert({{id:u.id,username:u.user_metadata?.user_name,display_name:u.user_metadata?.user_name||u.user_metadata?.name||'User',avatar_url:u.user_metadata?.avatar_url}},{{onConflict:'id'}}); }}

    // ===== Chapters =====
    const EXTS=['jpg','jpeg','png','gif','webp','JPG','JPEG','PNG','GIF','WEBP']; const getHash=()=>decodeURIComponent(location.hash.replace(/^#/,''));
    function fileName(ch,i,ext){{return `C${{ch}} (${{i}}).${{ext}}`}} function imgOk(url){{return new Promise(r=>{{const im=new Image();im.onload=()=>r(true);im.onerror=()=>r(false);im.src=url;}})}} const CHAP_EXT_CACHE=new Map();
    async function findExistingUrl(chPath,ch,i){{const known=CHAP_EXT_CACHE.get(ch); if(known){{const u=`${{chPath}}/${{encodeURIComponent(fileName(ch,i,known))}}`; if(await imgOk(u)) return u;}} for(const ext of EXTS){{const u=`${{chPath}}/${{encodeURIComponent(fileName(ch,i,ext))}}`; if(await imgOk(u)){{CHAP_EXT_CACHE.set(ch,ext); return u;}}}} return null;}
    async function chapExists(n){{return await findExistingUrl(`chapters/chap-${{n}}`,n,1)!==null}} async function buildChaptersAuto(){{const cs=[];for(let i=1;i<=999;i++){{if(!(await chapExists(i))) break; cs.push({{id:`chap-${{i}}`,index:i,title:`Chap ${{i}}`,path:`chapters/chap-${{i}}`}});} } return cs;}}
    function populateSelect(id){{const sel=document.getElementById(id); sel.innerHTML=''; CHAPTERS.forEach(ch=>{{const o=document.createElement('option');o.value=ch.id;o.textContent=ch.title;sel.appendChild(o);}}); sel.onchange=()=>location.hash=sel.value;}} function neighbor(id,dir){{const i=CHAPTERS.findIndex(c=>c.id===id); const nx=CHAPTERS[i+dir]; return nx?nx.id:null;}}
    function route(){{const h=getHash()||'home'; if(h==='home'){{document.getElementById('homeView').style.display='grid';document.getElementById('readerView').style.display='none';}} else {{renderChapter(CHAPTERS.find(c=>c.id===h)||CHAPTERS[0]);}}}}

    async function renderChapter(ch){{
      document.getElementById('homeView').style.display='none'; document.getElementById('readerView').style.display='block'; currentChapter=ch;
      document.getElementById('chapTitle').textContent=`${{SERIES_TITLE}} — ${{ch.title}}`;
      ['Top','Mid','Bottom'].forEach(p=>{{const s=document.getElementById('chapterSel'+p); if(s) s.value=ch.id;}});
      const v=document.getElementById('viewer'); v.innerHTML=''; let miss=0;
      for(let i=1;i<=2000;i++){{const u=await findExistingUrl(ch.path,ch.index,i); if(!u){{miss++; if(miss>=3||i===1) break; continue;}} miss=0; const img=document.createElement('img'); img.className='page'; img.loading='lazy'; img.src=u; img.alt=`${{ch.title}} — trang ${{i}}`; v.appendChild(img);}}
      const p=neighbor(ch.id,-1), n=neighbor(ch.id,1);
      document.getElementById('prevTop').onclick=()=>p&&(location.hash=p); document.getElementById('nextTop').onclick=()=>n&&(location.hash=n);
      document.getElementById('prevBottom').onclick=()=>p&&(location.hash=p); document.getElementById('nextBottom').onclick=()=>n&&(location.hash=n);

      const existing=await sb.from('threads').select('id,key').eq('key',`chap:${{ch.index}}`).maybeSingle();
      chapThread=existing.data||null;
      await renderThread();
    }}

    function adminBadge(uid){{ return ADMIN_IDS.has(uid) ? '<span class="badge-admin">admin</span>' : ''; }}

    function commentNode(c,threadId){{
      const el=document.createElement('div'); el.className='comment';
      const name=c.profile?.display_name||c.user_id.slice(0,6)+'…';
      const avatar=c.profile?.avatar_url||'https://avatars.githubusercontent.com/u/0?v=4';
      const me=user?.id===c.user_id;
      const iAmAdmin = user && ADMIN_IDS.has(user.id);
      const body=c.is_hidden?'<i class="meta">Bình luận đã bị ẩn</i>':esc(c.content);
      el.innerHTML=`
        <div class="head">
          <img src="${{avatar}}" alt="" style="width:28px;height:28px;border-radius:50%;border:1px solid var(--bd)">
          <div class="name">${{esc(name)}} ${{adminBadge(c.user_id)}}</div>
          <div class="time">· ${{fmtTime(c.created_at)}}</div>
          <div style="margin-left:auto;position:relative">
            <button class="btn more-btn">⋯</button>
            <div class="card more-menu hidden" style="position:absolute;right:0;top:36px;display:grid;gap:6px;min-width:160px">
              ${{me?'<button class="btn edit-btn">Sửa</button>':''}}
              ${{(me||iAmAdmin)?'<button class="btn del-btn">Xóa</button>':''}}
              ${{iAmAdmin?'<button class="btn hide-btn">'+(c.is_hidden?'Bỏ ẩn':'Ẩn')+'</button>':''}}
              <button class="btn close-menu">Đóng</button>
            </div>
          </div>
        </div>
        <div class="body">${{body}}</div>
        <div class="actions">
          <button class="btn reply-btn">Trả lời</button>
          <button class="btn toggle-replies hidden">Ẩn/Hiện trả lời</button>
        </div>
        <div class="reply-box hidden">
          <textarea rows="2" placeholder="Phản hồi…"></textarea>
          <button class="btn send-reply" aria-label="Gửi">➤</button>
        </div>
        <div class="replies"></div>`;

      const menu=el.querySelector('.more-menu');
      el.querySelector('.more-btn').onclick=()=>menu.classList.toggle('hidden');
      el.querySelector('.close-menu').onclick=()=>menu.classList.add('hidden');

      const editBtn=el.querySelector('.edit-btn');
      if(editBtn) editBtn.onclick=()=>{
        menu.classList.add('hidden');
        const raw=c.content;
        el.querySelector('.body').innerHTML=`<div class="reply-box" style="margin:0"><textarea class="edit-ta">${{esc(raw)}}</textarea><button class="btn save-edit">Lưu</button></div>`;
        el.querySelector('.save-edit').onclick=async()=>{
          const nv=el.querySelector('.edit-ta').value.trim(); if(!nv) return;
          const {{error}}=await sb.from('comments').update({{content:nv,updated_at:new Date().toISOString()}}).eq('id',c.id);
          if(error) alert('Lỗi sửa bình luận: '+error.message);
        };
      };

      const delBtn=el.querySelector('.del-btn');
      if(delBtn) delBtn.onclick=async()=>{
        menu.classList.add('hidden');
        if(!confirm('Xóa bình luận này?')) return;
        const {{error}}=await sb.from('comments').delete().eq('id',c.id);
        if(error) alert('Lỗi xóa bình luận: '+error.message);
      };

      const hideBtn=el.querySelector('.hide-btn');
      if(hideBtn) hideBtn.onclick=async()=>{
        menu.classList.add('hidden');
        const {{error}}=await sb.from('comments').update({{is_hidden:!c.is_hidden}}).eq('id',c.id);
        if(error) alert('Lỗi ẩn/hiện: '+error.message);
      };

      el.querySelector('.reply-btn').onclick=()=>el.querySelector('.reply-box').classList.toggle('hidden');
      el.querySelector('.send-reply').onclick=async()=>{
        if(!user) return document.getElementById('loginBtn').click();
        const t=el.querySelector('.reply-box textarea'); const content=t.value.trim(); if(!content) return;
        const {{error}}=await sb.from('comments').insert({{thread_id:threadId,content,parent_id:c.id,user_id:user.id}});
        if(error) alert('Lỗi gửi trả lời: '+error.message); else t.value='';
      };

      const rep=el.querySelector('.replies');
      if((c.replies||[]).length){ el.querySelector('.toggle-replies').classList.remove('hidden'); el.querySelector('.toggle-replies').onclick=()=>rep.classList.toggle('hidden'); c.replies.forEach(r=>rep.appendChild(commentNode(r,threadId))); }
      return el;
    }}

    async function listCommentsWithProfiles(threadId){
      const {{data:rows,error}}=await sb.from('comments').select('id,thread_id,user_id,parent_id,content,is_hidden,created_at,updated_at').eq('thread_id',threadId).order('created_at',{{ascending:true}});
      if(error) console.error('listComments error', error);
      const ids=[...new Set((rows||[]).map(r=>r.user_id))];
      const {{data:pf}}=ids.length?await sb.from('profiles').select('id,display_name,username,avatar_url').in('id',ids):{{data:[]}};
      const map=new Map((pf||[]).map(p=>[p.id,p]));
      return (rows||[]).map(r=>({{...r,profile:map.get(r.user_id)||null}}));
    }
    function nest(rows){ const by=new Map(); rows.forEach(r=>by.set(r.id,{{...r,replies:[]}})); const roots=[]; rows.forEach(r=>{{const n=by.get(r.id); if(r.parent_id&&by.get(r.parent_id)) by.get(r.parent_id).replies.push(n); else roots.push(n);}}); return roots; }

    async function renderThread(){
      const likeBtn=document.getElementById('chap-like'); const likeCountEl=document.getElementById('chap-like-count');
      const listEl=document.getElementById('chap-list'); const emptyEl=document.getElementById('chap-empty');
      if(!chapThread){
        likeCountEl.textContent=0; listEl.innerHTML=''; show(emptyEl,true);
        likeBtn.onclick=async()=>{
          const ins=await sb.from('threads').insert({{type:'chap',key:`chap:${{currentChapter.index}}`}}).select('id').single();
          if(ins.error) return alert('Lỗi tạo thread: '+ins.error.message);
          chapThread=ins.data; await renderThread();
        };
        return;
      }
      show(emptyEl,false);

      // likes
      const cnt = await sb.from('likes').select('*',{{count:'exact',head:true}}).eq('thread_id',chapThread.id);
      likeCountEl.textContent = cnt.count||0;
      const myLike = user ? (await sb.from('likes').select('thread_id').eq('thread_id',chapThread.id).eq('user_id',user.id).maybeSingle()).data : null;
      likeBtn.classList.toggle('active', !!myLike);
      likeBtn.onclick=async()=>{
        if(!user) return document.getElementById('loginBtn').click();
        const liked = (await sb.from('likes').select('thread_id').eq('thread_id',chapThread.id).eq('user_id',user.id).maybeSingle()).data;
        if(liked) await sb.from('likes').delete().eq('thread_id',chapThread.id).eq('user_id',user.id);
        else await sb.from('likes').upsert({{thread_id:chapThread.id,user_id:user.id}},{{onConflict:'thread_id,user_id'}});
      };

      // comments
      const rows=await listCommentsWithProfiles(chapThread.id);
      listEl.innerHTML=''; nest(rows).forEach(c=>listEl.appendChild(commentNode(c,chapThread.id)));

      // send new
      document.getElementById('chap-send').onclick=async()=>{
        if(!user) return document.getElementById('loginBtn').click();
        let th=chapThread;
        if(!th){
          const ins=await sb.from('threads').insert({{type:'chap',key:`chap:${{currentChapter.index}}`}}).select('id').single();
          if(ins.error) return alert('Lỗi tạo thread: '+ins.error.message);
          th=chapThread=ins.data;
        }
        const content=document.getElementById('chap-input').value.trim(); if(!content) return;
        const {{error}}=await sb.from('comments').insert({{thread_id:th.id,content,parent_id:null,user_id:user.id}});
        if(error) alert('Lỗi gửi bình luận: '+error.message); else document.getElementById('chap-input').value='';
      };

      // realtime
      sb.channel('rt:'+chapThread.id)
        .on('postgres_changes',{{event:'INSERT',schema:'public',table:'comments',filter:`thread_id=eq.${{chapThread.id}}`}},async()=>{{const rows=await listCommentsWithProfiles(chapThread.id); listEl.innerHTML=''; nest(rows).forEach(c=>listEl.appendChild(commentNode(c,chapThread.id)));}})
        .on('postgres_changes',{{event:'UPDATE',schema:'public',table:'comments',filter:`thread_id=eq.${{chapThread.id}}`}},async()=>{{const rows=await listCommentsWithProfiles(chapThread.id); listEl.innerHTML=''; nest(rows).forEach(c=>listEl.appendChild(commentNode(c,chapThread.id)));}})
        .on('postgres_changes',{{event:'DELETE',schema:'public',table:'comments',filter:`thread_id=eq.${{chapThread.id}}`}},async()=>{{const rows=await listCommentsWithProfiles(chapThread.id); listEl.innerHTML=''; nest(rows).forEach(c=>listEl.appendChild(commentNode(c,chapThread.id)));}})
        .on('postgres_changes',{{event:'INSERT',schema:'public',table:'likes',filter:`thread_id=eq.${{chapThread.id}}`}},async()=>{{const cnt = await sb.from('likes').select('*',{{count:'exact',head:true}}).eq('thread_id',chapThread.id); likeCountEl.textContent = cnt.count||0;}})
        .on('postgres_changes',{{event:'DELETE',schema:'public',table:'likes',filter:`thread_id=eq.${{chapThread.id}}`}},async()=>{{const cnt = await sb.from('likes').select('*',{{count:'exact',head:true}}).eq('thread_id',chapThread.id); likeCountEl.textContent = cnt.count||0;}})
        .subscribe();
    }

    // ===== Notifications =====
    function openNotif(){ document.getElementById('backdrop').classList.add('open'); document.getElementById('notifPanel').classList.add('open'); }
    function closeNotif(){ document.getElementById('backdrop').classList.remove('open'); document.getElementById('notifPanel').classList.remove('open'); }
    document.getElementById('notifBell').onclick=openNotif; document.getElementById('notifClose').onclick=closeNotif; document.getElementById('backdrop').onclick=closeNotif;

    async function refreshNotif(){
      if(!user) return;
      const {{data}}=await sb.from('notifications').select('id,type,payload,created_at,read_at').eq('user_id',user.id).order('created_at',{{ascending:false}}).limit(30);
      const box=document.getElementById('notifList'); const emp=document.getElementById('notifEmpty');
      box.innerHTML=''; if(!data?.length){ show(emp,true); document.getElementById('notifDot').classList.add('hidden'); return; } show(emp,false);
      document.getElementById('notifDot').classList.toggle('hidden', !data.some(n=>!n.read_at));
      for(const n of data){ const wrap=document.createElement('div'); wrap.className='comment'; const msg=(n.payload&&n.payload.message)|| (n.type==='reply'?'Có người trả lời bạn':'Có bình luận mới'); wrap.innerHTML=`<div class="head"><div class="name">${{esc(msg)}}</div><div class="time">· ${{fmtTime(n.created_at)}} ${{n.read_at?'· đã đọc':''}}</div></div>`; box.appendChild(wrap); }
    }
    document.getElementById('markAllRead').onclick=async()=>{ if(!user) return; await sb.from('notifications').update({{read_at:new Date().toISOString()}}).is('read_at',null).eq('user_id',user.id); refreshNotif(); }
    function subscribeNotifications(){ if(!user) return; try{ sb.channel('rt-notif:'+user.id).on('postgres_changes',{{event:'INSERT',schema:'public',table:'notifications',filter:`user_id=eq.${{user.id}}`}},refreshNotif).subscribe(); }catch(e){ console.warn('notif sub fail', e); }}

    // ===== Init =====
    try{ const urlNow=new URL(location.href); if(urlNow.searchParams.get('code')){ await sb.auth.exchangeCodeForSession(location.href); history.replaceState({},document.title,urlNow.pathname+urlNow.search+urlNow.hash); } }catch{}
    (async function init(){
      await ensureAuth();
      document.getElementById('seriesTitle').textContent=SERIES_TITLE;
      CHAPTERS=await buildChaptersAuto();
      ['chapterSelTop','chapterSelMid','chapterSelBottom'].forEach(populateSelect);
      window.addEventListener('hashchange',route);
      document.getElementById('fitSel').onchange=()=>{ document.querySelectorAll('.page').forEach(img=>{ const on=document.getElementById('fitSel').value==='fit'; img.style.width=on?'100%':'auto'; img.style.maxWidth=on?'100%':'none'; }); };
      route();
      if(user) subscribeNotifications(); refreshNotif();
    })();
  </script>
</body>
</html>
