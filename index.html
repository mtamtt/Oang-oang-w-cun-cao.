<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OƒÉng oƒÉng w c√∫n c√°o ‚Äî ƒê·ªçc truy·ªán (Supabase Comments v4)</title>
  <style>
    :root{--bg:#0b0d10;--fg:#e6e8eb;--muted:#98a1b3;--card:#0f1216;--bd:#1a1f29;--accent:#f59e0b;--pink:#ec4899;--green:#22c55e;--basic:#94a3b8}
    *{box-sizing:border-box} html,body{margin:0;padding:0;height:100%}
    body{background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(11,13,16,.98), rgba(11,13,16,.92));border-bottom:1px solid var(--bd);backdrop-filter:saturate(180%) blur(10px)}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .brand span{font-weight:800;margin-left:8px}
    /* TOC alignment fix */
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px}
    .pill label{font-size:14px;line-height:1;display:flex;align-items:center}
    #chapterSelTop{height:36px;line-height:36px;padding:0 10px;margin:0;position:relative;top:0}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);background:var(--card);border-radius:999px}
    select,button,input,textarea{color:var(--fg);background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    .grow{flex:1}
    .grid{display:grid;gap:12px}
    .viewer{display:flex;flex-direction:column;gap:0}
    .page{width:100%;display:block;border-radius:0;border:none;background:#0a0c0f;margin-left:auto;margin-right:auto}
    .card{padding:14px;border:1px solid var(--bd);background:var(--card);border-radius:14px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bd);background:var(--card);cursor:pointer}
    .btn:hover{border-color:#2a3242}
    .nav3{display:grid;grid-template-columns:auto 1fr auto;align-items:center;column-gap:16px}
    .nav3 .left .btn{margin-right:8px}
    .nav3 .right .btn{margin-left:8px}
/* center align the grid center cell */
.nav3 .center{display:flex;align-items:center;justify-content:center;gap:8px}

    .meta{color:var(--muted);font-size:13px}
    #toTopBtn{ position:fixed;right:18px;bottom:18px;z-index:55;border-radius:999px;width:46px;height:46px;display:none;
      align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.35);
      background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);box-shadow:0 8px 18px rgba(0,0,0,.45);}
    #toTopBtn svg{width:22px;height:22px;display:block;color:#e5e7eb}
    .hidden{display:none}

    /* Mini panel */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:70}
    .backdrop.open{opacity:1;pointer-events:auto}
    .mini{
      position:fixed;z-index:71;right:16px;bottom:70px;border:1px solid var(--bd);background:var(--card);
      border-radius:20px;box-shadow:0 16px 32px rgba(0,0,0,.5);
      width:360px;height:420px;max-width:95vw;max-height:85vh;
      display:flex;flex-direction:column;transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:transform .22s ease,opacity .22s ease;
      overflow:hidden;
    }
    .mini.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
    .mini-body{flex:1;overflow:auto;padding:8px;-webkit-overflow-scrolling:touch}
    .composer{display:flex;gap:8px;margin:8px 0}
    .composer{position:relative;display:flex;gap:8px}
    .composer .icon-btn{position:absolute;right:12px;bottom:12px;width:36px;height:36px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center}
    .composer textarea{flex:1;resize:vertical;min-height:56px;padding-right:56px}

    .composer textarea{flex:1;resize:vertical;min-height:56px}
    .comment{border:1px solid var(--bd);border-radius:12px;padding:10px;margin-bottom:10px}
    .comment .head{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .comment .name{font-weight:700}
    .comment .time{color:var(--muted);font-size:12px}
    .comment .actions{display:flex;gap:10px;align-items:center;margin-top:6px}
    .comment .reply{color:var(--basic);cursor:pointer}
    .reply-box{margin-left:14px;margin-top:6px}
    .replies{margin-left:14px;margin-top:6px;display:grid;gap:8px}
    .like-btn{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);padding:6px 10px;border-radius:999px}
    .like-btn.active{border-color:#f87171}
    .reaction{cursor:pointer}
    #sb-chap .thread-head, #sb-page .thread-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    #sb-chap .thread-head .title, #sb-page .thread-head .title{font-weight:700}
    .empty{color:var(--muted);font-size:14px;padding:8px 4px}
  
/* Notifications panel */
#notifPanel {position:fixed;z-index:72;right:16px;bottom:70px;border:1px solid var(--bd);background:var(--card);
  border-radius:20px;box-shadow:0 16px 32px rgba(0,0,0,.5);width:360px;height:420px;max-width:95vw;max-height:85vh;
  display:flex;flex-direction:column;transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:transform .22s ease,opacity .22s ease;overflow:hidden;}
#notifPanel.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto;}
#notifList{flex:1;overflow:auto;padding:10px;display:grid;gap:8px}
.notif-item{display:grid;grid-template-columns:auto 1fr;gap:8px;border:1px solid var(--bd);border-radius:12px;padding:10px;cursor:pointer}
.notif-item:hover{border-color:#2a3242}
.notif-item .meta{font-size:12px;color:var(--muted)}
.highlight{animation: hi 1.6s ease 1}
@keyframes hi{0%{box-shadow:0 0 0 0 rgba(245,158,11,.0)}30%{box-shadow:0 0 0 6px rgba(245,158,11,.25)}100%{box-shadow:0 0 0 0 rgba(245,158,11,.0)}}
.reaction{cursor:pointer;border:1px solid var(--bd);padding:4px 8px;border-radius:999px;display:inline-flex;gap:6px;align-items:center}
.reaction.active{border-color:#f59e0b}

/* Notifications unread highlight + preview text */
.notif-item.unread{border-color:#f59e0b;background:rgba(245,158,11,.06)}
.notif-preview{color:var(--muted);font-size:13px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Reaction buttons */
.react-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.react-btn{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);padding:6px 10px;border-radius:999px;background:var(--card);
  user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}
.react-btn:hover{border-color:#2a3242}
.react-btn.active{border-color:#f59e0b}
.react-btn .icon{width:18px;height:18px;display:inline-block}
.react-btn .count{font-size:13px;color:var(--fg)}
    .react-btn .emoji{display:inline-block;font-size:20px;line-height:1.1;transform: translateY(1px);}
    .react-btn{user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}



</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand"><span>OƒÉng oƒÉng w c√∫n c√°o</span></div>
      <a href="#home" id="homeBtn" class="btn">üè† Trang ch·ªß</a>
      <div class="pill"><label for="chapterSelTop">M·ª•c l·ª•c</label> <select id="chapterSelTop"></select></div>
      <div class="pill"><label for="fitSel">Hi·ªÉn th·ªã</label>
        <select id="fitSel"><option value="fit">V·ª´a khung</option><option value="full">K√≠ch th∆∞·ªõc g·ªëc</option></select>
      </div>
      <div class="grow"></div>
      <div id="authArea" class="pill"><button id="notifBtn" class="btn" style="position:relative;margin-right:6px">üîî<span id="notifBadge" style="position:absolute;top:-6px;right:-6px;font-size:12px;background:#ef4444;color:#fff;border-radius:999px;padding:1px 6px;min-width:18px;text-align:center;display:none">0</span></button>
        <span id="authText">ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p‚Ä¶</span>
        <button id="loginBtn" class="btn hidden">ƒêƒÉng nh·∫≠p GitHub</button>
        <button id="logoutBtn" class="btn hidden">ƒêƒÉng xu·∫•t</button>
      </div>
      <div class="meta">Ph√≠m t·∫Øt: B m·ªü cmt ¬∑ G l√™n ƒë·∫ßu</div>
    </div>
  </header>

  <div id="backdrop" class="backdrop"></div>
  <aside id="miniPanel" class="mini" aria-hidden="true">
    <div class="mini-body">
      <div id="sb-page">
        <div class="thread-head">
          <div class="title">B√¨nh lu·∫≠n ·∫£nh</div>
          <button id="page-like" class="like-btn" disabled><span>‚ù§Ô∏è</span><span id="page-like-count">0</span></button>
        </div>
        <div id="page-auth-hint" class="meta">Kh√°ch xem ƒë∆∞·ª£c. ƒêƒÉng nh·∫≠p ƒë·ªÉ cmt & tim.</div>
        <div class="composer">
          <textarea id="page-input" placeholder="Vi·∫øt g√¨ ƒë√≥‚Ä¶" disabled></textarea>
          <button id="page-send" class="btn icon-btn" aria-label="G·ª≠i" disabled><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18"><path d="M3.4 11.2l16.7-7.3c.9-.4 1.8.5 1.4 1.4l-7.3 16.7c-.4 1-1.8 1-2.2 0l-2.5-5.4-5.4-2.5c-1-.4-1-1.8 0-2.2zM9.7 14.3l3.9 3.9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
        </div>
        <div id="page-list"></div>
        <div id="page-empty" class="empty hidden">Ch∆∞a c√≥ b√¨nh lu·∫≠n. ƒêƒÉng nh·∫≠p ƒë·ªÉ m·ªü ch·ªß ƒë·ªÅ ƒë·∫ßu ti√™n.</div>
      </div>
    </div>
  </aside>

  <aside id="notifPanel" aria-hidden="true"><div class="bar" style="padding:10px;display:flex;align-items:center;justify-content:space-between"><div style="font-weight:700">Th√¥ng b√°o</div><button id="notifClose" class="btn" aria-label="ƒê√≥ng">‚úï</button></div><div id="notifList"></div><div class="empty meta" id="notifEmpty" style="padding:10px;display:none">Ch∆∞a c√≥ th√¥ng b√°o</div></aside>

  <button id="toTopBtn" aria-label="L√™n ƒë·∫ßu chap" title="L√™n ƒë·∫ßu chap">‚¨Ü</button>

  <main class="wrap grid">
    <section id="homeView" class="grid">
      <div class="card"><div style="font-weight:700;margin-bottom:6px">C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)</div></div>
      <div class="grid" style="grid-template-columns: 280px 1fr;gap:16px;align-items:start">
        <div class="card"><img id="coverImg" alt="cover" style="width:100%;border-radius:10px;border:1px solid var(--bd);background:#0a0c0f" src="assets/cover.jpg"></div>
        <div class="card"><div style="font-weight:600;margin-bottom:10px">M·ª•c l·ª•c</div><div id="homeTOC" class="toc-list"></div></div>
      </div>
    </section>

    <section id="readerView" style="display:none">
      <div class="card"><div id="chapTitle" style="font-weight:700">...</div></div>
      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevTop">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center"><label for="chapterSelMid" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label><select id="chapterSelMid"></select></div>
          <div class="right"><button class="btn" id="nextTop">Chap sau ‚ü∂</button></div>
        </div>
      </div>
      <div id="viewer" class="viewer"></div>
      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevBottom">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center"><label for="chapterSelBottom" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label><select id="chapterSelBottom"></select></div>
          <div class="right"><button class="btn" id="nextBottom">Chap sau ‚ü∂</button></div>
        </div>
      </div>
      <div class="card" id="aggCard">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="font-weight:700">B√¨nh lu·∫≠n chap</div>
            <div class="meta">Kh√°ch xem ƒë∆∞·ª£c. ƒêƒÉng nh·∫≠p ƒë·ªÉ cmt & tim.</div>
          </div>
          <button id="chap-like" class="like-btn" disabled><span>‚ù§Ô∏è</span><span id="chap-like-count">0</span></button>
        </div>
        <div id="sb-chap" class="card" style="margin-top:6px">
          <div class="composer">
            <textarea id="chap-input" placeholder="Vi·∫øt g√¨ ƒë√≥‚Ä¶" disabled></textarea>
            <button id="chap-send" class="btn icon-btn" aria-label="G·ª≠i" disabled><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18"><path d="M3.4 11.2l16.7-7.3c.9-.4 1.8.5 1.4 1.4l-7.3 16.7c-.4 1-1.8 1-2.2 0l-2.5-5.4-5.4-2.5c-1-.4-1-1.8 0-2.2zM9.7 14.3l3.9 3.9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
          </div>
          <div id="chap-list"></div>
          <div id="chap-empty" class="empty hidden">Ch∆∞a c√≥ b√¨nh lu·∫≠n. ƒêƒÉng nh·∫≠p ƒë·ªÉ m·ªü ch·ªß ƒë·ªÅ ƒë·∫ßu ti√™n.</div>
        </div>
      </div>
    </section>

    <div class="footer">Supabase comments. Public read. Auth required to post.</div>
  </main>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE = {
  url: "https://kmhypppsljaxvqnnfxfa.supabase.co",
  anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttaHlwcHBzbGpheHZxbm5meGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzUyODgsImV4cCI6MjA3MDUxMTI4OH0.XtcNReQ7J8B9KThtKsaAJ2XXbWwnZat3LVF2y4LMZh4",
  redirectTo: (function(){ try { return location.origin + location.pathname; } catch(e){ return (typeof location!=='undefined') ? (location.origin + location.pathname) : undefined;} })()
};
const sb = createClient(SUPABASE.url, SUPABASE.anonKey);
window.sb = sb;

// notifications state
let notifChannel=null;

// reactions toggle helper
async function toggleReaction(commentId, emoji){
  if(!user){ $$('#loginBtn').click(); return; }
  const { data: existed } = await sb.from('reactions').select('comment_id,emoji').eq('comment_id',commentId).eq('user_id', user.id).eq('emoji', emoji).maybeSingle();
  if(existed){
    await sb.from('reactions').delete().eq('comment_id', commentId).eq('user_id', user.id).eq('emoji', emoji);
  }else{
    await sb.from('reactions').insert({ comment_id: commentId, user_id: user.id, emoji });
  }
}

// notifications
async function refreshNotifCount(){
  if(!user) { const b=$$('#notifBadge'); if(b) b.style.display='none'; return;}
  const { count } = await sb.from('notifications').select('*', { count:'exact', head:true })
    .eq('recipient_id', user.id).eq('read', false);
  const b=$$('#notifBadge');
  if(count>0){ b.textContent = String(count); b.style.display='inline-block'; }
  else { b.style.display='none'; }
}


async function listNotifs(){
  if(!user) return [];
  const { data: rows } = await sb.from('notifications')
    .select('id,created_at,recipient_id,actor_id,type,thread_id,comment_id,read')
    .eq('recipient_id', user.id)
    .order('created_at', { ascending:false })
    .limit(100);
  if(!rows || !rows.length) return [];
  const actorIds = [...new Set(rows.map(r=>r.actor_id))];
  const threadIds = [...new Set(rows.map(r=>r.thread_id))];
  const commentIds = [...new Set(rows.map(r=>r.comment_id).filter(Boolean))];
  let actors=[], threads=[], comments=[];
  if(actorIds.length){ const { data } = await sb.from('profiles').select('id,display_name,avatar_url').in('id', actorIds); actors = data||[]; }
  if(threadIds.length){ const { data } = await sb.from('threads').select('id,type,key').in('id', threadIds); threads = data||[]; }
  if(commentIds.length){ const { data } = await sb.from('comments').select('id,content').in('id', commentIds); comments = data||[]; }
  const aMap = new Map(actors.map(a=>[a.id,a]));
  const tMap = new Map(threads.map(t=>[t.id,t]));
  const cMap = new Map(comments.map(c=>[c.id,c]));
  return rows.map(r=> ({ ...r, actor: aMap.get(r.actor_id)||null, thread: tMap.get(r.thread_id)||null, comment: cMap.get(r.comment_id)||null }));
}


function openNotifPanel(){
  const panel = $$('#notifPanel');
  $$('#backdrop').classList.add('open');
  panel.classList.add('open'); panel.setAttribute('aria-hidden','false');
}

function closeNotifPanel(){
  const panel = $$('#notifPanel');
  panel.classList.remove('open'); panel.setAttribute('aria-hidden','true');
  if(!$$('#miniPanel').classList.contains('open')){ $$('#backdrop').classList.remove('open'); }
}


$$("#notifBtn").addEventListener('click', async ()=>{
  if(!user){ return $$("#loginBtn").click(); }
  openNotifPanel();
  const list = $$("#notifList"); list.innerHTML = '<div class="meta" style="padding:10px">ƒêang t·∫£i‚Ä¶</div>';
  const rows = await listNotifs();
  const empty = $$("#notifEmpty"); empty.style.display = rows.length? 'none':'block';
  list.innerHTML = '';
  rows.forEach(r=>{
    const el = document.createElement('div'); el.className='notif-item'; el.dataset.id=r.id;
    if(!r.read) el.classList.add('unread');
    const av = r.actor?.avatar_url || 'https://avatars.githubusercontent.com/u/0?v=4';
    const name = r.actor?.display_name || 'Ai ƒë√≥';
    const when = fmtTime(r.created_at);
    const tlabel = r.thread?.key || 'thread';
    const preview = r.comment?.content ? escapeHtml(r.comment.content) : '';
    el.innerHTML = `
      <img src="${av}" style="width:28px;height:28px;border-radius:50%;border:1px solid var(--bd)">
      <div>
        <div><strong>${name}</strong> ƒë√£ tr·∫£ l·ªùi b√¨nh lu·∫≠n c·ªßa m</div>
        <div class="meta">${tlabel} ¬∑ ${when}</div>
        <div class="notif-preview">${preview}</div>
      </div>
    `;
    el.addEventListener('click', async ()=>{
      await sb.from('notifications').update({ read:true }).eq('id', r.id);
      await refreshNotifCount();
      closeNotifPanel();
      if(r.thread){
        await gotoThreadAndComment(r.thread, r.comment_id);
      }
    });
    list.appendChild(el);
  });
});

// realtime notifications
async function subscribeNotifs(){
  if(notifChannel) sb.removeChannel(notifChannel);
  if(!user) return;
  notifChannel = sb.channel('notif:'+user.id)
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'notifications', filter:`recipient_id=eq.${user.id}`}, ()=>{
      refreshNotifCount();
    })
    .subscribe();
}

// Deep link to comment
async function gotoThreadAndComment(thread, commentId){
  if(!thread || !commentId) return;
  const key = thread.key; // e.g. chap:1 or page:1-3
  if(key.startsWith('chap:')){
    const chapIdx = parseInt(key.split(':')[1],10);
    const targetId = 'chap-'+chapIdx;
    if(getHash() !== targetId){ location.hash = targetId; await new Promise(r=> setTimeout(r, 150)); }
    chapThread = await getOrCreateThread('chap', `chap:${chapIdx}`, { createIfMissing:false });
    await renderThread($$('#aggCard'), chapThread);
    await focusCommentDom(commentId);
  }else if(key.startsWith('page:')){
    const parts = key.split(':')[1].split('-'); const chapIdx=parseInt(parts[0],10); const pageIdx=parseInt(parts[1],10);
    const targetId = 'chap-'+chapIdx;
    if(getHash() !== targetId){ location.hash = targetId; await new Promise(r=> setTimeout(r, 150)); }
    await new Promise(r=> setTimeout(r, 200));
    await openMini(pageIdx);
    await focusCommentDom(commentId, true);
  }
}

async function focusCommentDom(commentId, inMini){
  const root = inMini ? $$('#sb-page') : document;
  for(let i=0;i<20;i++){
    const el = root.querySelector('#cmt-'+commentId);
    if(el){
      el.scrollIntoView({ behavior:'smooth', block:'center'});
      el.classList.add('highlight');
      setTimeout(()=> el.classList.remove('highlight'), 1800);
      return;
    }
    await new Promise(r=> setTimeout(r, 120));
  }
}


// state
const EXTS = ["jpg","jpeg","png","gif","webp","JPG","JPEG","PNG","GIF","WEBP"];
const SERIES_TITLE = "C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)";
let CHAPTERS=[], currentChapter=null, currentPageForPanel=null;
let user=null;
let chapThread=null, pageThread=null;

// utils
function $$(q, el=document){ return el.querySelector(q); }
function show(el, on){ el.classList.toggle('hidden', !on); }
function enable(el, on){ if(!el) return; el.disabled = !on; }

// auth + profile upsert
async function ensureAuth(){
  const { data:{ session } } = await sb.auth.getSession();
  user = session?.user || null;
  onAuthUI();
  if(user){ await upsertProfileFromAuth(); refreshNotifCount(); subscribeNotifs(); }
}
function onAuthUI(){
  const authText = $$("#authText"), loginBtn=$$("#loginBtn"), logoutBtn=$$("#logoutBtn");
  if(user){
    authText.textContent = user?.user_metadata?.user_name ? `Hi @${user.user_metadata.user_name}` : `ƒê√£ ƒëƒÉng nh·∫≠p`;
    loginBtn.classList.add('hidden'); logoutBtn.classList.remove('hidden');
    enable($$("#chap-input"), true); enable($$("#chap-send"), true); enable($$("#chap-like"), true);
    enable($$("#page-input"), true); enable($$("#page-send"), true); enable($$("#page-like"), true);
  }else{
    authText.textContent = "Kh√°ch ƒëang xem";
    loginBtn.classList.remove('hidden'); logoutBtn.classList.add('hidden');
    enable($$("#chap-input"), false); enable($$("#chap-send"), false); enable($$("#chap-like"), false);
    enable($$("#page-input"), false); enable($$("#page-send"), false); enable($$("#page-like"), false);
  }
}
$$("#loginBtn").addEventListener('click', async ()=>{
  await sb.auth.signInWithOAuth({ provider:'github', options:{ redirectTo: SUPABASE.redirectTo } });
});
$$("#logoutBtn").addEventListener('click', async ()=>{ await sb.auth.signOut(); location.reload(); });
sb.auth.onAuthStateChange((_e, session)=>{ user = session?.user || null; onAuthUI(); });

async function upsertProfileFromAuth(){
  const u = (await sb.auth.getUser()).data.user;
  const name = u?.user_metadata?.user_name || u?.user_metadata?.name || 'User';
  const avatar = u?.user_metadata?.avatar_url || `https://avatars.githubusercontent.com/u/0?v=4`;
  await sb.from('profiles').upsert({ id:u.id, display_name:name, avatar_url:avatar }, { onConflict:'id' });
}

// db: avoid FK-dependent joins; fetch profiles separately
async function listCommentsWithProfiles(threadId){
  const { data: rows, error } = await sb.from('comments')
    .select('id, thread_id, user_id, parent_id, content, created_at')
    .eq('thread_id', threadId)
    .order('created_at', { ascending: true });
  if(error){ console.error('listComments', error); return []; }

  const userIds = [...new Set(rows.map(r=>r.user_id))];
  let profiles = [];
  if(userIds.length){
    const { data: pf } = await sb.from('profiles').select('id, display_name, avatar_url').in('id', userIds);
    profiles = pf || [];
  }
  const profMap = new Map(profiles.map(p => [p.id, p]));

  // reactions for these comments
  const ids = rows.map(r=>r.id);
  let reacts = [];
  if(ids.length){
    const { data: rc } = await sb.from('reactions').select('comment_id, user_id, emoji').in('comment_id', ids);
    reacts = rc || [];
  }
  const reactMap = new Map(ids.map(id => [id, []]));
  reacts.forEach(r => { if(!reactMap.has(r.comment_id)) reactMap.set(r.comment_id, []); reactMap.get(r.comment_id).push(r); });

  return rows.map(r => ({
    ...r,
    profiles: profMap.get(r.user_id) || null,
    reactions: reactMap.get(r.id) || []
  }));
}

async function listLikes(threadId){
  const { count } = await sb.from('likes').select('*', { count:'exact', head:true }).eq('thread_id', threadId);
  return count || 0;
}
async function myLiked(threadId){
  if(!user) return false;
  const { data } = await sb.from('likes').select('thread_id').eq('thread_id', threadId).eq('user_id', user.id).maybeSingle();
  return !!data;
}
async function toggleLike(threadId, btn, countEl){
  if(!user){ return $$("#loginBtn").click(); }
  const liked = await myLiked(threadId);
  if(liked){
    await sb.from('likes').delete().eq('thread_id', threadId).eq('user_id', user.id);
  }else{
    await sb.from('likes').upsert({ thread_id: threadId, user_id: user.id }, { onConflict: 'thread_id,user_id' });
  }
  const c = await listLikes(threadId);
  countEl.textContent = c;
  btn.classList.toggle('active', !liked);
}

// render helpers
function nestComments(rows){
  const byId = new Map(); rows.forEach(r=>{ byId.set(r.id, {...r, replies:[]}); });
  const roots=[];
  rows.forEach(r=>{
    const node = byId.get(r.id);
    if(r.parent_id && byId.get(r.parent_id)) byId.get(r.parent_id).replies.push(node);
    else roots.push(node);
  });
  return roots;
}
function fmtTime(s){ try{ return new Date(s).toLocaleString('vi-VN'); }catch(e){ return s; } }
function countEmoji(reactions, emoji){ if(!Array.isArray(reactions)) return 0; return reactions.filter(r => r.emoji === emoji).length; }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }



function commentNode(c, threadId){
  const el = document.createElement('div'); el.className='comment'; el.dataset.id=c.id; el.id = 'cmt-'+c.id;
  const name = c.profiles?.display_name || (c.user_id?.slice(0,6)+'‚Ä¶');
  const avatar = c.profiles?.avatar_url || 'https://avatars.githubusercontent.com/u/0?v=4';
  const myEmojis = new Set((c.reactions||[]).filter(r=> r.user_id===user?.id).map(r=> r.emoji));
  const cnt = (emoji)=> (Array.isArray(c.reactions)? c.reactions.filter(r=> r.emoji===emoji).length:0);
  el.innerHTML = `
    <div class="head">
      <img src="${avatar}" alt="" style="width:28px;height:28px;border-radius:50%;border:1px solid var(--bd)">
      <div class="name">${name}</div>
      <div class="time">¬∑ ${fmtTime(c.created_at)}</div>
    </div>
    <div class="body">${escapeHtml(c.content)}</div>
     <div class="actions react-row">
      <span class="reply">Tr·∫£ l·ªùi</span>
      <button class="react-btn ${myEmojis.has('üòÇ')?'active':''}" data-emoji="üòÇ" aria-label="Haha">
        <span class="emoji">üòÇ</span><span class="count">${cnt('üòÇ')}</span>
      </button>
      <button class="react-btn ${myEmojis.has('üò¢')?'active':''}" data-emoji="üò¢" aria-label="Bu·ªìn">
        <span class="emoji">üò¢</span><span class="count">${cnt('üò¢')}</span>
      </button>
      <button class="react-btn ${myEmojis.has('‚ù§Ô∏è')?'active':''}" data-emoji="‚ù§Ô∏è" aria-label="Tim">
        <span class="emoji">‚ù§Ô∏è</span><span class="count">${cnt('‚ù§Ô∏è')}</span>
      </button>
    </div>
     ${ (c.replies && c.replies.length>0) ? `<button class=\"toggle-replies\" aria-expanded=\"false\">reply</button>` : '' }
    <div class="reply-box hidden">
      <textarea rows="2" placeholder="Ph·∫£n h·ªìi‚Ä¶"></textarea>
      <button class="btn icon-btn send-reply" aria-label="G·ª≠i"><svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18"><path d="M3.4 11.2l16.7-7.3c.9-.4 1.8.5 1.4 1.4l-7.3 16.7c-.4 1-1.8 1-2.2 0l-2.5-5.4-5.4-2.5c-1-.4-1-1.8 0-2.2zM9.7 14.3l3.9 3.9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    </div>
    <div class="replies"></div>
  `;
  el.querySelectorAll('.react-btn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const emoji = btn.dataset.emoji;
      await toggleReaction(c.id, emoji);
      const ctr = el.closest('#sb-page') ? $$('#sb-page') : $$('#aggCard');
      const th = el.closest('#sb-page') ? pageThread : chapThread;
      await renderThread(ctr, th);
    }, { passive:false });
  });
  el.querySelector('.reply').addEventListener('click', ()=>{
    el.querySelector('.reply-box').classList.toggle('hidden');
  });
  el.querySelector('.send-reply').addEventListener('click', async ()=>{
    if(!user){ return $$('#loginBtn').click(); }
    const t = el.querySelector('.reply-box textarea');
    const content = t.value.trim(); if(!content) return;
    await sb.from('comments').insert({ thread_id:threadId, content, parent_id:c.id, user_id:user.id });
    t.value=''; el.querySelector('.reply-box').classList.add('hidden');
  });

  // menu toggle
  const moreBtn = el.querySelector('.more-btn');
  const menu = el.querySelector('.cmt-menu');
  if(moreBtn){
    moreBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const open = menu.classList.toggle('open');
      moreBtn.setAttribute('aria-expanded', String(open));
    });
    // close on outside click
    document.addEventListener('click', (e)=>{
      if(menu.classList.contains('open') && !el.contains(e.target)){ menu.classList.remove('open'); moreBtn.setAttribute('aria-expanded','false'); }
    });
  }
  // delete
  const delBtn = el.querySelector('.del-btn');
  if(delBtn){
    delBtn.addEventListener('click', async ()=>{
      menu.classList.remove('open');
      if(!user || user.id !== c.user_id){ return alert('H√¥ng ƒë·ªß quy·ªÅn x√≥a cmt n√†y.'); }
      if(!confirm('X√≥a b√¨nh lu·∫≠n n√†y?')) return;
      const { error } = await sb.from('comments').delete().eq('id', c.id).eq('user_id', user.id);
      if(error){ console.error(error); alert('X√≥a kh√¥ng th√†nh c√¥ng.'); return; }
      // remove from DOM optimistically
      const self = document.getElementById('cmt-'+c.id);
      if(self) self.remove();
    });
  }
  // edit
  const editBtn = el.querySelector('.edit-btn');
  if(editBtn){
    const editRow = el.querySelector('.edit-row');
    const editArea = el.querySelector('.edit-area');
    editBtn.addEventListener('click', ()=>{
      menu.classList.remove('open');
      if(!user || user.id !== c.user_id){ return alert('H√¥ng ƒë·ªß quy·ªÅn s·ª≠a cmt n√†y.'); }
      el.classList.add('editing');
      editArea.value = c.content;
      editArea.focus();
    });
    el.querySelector('.cancel-edit').addEventListener('click', ()=>{
      el.classList.remove('editing');
    });
    el.querySelector('.save-edit').addEventListener('click', async ()=>{
      const newContent = editArea.value.trim();
      if(!newContent) return alert('N·ªôi dung tr·ªëng r√πi.');
      const { error } = await sb.from('comments').update({ content: newContent }).eq('id', c.id).eq('user_id', user.id);
      if(error){ console.error(error); alert('S·ª≠a kh√¥ng th√†nh c√¥ng.'); return; }
      // update UI inline
      const body = el.querySelector('.body');
      if(body) body.textContent = newContent;
      el.classList.remove('editing');
    });
  }

  const repliesEl = el.querySelector('.replies');
  const toggleBtn = el.querySelector('.toggle-replies');
  if(toggleBtn){ repliesEl.classList.add('collapsed'); toggleBtn.addEventListener('click', ()=>{ const collapsed = repliesEl.classList.toggle('collapsed'); toggleBtn.setAttribute('aria-expanded', String(!collapsed)); }); }
  c.replies.forEach(r=> repliesEl.appendChild(commentNode(r, threadId)));
  return el;
}



async function renderThread(container, thread){
  const likeBtn = container.querySelector('.like-btn');
  const likeCountEl = container.querySelector('[id$="like-count"]');
  const listEl = container.querySelector('[id$="-list"]');
  const emptyEl = container.querySelector('[id$="-empty"]');

  if(!thread){
    likeCountEl.textContent = 0;
    listEl.innerHTML = "";
    show(emptyEl, true);
    likeBtn.onclick = null;
    return;
  }
  show(emptyEl, false);

  likeCountEl.textContent = await listLikes(thread.id);
  likeBtn.classList.toggle('active', await myLiked(thread.id));
  likeBtn.onclick = ()=> toggleLike(thread.id, likeBtn, likeCountEl);

  // Preserve scroll to avoid jumps
  const prevScroll = listEl.scrollTop;
  listEl.innerHTML = '<div class="meta">ƒêang t·∫£i b√¨nh lu·∫≠n‚Ä¶</div>';
  const rows = await listCommentsWithProfiles(thread.id);
  listEl.innerHTML = '';
  nestComments(rows).forEach(c=> listEl.appendChild(commentNode(c, thread.id)));
  listEl.scrollTop = prevScroll;

  const input = container.querySelector('[id$="-input"]');
  const send = container.querySelector('[id$="-send"]');
  send.onclick = async ()=>{
    if(!user){ return $$("#loginBtn").click(); }
    const content = input.value.trim(); if(!content) return;
    await sb.from('comments').insert({ thread_id:thread.id, content, parent_id:null, user_id:user.id });
    input.value='';
  };

  // realtime with scroll preservation
  const channel = sb.channel('realtime:'+thread.id);
  channel
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'comments', filter:`thread_id=eq.${thread.id}` },
      async () => {
        const prev = listEl.scrollTop;
        const rows = await listCommentsWithProfiles(thread.id);
        listEl.innerHTML = '';
        nestComments(rows).forEach(c=> listEl.appendChild(commentNode(c, thread.id)));
        listEl.scrollTop = prev; // keep position
      })
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'reactions' },
      async () => {
        const prev = listEl.scrollTop;
        const rows = await listCommentsWithProfiles(thread.id);
        listEl.innerHTML = '';
        nestComments(rows).forEach(c=> listEl.appendChild(commentNode(c, thread.id)));
        listEl.scrollTop = prev;
      })
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'likes', filter:`thread_id=eq.${thread.id}` },
      () => { listLikes(thread.id).then(c => likeCountEl.textContent = c); })
    .on('postgres_changes', { event:'DELETE', schema:'public', table:'likes', filter:`thread_id=eq.${thread.id}` },
      () => { listLikes(thread.id).then(c => likeCountEl.textContent = c); })
    .subscribe();
}


// threads: fetch by key, and create only if logged-in and missing
async function getOrCreateThread(type, key, opts={ createIfMissing: true }){
  const createIfMissing = opts && opts.createIfMissing !== undefined ? opts.createIfMissing : true;
  // try to read existing
  let { data: row } = await sb.from('threads').select('id,type,key').eq('key', key).maybeSingle();
  if(row) return row;
  // if not found and we're allowed to create and user is logged-in
  if(createIfMissing && user){
    const { data, error } = await sb.from('threads').insert({ type, key }).select().single();
    if(!error) return data;
  }
  // otherwise return null so UI can still render in read-only
  return null;
}
// chapters
function getHash(){ return decodeURIComponent(location.hash.replace(/^#/,'')) }
function fileName(ch, i, ext){ return `C${ch} (${i}).${ext}` }
function imgOk(url){ return new Promise((resolve)=>{ const img=new Image(); img.onload=()=>resolve(true); img.onerror=()=>resolve(false); img.src=url; }); }
let CHAP_EXT_CACHE = new Map();
async function pickExtForChapter(chPath, ch){
  if(CHAP_EXT_CACHE.has(ch)) return CHAP_EXT_CACHE.get(ch);
  // probe first page only
  for(const ext of EXTS){
    const url = `${chPath}/${encodeURIComponent(fileName(ch,1,ext))}`;
    if(await imgOk(url)){ CHAP_EXT_CACHE.set(ch, ext); return ext; }
  }
  CHAP_EXT_CACHE.set(ch, null);
  return null;
}
async function findExistingUrl(chPath, ch, i){
  // if chapter has a known ext -> try that first to cut 404 noise
  const known = CHAP_EXT_CACHE.get(ch);
  if(known){
    const url = `${chPath}/${encodeURIComponent(fileName(ch,i,known))}`;
    if(await imgOk(url)) return url;
  }
  for(const ext of EXTS){
    const url = `${chPath}/${encodeURIComponent(fileName(ch,i,ext))}`;
    if(await imgOk(url)){ CHAP_EXT_CACHE.set(ch, ext); return url; }
  }
  return null;
}
async function chapExists(n){ return await findExistingUrl(`chapters/chap-${n}`, n, 1) !== null; }
async function buildChaptersAuto(){ const cs=[]; for(let i=1;i<=999;i++){ if(!(await chapExists(i))) break; cs.push({ id:`chap-${i}`, index:i, title:`Chap ${i}`, path:`chapters/chap-${i}` }); } return cs; }
function populateSelect(id){ const sel=document.getElementById(id); sel.innerHTML=''; CHAPTERS.forEach(ch=>{ const o=document.createElement('option'); o.value=ch.id; o.textContent=ch.title; sel.appendChild(o); }); sel.addEventListener('change', ()=> location.hash = sel.value); }
function neighborChapter(id, dir){ const idx=CHAPTERS.findIndex(c=>c.id===id); const nx=CHAPTERS[idx+dir]; return nx?nx.id:null; }
function route(){ const h=getHash()||'home'; if(h==='home'){ document.getElementById('homeView').style.display='grid'; document.getElementById('readerView').style.display='none'; } else { const ch=CHAPTERS.find(c=>c.id===h) || CHAPTERS[0]; renderChapter(ch); } }

async function renderChapter(ch){
  document.getElementById('homeView').style.display='none'; document.getElementById('readerView').style.display='block'; currentChapter=ch;
  document.getElementById('chapTitle').textContent = `${SERIES_TITLE} ‚Äî ${ch.title}`;
  ['Top','Mid','Bottom'].forEach(pos=>{ const sel=document.getElementById('chapterSel'+pos); if(sel) sel.value=ch.id; });
  const viewer=document.getElementById('viewer'); viewer.innerHTML='';
  // warm ext cache for this chapter
  await pickExtForChapter(ch.path, ch.index);
  let missing=0;
  for(let i=1;i<=2000;i++){
    const url = await findExistingUrl(ch.path, ch.index, i);
    if(!url){ missing++; if(missing>=3 || i===1) break; continue; }
    missing=0;
    const wrap=document.createElement('div'); wrap.className='page-wrap'; wrap.setAttribute('data-page', i);
const img=document.createElement('img'); img.src=url; img.className='page'; img.loading='lazy'; img.alt=`${ch.title} ‚Äî trang ${i}`; img.dataset.page=i;
img.addEventListener('click', ()=> openMini(i));
const dot=document.createElement('span'); dot.className='cmt-dot'; dot.title='C√≥ b√¨nh lu·∫≠n'; wrap.appendChild(img); wrap.appendChild(dot); viewer.appendChild(wrap);
  }
  const prevId=neighborChapter(ch.id,-1), nextId=neighborChapter(ch.id,1);
  document.getElementById('prevTop').onclick = ()=> prevId && (location.hash=prevId);
  document.getElementById('nextTop').onclick = ()=> nextId && (location.hash=nextId);
  document.getElementById('prevBottom').onclick = ()=> prevId && (location.hash=prevId);
  document.getElementById('nextBottom').onclick = ()=> nextId && (location.hash=nextId);


  // mark pages that have comments with small bubbles
  try{
    const { data: ths } = await sb.from('threads').select('id,key').eq('type','page').like('key', `page:${ch.index}-%`);
    const ids = (ths||[]).map(t=> t.id);
    const counts = new Map();
    if(ids.length){
      const { data: cmts } = await sb.from('comments').select('id,thread_id').in('thread_id', ids);
      (cmts||[]).forEach(c=> counts.set(c.thread_id, 1 + (counts.get(c.thread_id)||0)));
    }
    (ths||[]).forEach(t=>{
      const m = t.key.match(/^page:(\d+)-(\d+)$/); if(!m) return;
      const p = Number(m[2]);
      const wrap = document.querySelector(`.page-wrap[data-page="${p}"]`);
      if(!wrap) return;
      const has = (counts.get(t.id)||0) > 0;
      wrap.classList.toggle('has-cmt', has);
      const dot = wrap.querySelector('.cmt-dot');
      if(dot) dot.title = has ? 'C√≥ b√¨nh lu·∫≠n' : '';
    });
  }catch(e){ console.warn('mark pages bubble failed', e); }
  // build/display comments without auto scroll to top
  chapThread = await getOrCreateThread('chap', `chap:${ch.index}`);
  await renderThread(document.getElementById('aggCard'), chapThread);
}

async function openMini(pageIndex){
  currentPageForPanel = pageIndex;
  $$("#backdrop").classList.add("open");
  const mini = $$("#miniPanel"); mini.classList.add("open"); mini.setAttribute("aria-hidden","false");
  document.querySelector('#sb-page .thread-head .title').textContent = `B√¨nh lu·∫≠n - #${pageIndex}`;
  pageThread = await getOrCreateThread('page', `page:${currentChapter.index}-${pageIndex}`);
  await renderThread($$("#sb-page"), pageThread);
}
function closeMini(){ $$("#backdrop").classList.remove("open"); const mini=$$("#miniPanel"); mini.classList.remove("open"); mini.setAttribute("aria-hidden","true"); }

document.addEventListener('click', (e)=>{
  // clicking backdrop closes both mini and notif
  const b = document.getElementById('backdrop');
  if(e.target === b){ closeMini(); closeNotifPanel(); }
});
const notifCloseBtn = document.getElementById('notifClose');
if(notifCloseBtn){ notifCloseBtn.addEventListener('click', closeNotifPanel); }


// init
(async function init(){
  await ensureAuth();
  CHAPTERS = await buildChaptersAuto();
  function buildTOC(containerId){ const box=document.querySelector(containerId); box.innerHTML=''; CHAPTERS.forEach(ch=>{ const a=document.createElement('a'); a.href=`#${ch.id}`; a.textContent=ch.title; a.className='btn'; a.addEventListener('click',(e)=>{ e.preventDefault(); location.hash=ch.id; }); box.appendChild(a); }); }
  buildTOC('#homeTOC');
  ['chapterSelTop','chapterSelMid','chapterSelBottom'].forEach(populateSelect);
  document.querySelector('#fitSel').addEventListener('change', ()=>{
    document.querySelectorAll('.page').forEach(img=>{
      const mode=document.querySelector('#fitSel').value;
      if(mode==='fit'){ img.style.width='100%'; img.style.maxWidth='100%'; }
      else{ img.style.width='auto'; img.style.maxWidth='none'; }
    });
  });
  window.addEventListener('hashchange', route);
  route();
})();
</script>
</body>
</html>
