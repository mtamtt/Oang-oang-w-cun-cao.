<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OƒÉng oƒÉng w c√∫n c√°o ‚Äî ƒê·ªçc truy·ªán</title>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b0d10;--fg:#e6e8eb;--muted:#98a1b3;--card:#0f1216;--bd:#1a1f29;--accent:#f59e0b;--pink:#ec4899;--green:#22c55e}
    *{box-sizing:border-box} html,body{margin:0;padding:0;height:100%}
    body{background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(11,13,16,.98), rgba(11,13,16,.92));border-bottom:1px solid var(--bd);backdrop-filter:saturate(180%) blur(10px)}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .brand{display:flex;align-items:center;gap:4px;font-weight:800}
    .brand svg{height:26px;width:auto;display:block}
    .brand span{font-weight:800;margin-left:6px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);background:var(--card);border-radius:999px}
    select,button,input,textarea{color:var(--fg);background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    input,textarea{width:100%}
    textarea{min-height:88px;resize:vertical}
    .grow{flex:1}
    .grid{display:grid;gap:12px}
    .viewer{display:flex;flex-direction:column;gap:0}
    .page{width:100%;display:block;border:none;background:#0a0c0f;margin-left:auto;margin-right:auto}
    .page-wrap{position:relative}
    /* Badge comment: ƒë·∫∑t ngo√†i r√¨a ·∫£nh, gradient xanh‚Üív√†ng */
    .badge{
      position:absolute;top:10px;right:-12px;transform:translateX(40%);
      background:linear-gradient(135deg,#2dd4bf,#f59e0b);
      border:1px solid rgba(148,163,184,.35);
      border-radius:999px;width:26px;height:26px;display:none;align-items:center;justify-content:center;
      box-shadow:0 8px 18px rgba(0,0,0,.45)
    }
    .badge svg{width:14px;height:14px;color:#0b0d10}
    .card{padding:14px;border:1px solid var(--bd);background:var(--card);border-radius:14px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bd);background:var(--card);cursor:pointer}
    .btn:hover{border-color:#2a3242}
    .btn.small{padding:6px 8px;font-size:14px}
    .toc-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .footer{padding:28px 0;color:var(--muted);text-align:center}
    .nav3{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .nav3 .left{justify-self:start}
    .nav3 .center{justify-self:center}
    .nav3 .right{justify-self:end}
    .meta{color:var(--muted);font-size:13px}

    /* To top */
    #toTopBtn{
      position:fixed;right:18px;bottom:18px;z-index:55;border-radius:999px;width:46px;height:46px;display:none;
      align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.35);
      background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);box-shadow:0 8px 18px rgba(0,0,0,.45);
    }
    #toTopBtn svg{width:22px;height:22px;display:block;color:#e5e7eb}

    /* Mini panel */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:70}
    .backdrop.open{opacity:1;pointer-events:auto}
    .mini{
      position:fixed;z-index:71;right:16px;bottom:70px;border:1px solid var(--bd);background:var(--card);
      border-radius:20px;box-shadow:0 16px 32px rgba(0,0,0,.5);
      width:360px;height:360px;max-width:95vw;max-height:85vh;
      display:flex;flex-direction:column;transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:transform .22s ease,opacity .22s ease;
      overflow:hidden;
    }
    .mini.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
    .mini.min{height:auto}
    .mini-head{display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--bd)}
    .mini-hint{color:var(--muted);font-size:12px;text-align:center}
    .mini-body{flex:1;overflow:auto;padding:8px;-webkit-overflow-scrolling:touch}
    .mini-composer{display:flex;gap:8px;align-items:center;margin-top:8px}
    .mini-composer input{flex:1}
    .cmt-item{border-top:1px dashed #223; padding:8px 6px}
    .cmt-meta{color:#9fb0c0; font-size:12px; margin-bottom:4px}
    .cmt-body{white-space:pre-wrap}
    .cmt-actions{display:flex;gap:8px;margin-top:6px}
    .cmt-actions .danger{border-color:#7f1d1d;color:#fca5a5}

    @media (max-width:640px){
      .mini{width:320px;height:320px;right:12px;bottom:64px}
    }

    /* Heart */
    .heart{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--bd);background:var(--card);}
    .heart svg{width:18px;height:18px;display:block}
    .heart.active{border-color:rgba(236,72,153,.35);background:linear-gradient(135deg,rgba(236,72,153,.12),rgba(236,72,153,.04))}
    .heart .filled{display:none;color:var(--pink)}
    .heart.active .filled{display:inline}
    .heart.active .outline{display:none}

    .note{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <!-- icon c√∫n -->
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <path d="M14 20 q10-10 18 0" stroke="#FFE0B2" stroke-width="6" fill="none" stroke-linecap="round"/>
          <circle cx="26" cy="34" r="3" fill="#0f172a"/><circle cx="38" cy="34" r="3" fill="#0f172a"/>
          <path d="M28 42 q6 4 12 0" stroke="#0f172a" stroke-width="2" fill="none" stroke-linecap="round"/>
        </svg>
        <!-- icon c√°o -->
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <path d="M18 22 L26 10 L30 26 Z" fill="#FF7A3D"/><path d="M46 22 L38 10 L34 26 Z" fill="#FF7A3D"/>
          <path d="M20 36 Q32 46 44 36 Q32 32 20 36 Z" fill="#fff"/>
          <circle cx="28" cy="32" r="2.2" fill="#0f172a"/><circle cx="36" cy="32" r="2.2" fill="#0f172a"/>
        </svg>
        <span>OƒÉng oƒÉng w c√∫n c√°o</span>
      </div>

      <a href="#home" id="homeBtn" class="btn">üè† Trang ch·ªß</a>

      <div class="pill">
        <label for="chapterSelTop">M·ª•c l·ª•c</label>
        <select id="chapterSelTop"></select>
      </div>

      <div class="pill">
        <label for="fitSel">Hi·ªÉn th·ªã</label>
        <select id="fitSel">
          <option value="fit">V·ª´a khung</option>
          <option value="full">K√≠ch th∆∞·ªõc g·ªëc</option>
        </select>
      </div>

      <div class="grow"></div>

      <button id="authBtn" class="btn">ü¶ä ƒêƒÉng nh·∫≠p GitHub</button>
      <div class="meta">Ph√≠m t·∫Øt: <b>B</b> ƒë√≥ng cmt ¬∑ <b>G</b> l√™n ƒë·∫ßu</div>
    </div>
  </header>

  <!-- Mini comment panel + backdrop -->
  <div id="backdrop" class="backdrop"></div>
  <aside id="miniPanel" class="mini" aria-hidden="true">
    <div class="mini-head">
      <div id="panelTitle" style="font-weight:700">B√¨nh lu·∫≠n</div>
      <div class="mini-hint">Vu·ªët tr√°i ‚Üí ph·∫£i ƒë·ªÉ ƒë√≥ng ¬∑ nh·∫•n <b>B</b></div>
      <button class="btn small" id="miniToggle">Thu g·ªçn</button>
      <button class="btn small" id="miniClose">ƒê√≥ng</button>
    </div>
    <div class="mini-body" id="miniBody">
      <div id="panelList"></div>
      <div class="card" style="margin-top:8px" id="panelComposer">
        <div style="font-weight:600;margin-bottom:6px">Vi·∫øt b√¨nh lu·∫≠n cho trang n√†y</div>
        <input id="panelName" placeholder="T√™n (ƒë·ªÉ tr·ªëng = ·∫®n danh)"/>
        <textarea id="panelBody" placeholder="N·ªôi dung b√¨nh lu·∫≠n..."></textarea>
        <button id="panelSend" class="btn">G·ª≠i</button>
        <div id="panelMsg" class="meta" style="margin-top:6px"></div>
      </div>
      <div class="mini-composer" id="miniComposer" style="display:none">
        <input id="miniInput" placeholder="B√¨nh lu·∫≠n nhanh‚Ä¶">
        <button class="btn small" id="miniSend" title="G·ª≠i">üì§</button>
      </div>
    </div>
  </aside>

  <!-- To top -->
  <button id="toTopBtn" aria-label="L√™n ƒë·∫ßu chap" title="L√™n ƒë·∫ßu chap">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M18 15l-6-6-6 6"/>
    </svg>
  </button>

  <main class="wrap grid">
    <!-- HOME -->
    <section id="homeView" class="grid">
      <div class="card"><div style="font-weight:700;margin-bottom:6px">C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)</div></div>
      <div class="grid" style="grid-template-columns: 280px 1fr;gap:16px;align-items:start">
        <div class="card">
          <img id="coverImg" alt="cover" style="width:100%;border-radius:10px;border:1px solid var(--bd);background:#0a0c0f"
               src="assets/cover.jpg" onerror="this.onerror=null; this.src='assets/Cover.jpg';">
        </div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:10px">M·ª•c l·ª•c</div>
          <div id="homeTOC" class="toc-list"></div>
        </div>
      </div>
    </section>

    <!-- READER -->
    <section id="readerView" style="display:none">
      <div class="card"><div id="chapTitle" style="font-weight:700">...</div></div>

      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevTop">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center"><label for="chapterSelMid" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label><select id="chapterSelMid"></select></div>
          <div class="right"><button class="btn" id="nextTop">Chap sau ‚ü∂</button></div>
        </div>
      </div>

      <div id="viewer" class="viewer"></div>

      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevBottom">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center"><label for="chapterSelBottom" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label><select id="chapterSelBottom"></select></div>
          <div class="right"><button class="btn" id="nextBottom">Chap sau ‚ü∂</button></div>
        </div>
      </div>

      <!-- Aggregated chapter comments (mixed) -->
      <div class="card" id="aggCard">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">B√¨nh lu·∫≠n chap</div>
          <div class="row">
            <button id="heartBtn" class="heart" title="Th·∫£ tim chap (ƒë·ªìng b·ªô)">
              <svg class="outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1L12 21l7.8-7.6 1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
              <svg class="filled" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21s-6.716-4.79-9.193-7.267c-2.477-2.477-2.477-6.492 0-8.97 2.343-2.343 6.143-2.343 8.485 0L12 5.47l.708-.708c2.343-2.343 6.143-2.343 8.485 0 2.477 2.478 2.477 6.493 0 8.97C18.716 16.21 12 21 12 21z"/></svg>
              <span id="heartLabel">Th·∫£ tim</span>
            </button>
            <span id="heartNote" class="note"></span>
          </div>
        </div>

        <div class="row" style="justify-content:space-between;margin:8px 0 4px">
          <div style="font-weight:600">Vi·∫øt b√¨nh lu·∫≠n (ƒëƒÉng nh·∫≠p GH ho·∫∑c ·∫©n danh)</div>
          <div>
            <label class="meta">S·∫Øp x·∫øp:</label>
            <select id="sortSel" class="small">
              <option value="new">M·ªõi nh·∫•t</option>
              <option value="old">C≈© nh·∫•t</option>
            </select>
          </div>
        </div>

        <div class="card" style="margin-bottom:10px">
          <textarea id="chapBody" placeholder="N·ªôi dung b√¨nh lu·∫≠n cho c·∫£ chap..."></textarea>
          <button id="chapSend" class="btn">G·ª≠i</button>
          <div id="chapMsg" class="meta" style="margin-top:6px"></div>
        </div>

        <div id="aggMixed"></div>
        <button id="moreMixed" class="btn small" style="margin-top:6px;display:none">Xem th√™m</button>
      </div>
    </section>

    <div class="footer">Comments: GitHub login (tu·ª≥ ch·ªçn) ‚Ä¢ ·∫®n danh ·ªïn ƒë·ªãnh ‚Ä¢ Reply ‚Ä¢ Reactions ‚Ä¢ Tim ƒë·ªìng b·ªô.</div>
  </main>

<script>
/** ========= CONFIG ========= **/
const SERIES_TITLE = "C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)";
const MAX_CHAPTERS_GUESS = 999;
const MAX_PAGES_GUESS = 2000;
/* nh·∫≠n c·∫£ vi·∫øt hoa */
const EXTS = ["jpg","jpeg","png","gif","webp","JPG","JPEG","PNG","GIF","WEBP"];

/* Supabase c·ªßa m */
const SUPABASE_URL = "https://kmhypppsljaxvqnnfxfa.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttaHlwcHBzbGpheHZxbm5meGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzUyODgsImV4cCI6MjA3MDUxMTI4OH0.XtcNReQ7J8B9KThtKsaAJ2XXbWwnZat3LVF2y4LMZh4";

/** ========= DB & HELPERS ========= **/
let sb = null, currentUser = null;
function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)); }
const deviceToken = (()=>{
  let t = localStorage.getItem('device_token');
  if(!t){ t = uuid(); localStorage.setItem('device_token', t); }
  return t;
})();
function esc(s){ return (s||"").replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])) }
function now(){ return Math.floor(Date.now()/1000) }
const $ = (q, el=document)=>el.querySelector(q);

/* t√™n m·∫´u h·ª£p l·ªá */
function candidateNames(ch,i){
  return [
    `C${ch} (${i})`, // b·∫£n c≈©
    `C${ch}-#${i}`,  // b·∫£n m·ªõi
    `C${ch}-${i}`,
    `C${ch}_${i}`,
    `C${ch} ${i}`,
    `C${ch}.${i}`
  ];
}
function fileUrlFromName(chPath,name,ext){ return `${chPath}/${encodeURIComponent(`${name}.${ext}`)}` }
function imgOk(url){ return new Promise(r=>{ const im=new Image(); im.onload=()=>r(true); im.onerror=()=>r(false); im.src=url; }) }
async function findExistingUrl(chPath,ch,i){
  for(const name of candidateNames(ch,i)){
    for(const ext of EXTS){
      const url=fileUrlFromName(chPath,name,ext);
      if(await imgOk(url)) return url;
    }
  }
  return null;
}
async function chapExists(n){ return await findExistingUrl(`chapters/chap-${n}`, n, 1)!==null; }
async function buildChaptersAuto(){
  const chapters=[];
  for(let i=1;i<=MAX_CHAPTERS_GUESS;i++){
    if(!(await chapExists(i))) break;
    chapters.push({ id:`chap-${i}`, index:i, title:`Chap ${i}`, path:`chapters/chap-${i}` });
  }
  return chapters;
}

/** ======== Supabase ======== **/
let demoMode=false;
function initDB(){
  if(window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY){
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true} });
  } else demoMode=true;
}
async function getUser(){
  if(!sb) return null;
  const { data:{ user } } = await sb.auth.getUser();
  currentUser = user; return user;
}
async function loginGithub(){
  if(!sb) return;
  await sb.auth.signInWithOAuth({ provider:"github" });
}
async function logout(){
  if(!sb) return;
  await sb.auth.signOut(); currentUser=null; updateAuthBtn();
}
function anonName(){
  let id = localStorage.getItem('anon_idx');
  if(!id){ id = String(Math.floor(Math.random()*9000)+1000); localStorage.setItem('anon_idx', id); }
  return `·∫®n danh ${id}`;
}
function currentDisplayName(){
  if(currentUser){
    return currentUser.user_metadata?.user_name || currentUser.email?.split("@")[0] || "GitHub user";
  }
  return anonName();
}
function updateAuthBtn(){
  const btn = $('#authBtn');
  if(currentUser){
    btn.textContent = `üëã ${currentDisplayName()} (ƒêƒÉng xu·∫•t)`;
    btn.onclick = logout;
  }else{
    btn.textContent = 'ü¶ä ƒêƒÉng nh·∫≠p GitHub';
    btn.onclick = loginGithub;
  }
}

/** ======== API: comments/hearts (y√™u c·∫ßu schema ƒë√£ import) ======== **/
async function cmt_add({chapter,page,name,body,edit_token}){
  const { data, error } = await sb.rpc('comment_add',{ p_chapter:chapter, p_page:page, p_name:name, p_body:body, p_edit_token:edit_token });
  if(error) throw error; return data;
}
async function cmt_edit({id, body, edit_token}){
  const { error } = await sb.rpc('comment_edit',{ p_id:id, p_edit_token:edit_token, p_body:body });
  if(error) throw error; return true;
}
async function cmt_delete({id, edit_token}){
  const { error } = await sb.rpc('comment_delete',{ p_id:id, p_edit_token:edit_token });
  if(error) throw error; return true;
}
async function cmt_fetch(chapter){
  const { data, error } = await sb.from('comments').select('*').eq('chapter',chapter).order('created_at',{ascending:false});
  if(error) throw error; return data||[];
}
async function heart_toggle({chapter}){
  const { data, error } = await sb.rpc('toggle_heart',{ p_chapter:chapter, p_device:deviceToken });
  if(error) throw error; return data;
}
async function heart_get({chapter}){
  const { data, error } = await sb.rpc('get_heart',{ p_chapter:chapter, p_device:deviceToken });
  if(error) throw error; return data;
}

/** ====== STATE ====== **/
let CHAPTERS=[];
let currentChapter=null;
let currentPageForPanel=null;
let commentsCache=[];
let pagesWithComments=new Set();
let mixedLimit=20;

/** ====== PANEL ====== **/
function renderListInto(el, items){
  el.innerHTML = items.map(it=>{
    const who = it.name?.trim() ? esc(it.name) : "·∫®n danh";
    const when = new Date(it.created_at).toLocaleString();
    const owner = localStorage.getItem('cmt_token_'+it.id) === it.edit_token;
    return `<div class="cmt-item" data-id="${it.id}">
      <div class="cmt-meta"><b>${who}</b> ‚Äî #${it.page} ¬∑ <span>${esc(when)}</span></div>
      <div class="cmt-body" data-body>${esc(it.body)}</div>
      ${owner ? `<div class="cmt-actions">
          <button class="btn small" data-act="edit">S·ª≠a</button>
          <button class="btn small danger" data-act="del">Xo√°</button>
        </div>` : ``}
    </div>`;
  }).join('') || '<div class="meta">Ch∆∞a c√≥ b√¨nh lu·∫≠n cho trang n√†y.</div>';

  el.querySelectorAll('[data-act="edit"]').forEach(btn=>{
    btn.onclick = async ()=>{
      const wrap = btn.closest('.cmt-item'); const id = wrap.dataset.id;
      const bodyEl = wrap.querySelector('[data-body]');
      const old = bodyEl.textContent;
      const ta = document.createElement('textarea'); ta.value = old; ta.style.width='100%';
      bodyEl.replaceWith(ta);
      btn.textContent='L∆∞u';
      btn.onclick = async ()=>{
        const token = localStorage.getItem('cmt_token_'+id);
        try{
          await cmt_edit({ id, body: ta.value.trim(), edit_token: token });
          const obj = commentsCache.find(c=>c.id===id); if(obj) obj.body = ta.value.trim();
          await openMini(currentPageForPanel);
          await renderAggregated(currentChapter);
        }catch(e){ alert('L·ªói s·ª≠a: '+(e.message||e)); }
      };
    };
  });
  el.querySelectorAll('[data-act="del"]').forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm('Xo√° b√¨nh lu·∫≠n n√†y?')) return;
      const wrap = btn.closest('.cmt-item'); const id = wrap.dataset.id;
      const token = localStorage.getItem('cmt_token_'+id);
      try{
        await cmt_delete({ id, edit_token: token });
        commentsCache = commentsCache.filter(c=>c.id!==id);
        await openMini(currentPageForPanel);
        await renderAggregated(currentChapter);
      }catch(e){ alert('L·ªói xo√°: '+(e.message||e)); }
    };
  });
}

async function openMini(pageIndex){
  currentPageForPanel = pageIndex;
  $('#panelTitle').textContent = `B√¨nh lu·∫≠n ‚Äî #${pageIndex}`;
  $('#panelBody').value = '';
  $('#panelName').value = currentUser ? currentDisplayName() : '';
  $('#panelMsg').textContent = '';

  const list = commentsCache.filter(c=> c.page === pageIndex);
  renderListInto($('#panelList'), list);

  $('#backdrop').classList.add('open');
  $('#miniPanel').classList.add('open');
  $('#miniPanel').setAttribute('aria-hidden','false');
}
function closeMini(){
  $('#backdrop').classList.remove('open');
  $('#miniPanel').classList.remove('open');
  $('#miniPanel').setAttribute('aria-hidden','true');
}
$('#miniClose').addEventListener('click', closeMini);
$('#backdrop').addEventListener('click', closeMini);
document.addEventListener('keydown',(e)=>{
  if(e.key==='b'||e.key==='B') closeMini();
  if(e.key==='g'||e.key==='G') window.scrollTo({top:0,behavior:'smooth'});
});
(function enableSwipeClose(){
  const mini=$('#miniPanel'); let sx=0,sy=0,moving=false;
  mini.addEventListener('touchstart',e=>{const t=e.changedTouches[0];sx=t.clientX;sy=t.clientY;moving=false},{passive:true});
  mini.addEventListener('touchmove',e=>{const t=e.changedTouches[0];const dx=t.clientX-sx;const dy=Math.abs(t.clientY-sy);if(Math.abs(dx)>20&&dy<25)moving=true},{passive:true});
  mini.addEventListener('touchend',e=>{const t=e.changedTouches[0];const dx=t.clientX-sx;const dy=Math.abs(t.clientY-sy);if(moving&&dx>70&&dy<40)closeMini()},{passive:true});
})();
$('#miniToggle').addEventListener('click',()=>{
  const mini=$('#miniPanel'), body=$('#miniBody'), comp=$('#panelComposer'), miniComp=$('#miniComposer');
  if(mini.classList.contains('min')){ mini.classList.remove('min'); body.style.display='block'; miniComp.style.display='none'; comp.style.display='block'; }
  else{ mini.classList.add('min'); body.style.display='block'; miniComp.style.display='flex'; comp.style.display='none'; }
});
$('#miniSend').addEventListener('click',()=>{
  const txt=$('#miniInput').value.trim(); if(!txt) return;
  $('#panelBody').value=txt; $('#miniInput').value=''; $('#panelSend').click();
});

/* cooldown */
function checkCooldown(key){ const last=parseInt(localStorage.getItem(key)||'0',10); const diff=now()-last; return diff<10?10-diff:0 }
function setCooldown(key){ localStorage.setItem(key,String(now())) }

/* g·ª≠i panel */
$('#panelSend').addEventListener('click', async ()=>{
  const name = currentUser ? currentDisplayName() : ($('#panelName').value.trim() || anonName());
  const body = $('#panelBody').value.trim();
  const msg = $('#panelMsg');
  if(!body){ msg.textContent='Ghi g√¨ ƒë√≥ ƒë√£ nha üòÖ'; return; }
  const cd = checkCooldown('cd_page'); if(cd){ msg.textContent='Ch·∫≠m l·∫°i '+cd+'s nha ~'; return; }
  const token = uuid();
  try{
    const row = await cmt_add({ chapter: currentChapter.index, page: currentPageForPanel, name, body, edit_token: token });
    localStorage.setItem('cmt_token_'+row.id, token);
    commentsCache.unshift(row);
    msg.textContent='ƒê√£ g·ª≠i!';
    setCooldown('cd_page');
    await openMini(currentPageForPanel);
    await renderAggregated(currentChapter);
  }catch(e){ msg.textContent='L·ªói g·ª≠i: '+(e.message||e); }
});

/** ====== HEART ====== **/
async function updateHeartUI(ch){
  const s = await heart_get({ chapter: ch.index });
  const btn = $('#heartBtn'), label=$('#heartLabel'), note=$('#heartNote');
  btn.classList.toggle('active', !!s.active);
  label.textContent = s.active ? 'ƒê√£ th·∫£ tim' : 'Th·∫£ tim';
  note.textContent = `(${s.count||0})`;
  btn.onclick = async ()=>{
    const r = await heart_toggle({ chapter: ch.index });
    btn.classList.toggle('active', !!r.active);
    label.textContent = r.active ? 'ƒê√£ th·∫£ tim' : 'Th·∫£ tim';
    note.textContent = `(${r.count||0})`;
  };
}

/** ====== AGGREGATE (mixed) ====== **/
function renderMixed(container, items, limit){
  const show = items.slice(0, limit);
  container.innerHTML = show.map(it=>{
    const who = it.name?.trim() ? esc(it.name) : '·∫®n danh';
    const page = it.page ? ` ‚Äî #${it.page}` : '';
    const when = new Date(it.created_at).toLocaleString();
    const owner = it.edit_token && localStorage.getItem('cmt_token_'+it.id) === it.edit_token;
    return `<div class="cmt-item" data-id="${it.id}">
      <div class="cmt-meta"><b>${who}</b>${page} ¬∑ <span>${esc(when)}</span></div>
      <div class="cmt-body" data-body>${esc(it.body)}</div>
      ${owner ? `<div class="cmt-actions">
        <button class="btn small" data-act="edit">S·ª≠a</button>
        <button class="btn small danger" data-act="del">Xo√°</button>
      </div>` : ``}
    </div>`;
  }).join('') || '<div class="meta">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>';

  // actions
  container.querySelectorAll('[data-act="edit"]').forEach(btn=>{
    btn.onclick = async ()=>{
      const wrap = btn.closest('.cmt-item'); const id = wrap.dataset.id;
      const bodyEl = wrap.querySelector('[data-body]');
      const old = bodyEl.textContent;
      const ta = document.createElement('textarea'); ta.value = old; ta.style.width='100%';
      bodyEl.replaceWith(ta);
      btn.textContent='L∆∞u';
      btn.onclick = async ()=>{
        const token = localStorage.getItem('cmt_token_'+id);
        try{ await cmt_edit({ id, body: ta.value.trim(), edit_token: token });
          const obj = commentsCache.find(c=>c.id===id); if(obj) obj.body = ta.value.trim();
          await renderAggregated(currentChapter);
        }catch(e){ alert('L·ªói s·ª≠a: '+(e.message||e)); }
      };
    };
  });
  container.querySelectorAll('[data-act="del"]').forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm('Xo√° b√¨nh lu·∫≠n n√†y?')) return;
      const wrap = btn.closest('.cmt-item'); const id = wrap.dataset.id;
      const token = localStorage.getItem('cmt_token_'+id);
      try{ await cmt_delete({ id, edit_token: token });
        commentsCache = commentsCache.filter(c=>c.id!==id);
        await renderAggregated(currentChapter);
      }catch(e){ alert('L·ªói xo√°: '+(e.message||e)); }
    };
  });

  $('#moreMixed').style.display = items.length > limit ? 'inline-block' : 'none';
}

async function renderAggregated(ch){
  commentsCache = await cmt_fetch(ch.index);
  // pages with comments => hi·ªÉn badge
  pagesWithComments = new Set(commentsCache.filter(c=>c.page!=null).map(c=>c.page));
  document.querySelectorAll('.page-wrap').forEach((wrap,idx)=>{
    const p = idx+1; const badge = wrap.querySelector('.badge');
    badge.style.display = pagesWithComments.has(p) ? 'flex' : 'none';
  });
  // mixed + sort
  const sort = $('#sortSel').value;
  const arr = [...commentsCache].sort((a,b)=>{
    const da = new Date(a.created_at), db = new Date(b.created_at);
    return sort==='new' ? db-da : da-db;
  });
  renderMixed($('#aggMixed'), arr, mixedLimit);
}
$('#moreMixed').addEventListener('click', ()=>{ mixedLimit+=20; renderAggregated(currentChapter); });
$('#sortSel').addEventListener('change', ()=> renderAggregated(currentChapter));

/** ====== CHAPTER RENDER ====== **/
const toTopBtn = $('#toTopBtn');
function updateTopBtnVisibility(){
  const show = window.scrollY > 600 && $('#readerView').style.display !== 'none';
  toTopBtn.style.display = show ? 'flex' : 'none';
}
toTopBtn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
window.addEventListener('scroll', updateTopBtnVisibility);

async function renderChapter(ch){
  $('#homeView').style.display='none';
  $('#readerView').style.display='block';
  currentChapter = ch;
  $('#chapTitle').textContent = `${SERIES_TITLE} ‚Äî ${ch.title}`;
  const viewer = $('#viewer'); viewer.innerHTML='';

  ['Top','Mid','Bottom'].forEach(pos=>{
    const sel = $('#chapterSel'+pos); if(sel) sel.value = ch.id;
  });

  let missing=0;
  for(let i=1;i<=MAX_PAGES_GUESS;i++){
    const url = await findExistingUrl(ch.path, ch.index, i);
    if(!url){ missing++; if(missing>=3 || i===1) break; continue; }
    missing=0;

    const wrap=document.createElement('div'); wrap.className='page-wrap';
    const img=document.createElement('img');
    img.src=url; img.className='page'; img.loading='lazy'; img.alt=`${ch.title} ‚Äî trang ${i}`;
    img.addEventListener('click', ()=> openMini(i));
    const badge=document.createElement('div'); badge.className='badge'; badge.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>';
    wrap.appendChild(img); wrap.appendChild(badge);
    viewer.appendChild(wrap);
  }

  const prevId = neighborChapter(ch.id,-1);
  const nextId = neighborChapter(ch.id, 1);
  $('#prevTop').onclick = ()=> prevId && (location.hash=prevId);
  $('#nextTop').onclick = ()=> nextId && (location.hash=nextId);
  $('#prevBottom').onclick = ()=> prevId && (location.hash=prevId);
  $('#nextBottom').onclick = ()=> nextId && (location.hash=nextId);

  await updateHeartUI(ch);
  await renderAggregated(ch);

  window.scrollTo({top:0,behavior:'smooth'});
  updateTopBtnVisibility();
}

/** ====== ROUTER / TOC ====== **/
function getHash(){ return decodeURIComponent(location.hash.replace(/^#/,'')) }
function populateSelect(id){
  const sel = $('#'+id); sel.innerHTML='';
  CHAPTERS.forEach(ch=>{ const o=document.createElement('option'); o.value=ch.id; o.textContent=ch.title; sel.appendChild(o); });
  sel.addEventListener('change', ()=> location.hash = sel.value);
}
function neighborChapter(id, dir){
  const idx = CHAPTERS.findIndex(c=>c.id===id);
  const next = CHAPTERS[idx+dir]; return next ? next.id : null;
}
function route(){
  const h = getHash() || 'home';
  if(h==='home'){ $('#homeView').style.display='grid'; $('#readerView').style.display='none'; }
  else{ const ch = CHAPTERS.find(c=>c.id===h) || CHAPTERS[0]; renderChapter(ch); }
}

/** ====== INIT ====== **/
(async function init(){
  initDB();
  await getUser(); updateAuthBtn();

  CHAPTERS = await buildChaptersAuto();
  function buildTOC(containerId){
    const box = document.querySelector(containerId); box.innerHTML='';
    CHAPTERS.forEach(ch=>{ const a=document.createElement('a'); a.href=`#${ch.id}`; a.textContent=ch.title; a.className='btn'; a.addEventListener('click',(e)=>{ e.preventDefault(); location.hash=ch.id; }); box.appendChild(a); });
  }
  buildTOC('#homeTOC');
  ['chapterSelTop','chapterSelMid','chapterSelBottom'].forEach(populateSelect);

  $('#fitSel').addEventListener('change', ()=>{
    document.querySelectorAll('.page').forEach(img=>{
      const mode = $('#fitSel').value;
      if(mode==='fit'){ img.style.width='100%'; img.style.maxWidth='100%'; img.style.marginLeft='auto'; img.style.marginRight='auto'; }
      else{ img.style.width='auto'; img.style.maxWidth='none'; img.style.marginLeft='auto'; img.style.marginRight='auto'; }
    });
  });

  window.addEventListener('hashchange', route);
  route();
  updateTopBtnVisibility();
})();
</script>
</body>
</html>
