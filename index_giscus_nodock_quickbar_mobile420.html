<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OƒÉng oƒÉng w c√∫n c√°o ‚Äî Trang ch·ªß</title>
  <style>
    :root{--bg:#0b0d10;--fg:#e6e8eb;--muted:#98a1b3;--card:#0f1216;--bd:#1a1f29;--accent:#f59e0b;--green:#10b981}
    *{box-sizing:border-box} html,body{margin:0;padding:0;height:100%}
    body{background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(11,13,16,.98), rgba(11,13,16,.92));border-bottom:1px solid var(--bd);backdrop-filter:saturate(180%) blur(10px)}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand svg{height:34px;width:auto;display:block}
    .brand span{font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);background:var(--card);border-radius:999px}
    select,button{color:var(--fg);background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:8px 10px;cursor:pointer}
    .grow{flex:1}
    .grid{display:grid;gap:12px}
    .viewer{display:flex;flex-direction:column;gap:0}
    .page{width:100%;display:block;border-radius:0;border:none;background:#0a0c0f;margin-left:auto;margin-right:auto}
    .page-wrap{position:relative}
    .card{padding:14px;border:1px solid var(--bd);background:var(--card);border-radius:14px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bd);background:var(--card);cursor:pointer}
    .btn:hover{border-color:#2a3242}
    .toc-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .footer{padding:28px 0;color:var(--muted);text-align:center}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .nav3{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .nav3 .left{justify-self:start}
    .nav3 .center{justify-self:center}
    .nav3 .right{justify-self:end}
    .meta{color:var(--muted);font-size:13px}

    /* Quick comment bar */
    .qc{
      position:fixed;right:18px;bottom:18px;z-index:55;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--bd);background:var(--card);
      box-shadow:0 8px 18px rgba(0,0,0,.45);
    }
    .qc input{
      width:180px;background:transparent;border:none;outline:none;color:var(--muted);
      font-size:14px;
    }
    .qc .send{
      display:inline-flex;align-items:center;justify-content:center;
      width:36px;height:36px;border-radius:12px;border:1px solid var(--bd);
      background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);
    }
    .qc .send svg{width:18px;height:18px;color:#e5e7eb}

    /* To top button */
    #toTopBtn{
      position:fixed;left:18px;bottom:18px;z-index:55;border-radius:999px;width:46px;height:46px;display:none;
      align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.35);
      background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);box-shadow:0 8px 18px rgba(0,0,0,.45);
    }
    #toTopBtn svg{width:22px;height:22px;display:block;color:#e5e7eb}

    /* Giscus host */
    #giscusCard{padding:0;border-radius:14px}
    #giscusHost{padding:12px}
    #giscusHost .hint{color:var(--muted);font-size:13px;margin-bottom:8px}

    /* Mobile giscus sizing */
    @media (max-width:640px){
      #giscusHost{max-width:360px;margin:0 auto}
      #giscusWrapper{width:360px;max-width:100%;height:420px;overflow:auto;margin:0 auto;border-radius:10px;border:1px solid var(--bd)}
      /* iframe will be taller, we just scroll the wrapper */
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <!-- Dog (simple, not boxed) -->
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs><radialGradient id="dg" cx="50%" cy="45%" r="60%"><stop offset="0%" stop-color="#FFEBD3"/><stop offset="100%" stop-color="#FFD4A9"/></radialGradient></defs>
          <circle cx="32" cy="34" r="16" fill="url(#dg)" stroke="#0f172a" stroke-width="1.4"/>
          <path d="M19 27 q4-10 11-7 v7 z" fill="#C38E66" />
          <path d="M45 27 q-4-10-11-7 v7 z" fill="#C38E66" />
          <circle cx="26.5" cy="32" r="2.3" fill="#0f172a"/><circle cx="37.5" cy="32" r="2.3" fill="#0f172a"/>
          <path d="M30.5 35 q1.5-2 3 0 q1.5-2 3 0 a2.2 2.2 0 1 1 -6 0 z" fill="#111827"/>
          <path d="M28,39 Q32,42 36,39" stroke="#0f172a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        </svg>
        <!-- Fox (simple, not boxed) -->
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs><linearGradient id="fg" x1="0" x2="1"><stop offset="0" stop-color="#FFC068"/><stop offset="1" stop-color="#FF7A3D"/></linearGradient></defs>
          <circle cx="32" cy="34" r="16" fill="url(#fg)" stroke="#0f172a" stroke-width="1.4"/>
          <path d="M23 25 L28 16 L30 28 Z" fill="#FF7A3D"/><path d="M41 25 L36 16 L34 28 Z" fill="#FF7A3D"/>
          <path d="M22 34 Q32 42 42 34 Q32 31 22 34 Z" fill="white" opacity=".98"/>
          <circle cx="27.5" cy="32" r="2.2" fill="#0f172a"/><circle cx="36.5" cy="32" r="2.2" fill="#0f172a"/>
          <circle cx="32" cy="36" r="1.7" fill="#0f172a"/>
        </svg>
        <span>OƒÉng oƒÉng w c√∫n c√°o</span>
      </div>
      <a href="#home" id="homeBtn" class="btn">üè† Trang ch·ªß</a>
      <div class="pill" id="tocHeader">
        <label for="chapterSelTop">M·ª•c l·ª•c</label>
        <select id="chapterSelTop"></select>
      </div>
      <div class="pill" id="fitControls">
        <label for="fitSel">Hi·ªÉn th·ªã</label>
        <select id="fitSel">
          <option value="fit">V·ª´a khung</option>
          <option value="full">K√≠ch th∆∞·ªõc g·ªëc</option>
        </select>
      </div>
      <div class="grow"></div>
      <div class="meta">Ph√≠m t·∫Øt: <b>G</b> l√™n ƒë·∫ßu</div>
    </div>
  </header>

  <!-- Quick comment bar (fake input + paper plane) -->
  <div class="qc" id="qcBar" title="Vi·∫øt b√¨nh lu·∫≠n nhanh (cu·ªôn t·ªõi khung b√¨nh lu·∫≠n)">
    <input type="text" placeholder="Vi·∫øt b√¨nh lu·∫≠n‚Ä¶" disabled />
    <button class="send" id="qcSend" aria-label="T·ªõi khung b√¨nh lu·∫≠n">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
    </button>
  </div>

  <!-- Floating "go to top" button -->
  <button id="toTopBtn" aria-label="L√™n ƒë·∫ßu chap" title="L√™n ƒë·∫ßu chap">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M18 15l-6-6-6 6"/>
    </svg>
  </button>

  <main class="wrap grid">
    <!-- HOME VIEW -->
    <section id="homeView" class="grid">
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)</div>
      </div>
      <div class="grid" style="grid-template-columns: 280px 1fr;gap:16px;align-items:start">
        <div class="card">
          <img id="coverImg" alt="cover" style="width:100%;border-radius:10px;border:1px solid var(--bd);background:#0a0c0f"
               src="assets/cover.jpg"
               onerror="this.onerror=null; this.src='assets/Cover.jpg';">
        </div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:10px">M·ª•c l·ª•c</div>
          <div id="homeTOC" class="toc-list"></div>
        </div>
      </div>
    </section>

    <!-- READER VIEW -->
    <section id="readerView" style="display:none">
      <div class="card">
        <div id="chapTitle" style="font-weight:700">...</div>
      </div>

      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevTop">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center">
            <label for="chapterSelMid" class="chip" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label>
            <select id="chapterSelMid"></select>
          </div>
          <div class="right"><button class="btn" id="nextTop">Chap sau ‚ü∂</button></div>
        </div>
      </div>

      <div id="viewer" class="viewer"></div>

      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevBottom">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center">
            <label for="chapterSelBottom" class="chip" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label>
            <select id="chapterSelBottom"></select>
          </div>
          <div class="right"><button class="btn" id="nextBottom">Chap sau ‚ü∂</button></div>
        </div>
      </div>

      <!-- Giscus block at bottom -->
      <div class="card" id="giscusCard">
        <div id="giscusHost">
          <div class="hint">B√¨nh lu·∫≠n (giscus). Nh·∫•n v√†o ·∫£nh ƒë·ªÉ chuy·ªÉn b√¨nh lu·∫≠n theo trang ƒë√≥, ho·∫∑c d√πng ‚ÄúB√¨nh lu·∫≠n chap‚Äù.</div>
          <div id="giscusWrapper">
            <!-- giscus iframe injected here -->
          </div>
          <div class="row" style="padding:10px 12px 12px">
            <button class="btn" id="openOverall">üí¨ B√¨nh lu·∫≠n chap</button>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">Made for reading on GitHub Pages. Comments via giscus.</div>
  </main>

<script>
// ====== CONFIG ======
const SERIES_TITLE = "C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)";
const MAX_CHAPTERS_GUESS = 999;
const MAX_PAGES_GUESS = 2000;
const EXTS = ["jpg","jpeg","png","gif","webp"];
const GISCUS = {
  enabled: true,
  repo: "mtamtt/Oang-oang-w-cun-cao.", // repo c√≥ d·∫•u ch·∫•m
  repoId: "R_kgDOPcLS9A",
  category: "General",
  categoryId: "DIC_kwDOPcLS9M4CuDfL",
  mapping: "specific",
  theme: "dark",
  lang: "vi",
  reactions: "1",
  emit: "0",
  inputPos: "top"
};

// ====== HELPERS ======
const $ = (q, el=document) => el.querySelector(q);
function getHash(){ return decodeURIComponent(location.hash.replace(/^#/,'')) }
function enc(s){ return encodeURIComponent(s) }
function fileName(ch, i, ext){ return `C${ch} (${i}).${ext}` }
function fileUrl(chPath, ch, i, ext){ return `${chPath}/${enc(fileName(ch,i,ext))}` }
function scrollToGiscus(){ document.getElementById('giscusCard').scrollIntoView({behavior:'smooth', block:'start'}); }

function imgOk(url){
  return new Promise((resolve)=>{ const img=new Image(); img.onload=()=>resolve(true); img.onerror=()=>resolve(false); img.src=url; });
}
async function findExistingUrl(chPath, ch, i){
  for(const ext of EXTS){
    const url = fileUrl(chPath, ch, i, ext);
    if(await imgOk(url)) return url;
  }
  return null;
}
async function chapExists(n){ return await findExistingUrl(`chapters/chap-${n}`, n, 1) !== null; }
async function buildChaptersAuto(){
  const chapters=[];
  for(let i=1;i<=MAX_CHAPTERS_GUESS;i++){
    if(!(await chapExists(i))) break;
    chapters.push({ id:`chap-${i}`, index:i, title:`Chap ${i}`, path:`chapters/chap-${i}` });
  }
  return chapters;
}

// ====== STATE ======
let CHAPTERS=[];
let currentChapter=null;
let currentTerm=null;
let io=null;

// ====== GISCUS ======
function ensureGiscus(term){
  if(!GISCUS.enabled) return;
  const host = document.getElementById('giscusWrapper');
  if(host.dataset.ready==="1"){
    setGiscusTerm(term); return;
  }
  const s = document.createElement('script');
  s.src = 'https://giscus.app/client.js';
  s.async = true; s.crossOrigin = 'anonymous';
  s.setAttribute('data-repo', GISCUS.repo);
  s.setAttribute('data-repo-id', GISCUS.repoId);
  s.setAttribute('data-category', GISCUS.category);
  s.setAttribute('data-category-id', GISCUS.categoryId);
  s.setAttribute('data-mapping', GISCUS.mapping);
  s.setAttribute('data-term', term);
  s.setAttribute('data-reactions-enabled', GISCUS.reactions);
  s.setAttribute('data-emit-metadata', GISCUS.emit);
  s.setAttribute('data-input-position', GISCUS.inputPos);
  s.setAttribute('data-theme', GISCUS.theme);
  s.setAttribute('data-lang', GISCUS.lang);
  host.innerHTML = ""; host.appendChild(s);
  host.dataset.ready="1"; currentTerm = term;
}
function setGiscusTerm(term){
  if(currentTerm===term) return;
  currentTerm = term;
  const frame = document.querySelector('iframe.giscus-frame');
  if(!frame) return;
  frame.contentWindow.postMessage({ giscus: { setConfig: { term, mapping: GISCUS.mapping } } }, 'https://giscus.app');
}

// ====== TOP / QUICK COMMENT ======
const toTopBtn = document.getElementById('toTopBtn');
function updateTopBtnVisibility(){
  const show = window.scrollY > 600 && document.getElementById('readerView').style.display !== 'none';
  toTopBtn.style.display = show ? 'flex' : 'none';
}
toTopBtn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
window.addEventListener('scroll', updateTopBtnVisibility);

// Quick comment bar ‚Üí just jump to giscus
document.getElementById('qcSend').addEventListener('click', ()=> scrollToGiscus());

// ====== RENDER CHAPTER ======
async function renderChapter(ch){
  document.getElementById('homeView').style.display='none';
  document.getElementById('readerView').style.display='block';

  currentChapter = ch;
  document.getElementById('chapTitle').textContent = `${SERIES_TITLE} ‚Äî ${ch.title}`;
  const viewer = document.getElementById('viewer'); viewer.innerHTML='';

  // sync dropdowns
  ['Top','Mid','Bottom'].forEach(pos=>{
    const sel = document.getElementById('chapterSel'+pos);
    if(sel) sel.value = ch.id;
  });

  // load pages
  let missing=0;
  const imgEls = [];
  for(let i=1;i<=MAX_PAGES_GUESS;i++){
    const url = await findExistingUrl(ch.path, ch.index, i);
    if(!url){
      missing++; if(missing>=3 || i===1) break; continue;
    }
    missing=0;
    const wrap=document.createElement('div'); wrap.className='page-wrap';
    const img=document.createElement('img');
    img.src=url; img.className='page'; img.loading='lazy'; img.alt=`${ch.title} ‚Äî trang ${i}`;
    img.dataset.term = `${ch.id}-img-${i}`;
    img.addEventListener('click', ()=>{ ensureGiscus(img.dataset.term); setGiscusTerm(img.dataset.term); scrollToGiscus(); });
    wrap.appendChild(img); viewer.appendChild(wrap); imgEls.push(img);
  }

  // nav behaviour
  const prevId = neighborChapter(ch.id,-1);
  const nextId = neighborChapter(ch.id, 1);
  document.getElementById('prevTop').onclick = ()=> prevId && (location.hash=prevId);
  document.getElementById('nextTop').onclick = ()=> nextId && (location.hash=nextId);
  document.getElementById('prevBottom').onclick = ()=> prevId && (location.hash=prevId);
  document.getElementById('nextBottom').onclick = ()=> nextId && (location.hash=nextId);

  // overall button
  document.getElementById('openOverall').onclick = ()=>{ ensureGiscus(`${ch.id}-overall`); setGiscusTerm(`${ch.id}-overall`); scrollToGiscus(); };

  // observer: track visible image -> for 'currentTerm' if needed
  if(io) io.disconnect();
  io = new IntersectionObserver((entries)=>{
    const visible = entries.filter(e=>e.isIntersecting).sort((a,b)=>b.intersectionRatio - a.intersectionRatio)[0];
    if(!visible) return;
    const term = visible.target.dataset.term;
    currentTerm = term;
  }, { root:null, rootMargin:'-40% 0px -50% 0px', threshold:[0.25,0.5,0.75,1] });
  imgEls.forEach(el=> io.observe(el));

  // init giscus to overall by default
  ensureGiscus(`${ch.id}-overall`);

  window.scrollTo({top:0,behavior:'smooth'});
  updateTopBtnVisibility();
}

// ====== ROUTER ======
function populateSelect(id){
  const sel = document.getElementById(id); sel.innerHTML='';
  CHAPTERS.forEach(ch=>{ const o=document.createElement('option'); o.value=ch.id; o.textContent=ch.title; sel.appendChild(o); });
  sel.addEventListener('change', ()=> location.hash = sel.value);
}
function neighborChapter(id, dir){
  const idx = CHAPTERS.findIndex(c=>c.id===id);
  const next = CHAPTERS[idx+dir]; return next ? next.id : null;
}
function route(){
  const h = getHash() || 'home';
  if(h==='home'){ document.getElementById('homeView').style.display='grid'; document.getElementById('readerView').style.display='none'; }
  else{ const ch = CHAPTERS.find(c=>c.id===h) || CHAPTERS[0]; renderChapter(ch); }
}

(async function init(){
  CHAPTERS = await buildChaptersAuto();
  function buildTOC(containerId){
    const box = document.querySelector(containerId); box.innerHTML='';
    CHAPTERS.forEach(ch=>{ const a=document.createElement('a'); a.href=`#${ch.id}`; a.textContent=ch.title; a.className='btn'; a.addEventListener('click',(e)=>{ e.preventDefault(); location.hash=ch.id; }); box.appendChild(a); });
  }
  buildTOC('#homeTOC');
  ['chapterSelTop','chapterSelMid','chapterSelBottom'].forEach(populateSelect);
  document.querySelector('#fitSel').addEventListener('change', ()=>{
    document.querySelectorAll('.page').forEach(img=>{
      const mode = document.querySelector('#fitSel').value;
      if(mode==='fit'){ img.style.width='100%'; img.style.maxWidth='100%'; img.style.marginLeft='auto'; img.style.marginRight='auto'; }
      else{ img.style.width='auto'; img.style.maxWidth='none'; img.style.marginLeft='auto'; img.style.marginRight='auto'; }
    });
  });
  window.addEventListener('hashchange', route);
  route();
  updateTopBtnVisibility();
})();
</script>
</body>
</html>
