<!doctype html>
<html lang="vi" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OƒÉng oƒÉng w c√∫n c√°o ‚Äî ƒê·ªçc truy·ªán</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b0d10;--fg:#e6e8eb;--muted:#98a1b3;--card:#0f1216;--bd:#1a1f29;--accent:#f59e0b;--pink:#ec4899;--green:#22c55e;--basic:#94a3b8}
    *{box-sizing:border-box} html,body{margin:0;padding:0;height:100%}
    body{background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(11,13,16,.98), rgba(11,13,16,.92));border-bottom:1px solid var(--bd);backdrop-filter:saturate(180%) blur(10px)}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 16px}
    .brand{display:flex;align-items:center;gap:2px;font-weight:800}
    .brand svg{height:46px;width:auto;display:block}
    .brand span{font-weight:800;margin-left:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);background:var(--card);border-radius:999px}
    select,button,input,textarea{color:var(--fg);background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    input,textarea{width:100%}
    textarea{min-height:88px;resize:vertical}
    .grow{flex:1}
    .grid{display:grid;gap:12px}
    .viewer{display:flex;flex-direction:column;gap:0}
    .page{width:100%;display:block;border-radius:0;border:none;background:#0a0c0f;margin-left:auto;margin-right:auto}
    .page-wrap{position:relative}
    /* BADGE */
    .badge{ position:absolute;top:10px;right:-12px;background:#0f172a;border:2px solid #233046;border-radius:999px;
      width:28px;height:28px;display:none;align-items:center;justify-content:center;box-shadow:0 8px 16px rgba(0,0,0,.5)}
    .badge svg{width:16px;height:16px;color:var(--basic)}
    .card{padding:14px;border:1px solid var(--bd);background:var(--card);border-radius:14px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bd);background:var(--card);cursor:pointer}
    .btn:hover{border-color:#2a3242}
    .btn.plane{display:inline-flex;align-items:center;justify-content:center;border-radius:12px}
    .btn.small{padding:6px 8px;font-size:14px}
    .toc-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .footer{padding:28px 0;color:var(--muted);text-align:center}
    .nav3{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .nav3 .left{justify-self:start}
    .nav3 .center{justify-self:center}
    .nav3 .right{justify-self:end}
    .meta{color:var(--muted);font-size:13px}

    /* To top */
    #toTopBtn{ position:fixed;right:18px;bottom:18px;z-index:55;border-radius:999px;width:46px;height:46px;display:none;
      align-items:center;justify-content:center;border:1px solid rgba(148,163,184,.35);
      background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);box-shadow:0 8px 18px rgba(0,0,0,.45);}
    #toTopBtn svg{width:22px;height:22px;display:block;color:#e5e7eb}

    /* Mini panel */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:70}
    .backdrop.open{opacity:1;pointer-events:auto}
    .mini{
      position:fixed;z-index:71;right:16px;bottom:70px;border:1px solid var(--bd);background:var(--card);
      border-radius:20px;box-shadow:0 16px 32px rgba(0,0,0,.5);
      width:360px;height:420px;max-width:95vw;max-height:85vh;
      display:flex;flex-direction:column;transform:translateY(16px) scale(.98);opacity:0;pointer-events:none;transition:transform .22s ease,opacity .22s ease;
      overflow:hidden;
    }
    .mini.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
    .mini.min{height:auto}
    .mini-head{display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--bd)}
    .mini-hint{color:var(--muted);font-size:12px;text-align:center}
    .mini-body{flex:1;overflow:auto;padding:8px;-webkit-overflow-scrolling:touch}
    .mini-composer{display:flex;gap:8px;align-items:center;margin-top:8px}
    .mini-composer input{flex:1}
    .cmt-item{border-top:1px dashed #223; padding:8px 6px}
    .cmt-meta{color:#9fb0c0; font-size:12px; margin-bottom:4px}
    .cmt-body{white-space:pre-wrap}
    .cmt-actions{display:flex;gap:8px;margin-top:6px;align-items:center;flex-wrap:wrap}
    .cmt-actions .danger{border-color:#7f1d1d;color:#fca5a5}
    .replies{margin-left:14px;border-left:1px dashed #243044;padding-left:10px;margin-top:6px}
    .reply-box{display:flex;gap:8px;margin-top:6px}
    .reactbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;gap:4px;align-items:center;border:1px solid var(--bd);border-radius:999px;padding:4px 8px;font-size:13px;background:var(--card)}
    .chip.mine{outline:2px solid rgba(148,163,184,.4)}
    .react-menu{position:absolute;z-index:72;background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:6px;display:flex;gap:6px}
    .react-btn{font-size:18px;line-height:1;border:1px solid var(--bd);border-radius:10px;padding:6px;background:var(--card);cursor:pointer}
    @media (max-width:640px){ .mini{width:320px;height:380px;right:12px;bottom:64px} }
    /* Heart (chap) */
    .heart{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--bd);background:var(--card);}
    .heart svg{width:18px;height:18px;display:block}
    .heart.active{border-color:rgba(236,72,153,.35);background:linear-gradient(135deg,rgba(236,72,153,.12),rgba(236,72,153,.04))}
    .heart .filled{display:none;color:var(--pink)}
    .heart.active .filled{display:inline}
    .heart.active .outline{display:none}
    .note{color:var(--muted);font-size:13px}
  
    .ta-wrap{position:relative}
    .ta-wrap textarea{padding-right:56px}
    .plane-btn{position:absolute;right:8px;bottom:8px;width:40px;height:40px;border-radius:12px;border:1px solid var(--bd);display:inline-flex;align-items:center;justify-content:center;background:var(--card)}
    .plane-btn svg{width:18px;height:18px;display:block}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs><radialGradient id="dg" cx="50%" cy="45%" r="60%"><stop offset="0%" stop-color="#FFEBD3"/><stop offset="100%" stop-color="#FFD4A9"/></radialGradient></defs>
          <circle cx="32" cy="34" r="16" fill="url(#dg)" stroke="#0f172a" stroke-width="1.4"/>
          <path d="M19 27 q4-10 11-7 v7 z" fill="#C38E66" /><path d="M45 27 q-4-10-11-7 v7 z" fill="#C38E66" />
          <circle cx="26.5" cy="32" r="2.3" fill="#0f172a"/><circle cx="37.5" cy="32" r="2.3" fill="#0f172a"/>
          <path d="M30.5 35 q1.5-2 3 0 q1.5-2 3 0 a2.2 2.2 0 1 1 -6 0 z" fill="#111827"/>
          <path d="M28,39 Q32,42 36,39" stroke="#0f172a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
        </svg>
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs><linearGradient id="fg" x1="0" x2="1"><stop offset="0" stop-color="#FFC068"/><stop offset="1" stop-color="#FF7A3D"/></linearGradient></defs>
          <circle cx="32" cy="34" r="16" fill="url(#fg)" stroke="#0f172a" stroke-width="1.4"/>
          <path d="M23 25 L28 16 L30 28 Z" fill="#FF7A3D"/><path d="M41 25 L36 16 L34 28 Z" fill="#FF7A3D"/>
          <path d="M22 34 Q32 42 42 34 Q32 31 22 34 Z" fill="white" opacity=".98"/>
          <circle cx="27.5" cy="32" r="2.2" fill="#0f172a"/><circle cx="36.5" cy="32" r="2.2" fill="#0f172a"/>
          <circle cx="32" cy="36" r="1.7" fill="#0f172a"/>
        </svg>
        <span>OƒÉng oƒÉng w c√∫n c√°o</span>
      </div>
      <a href="#home" id="homeBtn" class="btn">üè† Trang ch·ªß</a>
      <div class="pill"><label for="chapterSelTop">M·ª•c l·ª•c</label> <select id="chapterSelTop"></select></div>
      <div class="pill"><label for="fitSel">Hi·ªÉn th·ªã</label>
        <select id="fitSel">
          <option value="fit">V·ª´a khung</option>
          <option value="full">K√≠ch th∆∞·ªõc g·ªëc</option>
        </select>
      </div>
      <div class="grow"></div>
      <div class="auth-pill" id="authBox">
        <span class="auth-name" id="authName">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
        <button class="btn small" id="authBtn">ƒêƒÉng nh·∫≠p GitHub</button>
      </div>
      <div class="meta">Ph√≠m t·∫Øt: B ƒë√≥ng cmt ¬∑ G l√™n ƒë·∫ßu</div>
    </div>
  </header>

  <div id="backdrop" class="backdrop"></div>
  <aside id="miniPanel" class="mini" aria-hidden="true">
    <div class="mini-head">
      <div id="panelTitle" style="font-weight:700">B√¨nh lu·∫≠n</div>
      <div class="mini-hint">Vu·ªët tr√°i ‚Üí ph·∫£i ƒë·ªÉ ƒë√≥ng ¬∑ nh·∫•n B</div>
      <button class="btn small" id="miniToggle">Thu g·ªçn</button>
      <button class="btn small" id="miniClose">ƒê√≥ng</button>
    </div>
    <div class="mini-body" id="miniBody">
      <div id="panelList"></div>
      <div class="card" style="margin-top:8px" id="panelComposer">
        <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:600">Vi·∫øt b√¨nh lu·∫≠n cho trang n√†y</div>
          <button class="btn small" id="panelAuthBtn">ƒêƒÉng nh·∫≠p GitHub</button>
        </div>
        <div class="ta-wrap"><textarea id="panelBody" placeholder="N·ªôi dung b√¨nh lu·∫≠n..."></textarea>
          <button id="panelSend" class="plane-btn" title="G·ª≠i">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          </button></div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
          <div id="pageReactWrap" class="reactbar"></div>
          <div id="panelMsg" class="meta"></div>
        </div>
      </div>
      <div class="mini-composer" id="miniComposer" style="display:none">
        <input id="miniInput" placeholder="B√¨nh lu·∫≠n nhanh‚Ä¶">
        <button class="btn plane" id="miniSend" title="G·ª≠i">‚úà</button>
      </div>
    </div>
  </aside>

  <button id="toTopBtn" aria-label="L√™n ƒë·∫ßu chap" title="L√™n ƒë·∫ßu chap">‚¨Ü</button>

  <main class="wrap grid">
    <section id="homeView" class="grid">
      <div class="card"><div style="font-weight:700;margin-bottom:6px">C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)</div></div>
      <div class="grid" style="grid-template-columns: 280px 1fr;gap:16px;align-items:start">
        <div class="card">
          <img id="coverImg" alt="cover" style="width:100%;border-radius:10px;border:1px solid var(--bd);background:#0a0c0f"
               src="assets/cover.jpg" onerror="this.onerror=null; this.src='assets/Cover.jpg';">
        </div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:10px">M·ª•c l·ª•c</div>
          <div id="homeTOC" class="toc-list"></div>
        </div>
      </div>
    </section>

    <section id="readerView" style="display:none">
      <div class="card"><div id="chapTitle" style="font-weight:700">...</div></div>

      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevTop">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center"><label for="chapterSelMid" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label><select id="chapterSelMid"></select></div>
          <div class="right"><button class="btn" id="nextTop">Chap sau ‚ü∂</button></div>
        </div>
      </div>

      <div id="viewer" class="viewer"></div>

      <div class="card">
        <div class="nav3">
          <div class="left"><button class="btn" id="prevBottom">‚üµ Chap tr∆∞·ªõc</button></div>
          <div class="center"><label for="chapterSelBottom" style="display:block;text-align:center;margin-bottom:6px">M·ª•c l·ª•c</label><select id="chapterSelBottom"></select></div>
          <div class="right"><button class="btn" id="nextBottom">Chap sau ‚ü∂</button></div>
        </div>
      </div>

      <div class="card" id="aggCard">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="font-weight:700">B√¨nh lu·∫≠n chap</div>
            <div>
              <label for="aggSort" class="meta">S·∫Øp x·∫øp:</label>
              <select id="aggSort">
                <option value="new">M·ªõi nh·∫•t</option>
                <option value="old">C≈© nh·∫•t</option>
              </select>
            </div>
          </div>
          <div class="row">
            <button id="heartBtn" class="heart" title="Th·∫£ tim chap">
              <span>ü§ç</span><span id="heartLabel">Th·∫£ tim</span>
            </button>
            <span id="heartNote" class="note"></span>
          </div>
        </div>

        <div class="card" style="margin-bottom:10px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;gap:8px">
            <div style="font-weight:600">Vi·∫øt b√¨nh lu·∫≠n (GitHub ho·∫∑c ·∫®n danh)</div>
            <button class="btn small" id="aggAuthBtn">ƒêƒÉng nh·∫≠p GitHub</button>
          </div>
          <div class="ta-wrap"><textarea id="chapBody" placeholder="N·ªôi dung b√¨nh lu·∫≠n cho c·∫£ chap..."></textarea>
            <button id="chapSend" class="plane-btn" title="G·ª≠i">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button></div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
            <div id="chapMsg" class="meta"></div>
          </div>
        </div>

        <div style="font-weight:600;margin:8px 0 4px">D√≤ng b√¨nh lu·∫≠n (xen k·∫Ω trang & chap)</div>
        <div id="aggAll"></div>
        <button id="moreAll" class="btn small" style="margin-top:6px;display:none">Xem th√™m</button>
      </div>
    </section>

    <div class="footer">Supabase comments. ·∫®n danh ƒë√°nh s·ªë ‚Ä¢ Edit/Xo√° ‚Ä¢ Tim ƒë·ªìng b·ªô ‚Ä¢ Reaction popup ‚Ä¢ Tr·∫£ l·ªùi cmt.</div>
  </main>

<script>
const SUPABASE_URL = "https://kmhypppsljaxvqnnfxfa.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttaHlwcHBzbGpheHZxbm5meGZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzUyODgsImV4cCI6MjA3MDUxMTI4OH0.XtcNReQ7J8B9KThtKsaAJ2XXbWwnZat3LVF2y4LMZh4";
const SERIES_TITLE = "C·∫°nh tranh th√¢n thi·ªán (Friendly Rivalry)";
const EXTS = ["jpg","jpeg","png","gif","webp"];
const REACTIONS = [
  {k:"like", e:"üëç"}, {k:"love", e:"‚ù§Ô∏è"}, {k:"joy", e:"üòÇ"},
  {k:"wow", e:"üòÆ"}, {k:"sad", e:"üò¢"}, {k:"angry", e:"üò°"}
];
const COOLDOWN_S = 10;

let sb = null, demoMode = true, currentUser = null;

function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)); }
const deviceToken = (()=>{ let t=localStorage.getItem('device_token'); if(!t){t=uuid(); localStorage.setItem('device_token', t);} return t; })();
function anonNumberFromDevice(token){ let h=0; for(let i=0;i<token.length;i++) h=(h*31 + token.charCodeAt(i))>>>0; return (h % 9999) + 1; }
function anonLabel(){ return "·∫®n danh " + anonNumberFromDevice(deviceToken); }

async function ensureSupabaseReady(){
  // wait until window.supabase exists
  const start = Date.now();
  while(!(window.supabase && typeof window.supabase.createClient === 'function')){
    if(Date.now()-start>6000) { console.warn("Supabase lib not ready"); break; }
    await new Promise(r=>setTimeout(r,50));
  }
}

async function initDB(){
  await ensureSupabaseReady();
  if(window.supabase && SUPABASE_URL.startsWith("https://")){
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, detectSessionInUrl:true } });
    sb.auth.onAuthStateChange((_event, session)=>{ currentUser=session?.user||null; auth_refreshUI(); });
    demoMode=false;
  }else{
    demoMode=true;
    console.warn('Demo mode, localStorage only');
  }
}

async function auth_refreshUI(){
  if(demoMode){ document.getElementById('authName').textContent = anonLabel(); ['authBtn','panelAuthBtn','aggAuthBtn'].forEach(id=>{ const b=document.getElementById(id); if(b) b.textContent='ƒêƒÉng nh·∫≠p GitHub';}); return; }
  const { data: { session } } = await sb.auth.getSession();
  const { data: { user } } = await sb.auth.getUser();
  currentUser = session?.user || user || null;
  const name = currentUser ? (currentUser.user_metadata?.user_name || currentUser.user_metadata?.full_name || currentUser.email || 'GitHub') : anonLabel();
  document.getElementById('authName').textContent = name;
  const txt = currentUser ? 'ƒêƒÉng xu·∫•t' : 'ƒêƒÉng nh·∫≠p GitHub';
  ['authBtn','panelAuthBtn','aggAuthBtn'].forEach(id=>{ const b=document.getElementById(id); if(b) b.textContent=txt; });
}
async function auth_toggle(){
  if(demoMode) return;
  const { data: { user } } = await sb.auth.getUser();
  if(user){ await sb.auth.signOut(); }
  else{
    await sb.auth.signInWithOAuth({ provider:'github', options:{ redirectTo: window.location.href } });
  }
  setTimeout(auth_refreshUI, 250);
}
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='authBtn') auth_toggle();
  if(e.target && e.target.id==='panelAuthBtn') auth_toggle();
  if(e.target && e.target.id==='aggAuthBtn') auth_toggle();
});

// ===== DB RPC helpers =====
async function cmt_add({chapter, page, name, body, parent_id, edit_token}){
  if(demoMode){
    const store = JSON.parse(localStorage.getItem('demo_comments')||'[]');
    const row = { id: uuid(), chapter, page, name, body, parent_id: parent_id||null, created_at:new Date().toISOString(), edit_token };
    store.push(row); localStorage.setItem('demo_comments', JSON.stringify(store)); return row;
  }
  const { data, error } = await sb.rpc('comment_add', { p_chapter: chapter, p_page: page, p_name: name, p_body: body, p_parent: parent_id, p_edit_token: edit_token });
  if(error) throw error; return data;
}
async function cmt_edit({id, body, edit_token}){
  if(demoMode){
    const store = JSON.parse(localStorage.getItem('demo_comments')||'[]'); const i=store.findIndex(x=>x.id===id);
    if(i>=0){ store[i].body=body; localStorage.setItem('demo_comments', JSON.stringify(store)); return true; }
    throw new Error('not found');
  }
  const { error } = await sb.rpc('comment_edit', { p_id:id, p_edit_token:edit_token, p_body:body });
  if(error) throw error; return true;
}
async function cmt_delete({id, edit_token}){
  if(demoMode){
    let store = JSON.parse(localStorage.getItem('demo_comments')||'[]'); store = store.filter(x=>x.id!==id);
    localStorage.setItem('demo_comments', JSON.stringify(store)); return true;
  }
  const { error } = await sb.rpc('comment_delete', { p_id:id, p_edit_token:edit_token });
  if(error) throw error; return true;
}
async function cmt_fetch(chapter){
  if(demoMode){
    const store = JSON.parse(localStorage.getItem('demo_comments')||'[]');
    return store.filter(x=>x.chapter===chapter).sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  }
  const { data, error } = await sb.from('comments').select('*').eq('chapter', chapter).order('created_at', {ascending:false});
  if(error) throw error; return data||[];
}
// hearts
async function heart_toggle({chapter}){
  if(demoMode){
    const key='demo_hearts_'+chapter; const set = new Set(JSON.parse(localStorage.getItem(key)||'[]'));
    if(set.has(deviceToken)) set.delete(deviceToken); else set.add(deviceToken); localStorage.setItem(key, JSON.stringify([...set]));
    return { active:set.has(deviceToken), count:set.size };
  }
  const { data, error } = await sb.rpc('toggle_heart', { p_chapter:chapter, p_device:deviceToken });
  if(error) throw error; return data;
}
async function heart_get({chapter}){
  if(demoMode){ const key='demo_hearts_'+chapter; const set = new Set(JSON.parse(localStorage.getItem(key)||'[]')); return { active:set.has(deviceToken), count:set.size }; }
  const { data, error } = await sb.rpc('get_heart', { p_chapter:chapter, p_device:deviceToken }); if(error) throw error; return data;
}
// page reaction multi-kind
async function pageReact_get({chapter, page}){
  if(demoMode){
    const key='demo_page_react_'+chapter+'_'+page;
    const obj = JSON.parse(localStorage.getItem(key)||'{}');
    const mine=obj[deviceToken]||null;
    const counts={}; Object.values(obj).forEach(k=>{counts[k]=(counts[k]||0)+1;});
    return { counts, mine };
  }
  const { data, error } = await sb.rpc('get_page_reaction', { p_chapter:chapter, p_page:page, p_device:deviceToken });
  if(error) throw error; return data;
}
async function pageReact_toggle({chapter, page, kind}){
  if(demoMode){
    const key='demo_page_react_'+chapter+'_'+page; const obj = JSON.parse(localStorage.getItem(key)||'{}');
    const cur = obj[deviceToken]||null;
    if(cur===kind) delete obj[deviceToken]; else obj[deviceToken]=kind;
    localStorage.setItem(key, JSON.stringify(obj));
    const counts={}; Object.values(obj).forEach(k=>{counts[k]=(counts[k]||0)+1;});
    return { counts, mine: obj[deviceToken]||null };
  }
  const { data, error } = await sb.rpc('toggle_page_reaction', { p_chapter:chapter, p_page:page, p_device:deviceToken, p_kind:kind });
  if(error) throw error; return data;
}
// comment reaction multi-kind
async function cmtReact_summary(comment_id){
  if(demoMode){
    const key='demo_cmt_react_'+comment_id;
    const obj = JSON.parse(localStorage.getItem(key)||'{}');
    return { counts: obj.counts||{}, mine: obj.mine||null };
  }
  const { data, error } = await sb.rpc('get_comment_reaction_summary', { p_comment:comment_id, p_device:deviceToken });
  if(error) throw error; return data;
}
async function cmtReact_toggle(comment_id, kind){
  if(demoMode){
    const key='demo_cmt_react_'+comment_id;
    const o = JSON.parse(localStorage.getItem(key)||'{}');
    const mine=o.mine||null;
    if(mine===kind) o.mine=null; else o.mine=kind;
    o.counts=o.counts||{}; // recompute naive
    o.counts={}; if(o.mine) o.counts[o.mine]=(o.counts[o.mine]||0)+1;
    localStorage.setItem(key, JSON.stringify(o)); return o;
  }
  const { data, error } = await sb.rpc('toggle_comment_reaction', { p_comment:comment_id, p_device:deviceToken, p_kind:kind });
  if(error) throw error; return data;
}

// ===== HELPERS =====
const $ = (q, el=document)=>el.querySelector(q);
function getHash(){ return decodeURIComponent(location.hash.replace(/^#/,'')) }
function fileName(ch, i, ext){ return `C${ch} (${i}).${ext}` }
function esc(s){ return (s||"").replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])) }
function now(){ return Math.floor(Date.now()/1000) }
function imgOk(url){ return new Promise((resolve)=>{ const img=new Image(); img.onload=()=>resolve(true); img.onerror=()=>resolve(false); img.src=url; }); }
async function findExistingUrl(chPath, ch, i){
  for(const ext of EXTS){ const url = `${chPath}/${encodeURIComponent(fileName(ch,i,ext))}`; if(await imgOk(url)) return url; } return null;
}
async function chapExists(n){ return await findExistingUrl(`chapters/chap-${n}`, n, 1) !== null; }
async function buildChaptersAuto(){ const cs=[]; for(let i=1;i<=999;i++){ if(!(await chapExists(i))) break; cs.push({ id:`chap-${i}`, index:i, title:`Chap ${i}`, path:`chapters/chap-${i}` }); } return cs; }

// ===== STATE =====
let CHAPTERS=[], currentChapter=null, currentPageForPanel=null, commentsCache=[], pagesWithComments=new Set();
let allLimit=20, aggSort='new';

// ===== REACT UI =====
function buildReactChips(summary){
  const counts = summary?.counts || {};
  const mine = summary?.mine || null;
  return `<div class="reactbar">`+
    REACTIONS.map(r=>{
      const cnt = counts[r.k]||0;
      const cls = (mine===r.k && cnt>0) ? 'chip mine' : 'chip';
      return `<button class="${cls}" data-rk="${r.k}" title="${r.k}">${r.e} <span>${cnt}</span></button>`;
    }).join('')+`</div>`;
}
function attachReactHandlers(root, kind, idGetter){
  root.querySelectorAll('[data-rk]').forEach(btn=>{
    btn.onclick = async (e)=>{
      const rk = btn.getAttribute('data-rk');
      try{
        let summary;
        if(kind==='page'){
          summary = await pageReact_toggle({ chapter: currentChapter.index, page: currentPageForPanel, kind: rk });
        }else{
          const id = idGetter(btn);
          summary = await cmtReact_toggle(id, rk);
        }
        // rerender chips
        if(kind==='page'){
          document.getElementById('pageReactWrap').innerHTML = buildReactChips(summary);
          attachReactHandlers(document.getElementById('pageReactWrap'),'page');
        }else{
          const box = btn.closest('.cmt-item').querySelector('.reactbar');
          box.innerHTML = buildReactChips(summary);
          attachReactHandlers(box,'comment', b=> b.closest('.cmt-item').dataset.id);
        }
      }catch(e){ alert('L·ªói reaction: '+(e.message||e)); }
    };
  });
}

// ===== COMMENTS RENDER =====
function commentHTML(it){
  const owner = localStorage.getItem('cmt_token_'+it.id) === it.edit_token;
  const whoRaw = it.name?.trim() ? esc(it.name) : '·∫®n danh';
  const who = (!it.name || it.name.trim()==="") && owner ? esc(anonLabel()) : whoRaw;
  const when = new Date(it.created_at).toLocaleString();
  return `<div class="cmt-item" data-id="${it.id}">
    <div class="cmt-meta"><b>${who}</b> ‚Äî ${it.page!=null?('#'+it.page):'chap'} ¬∑ <span>${esc(when)}</span></div>
    <div class="cmt-body" data-body>${esc(it.body)}</div>
    <div class="cmt-actions">
      <button class="btn small" data-act="reply">Tr·∫£ l·ªùi</button>
      ${owner ? `<button class="btn small" data-act="edit">S·ª≠a</button><button class="btn small danger" data-act="del">Xo√°</button>` : ``}
    </div>
    <div class="reactbar"></div>
    <div class="replies" data-replies></div>
  </div>`;
}
function renderReplies(container, parentId, all){
  const rs = all.filter(x=>x.parent_id===parentId).sort((a,b)=> new Date(a.created_at)-new Date(b.created_at));
  container.innerHTML = rs.map(r=>commentHTML(r)).join('');
}
async function hydrateReactionsFor(el){
  // load summary for this comment
  const id = el.dataset.id;
  try{
    const sum = await cmtReact_summary(id);
    const bar = el.querySelector('.reactbar');
    bar.innerHTML = buildReactChips(sum);
    attachReactHandlers(bar,'comment', b=> b.closest('.cmt-item').dataset.id);
  }catch(e){}
}
function bindCommentActions(container){
  container.querySelectorAll('.cmt-item').forEach(async (wrap)=>{
    // reactions
    hydrateReactionsFor(wrap);
    // actions
    const editBtn = wrap.querySelector('[data-act="edit"]');
    const delBtn  = wrap.querySelector('[data-act="del"]');
    const replyBtn= wrap.querySelector('[data-act="reply"]');
    if(editBtn){
      editBtn.onclick = ()=>{
        const bodyEl = wrap.querySelector('[data-body]'); const old=bodyEl.textContent;
        const ta=document.createElement('textarea'); ta.value=old; ta.style.width='100%';
        bodyEl.replaceWith(ta);
        editBtn.textContent='L∆∞u';
        editBtn.onclick = async ()=>{
          const token = localStorage.getItem('cmt_token_'+wrap.dataset.id);
          await cmt_edit({ id: wrap.dataset.id, body: ta.value.trim(), edit_token: token });
          const obj = commentsCache.find(c=>c.id===wrap.dataset.id); if(obj) obj.body = ta.value.trim();
          await openMini(currentPageForPanel);
          await renderAggregated(currentChapter);
        };
      };
    }
    if(delBtn){
      delBtn.onclick = async ()=>{
        if(!confirm('Xo√° b√¨nh lu·∫≠n n√†y')) return;
        const token = localStorage.getItem('cmt_token_'+wrap.dataset.id);
        await cmt_delete({ id: wrap.dataset.id, edit_token: token });
        commentsCache = commentsCache.filter(c=>c.id!==wrap.dataset.id && c.parent_id!==wrap.dataset.id);
        await openMini(currentPageForPanel);
        await renderAggregated(currentChapter);
      };
    }
    if(replyBtn){
      replyBtn.onclick = ()=>{
        if(wrap.querySelector('.reply-box')){ wrap.querySelector('.reply-box').remove(); return; }
        const box=document.createElement('div'); box.className='reply-box';
        box.innerHTML = `<input placeholder="Ph·∫£n h·ªìi..."/><button class="btn small">G·ª≠i</button>`;
        wrap.appendChild(box);
        const inp=box.querySelector('input'); const b=box.querySelector('button');
        b.onclick = async ()=>{
          const txt = inp.value.trim(); if(!txt) return;
          const name = currentUser ? (currentUser.user_metadata?.user_name || currentUser.user_metadata?.full_name || currentUser.email || "GitHub") : anonLabel();
          const token=uuid();
          const parent = commentsCache.find(c=>c.id===wrap.dataset.id);
          const row = await cmt_add({ chapter: currentChapter.index, page: parent.page, name, body: txt, parent_id: wrap.dataset.id, edit_token: token });
          localStorage.setItem('cmt_token_'+row.id, token);
          commentsCache.unshift(row);
          await openMini(currentPageForPanel);
          await renderAggregated(currentChapter);
        };
      };
    }
    // load replies
    renderReplies(wrap.querySelector('[data-replies]'), wrap.dataset.id, commentsCache);
  });
}
function renderListInto(el, items){
  // top-level
  const roots = items.filter(x=>x.parent_id==null).sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
  el.innerHTML = roots.map(it=>commentHTML(it)).join('') || '<div class="meta">Ch∆∞a c√≥ b√¨nh lu·∫≠n cho trang n√†y.</div>';
  bindCommentActions(el);
}

async function openMini(pageIndex){
  currentPageForPanel = pageIndex;
  document.getElementById('panelTitle').textContent = `B√¨nh lu·∫≠n ‚Äî #${pageIndex}`;
  document.getElementById('panelBody').value = ''; document.getElementById('panelMsg').textContent='';

  const list = commentsCache.filter(c=> c.page === pageIndex);
  renderListInto(document.getElementById('panelList'), list);

  try{
    const sum = await pageReact_get({ chapter: currentChapter.index, page: pageIndex });
    document.getElementById('pageReactWrap').innerHTML = buildReactChips(sum);
    attachReactHandlers(document.getElementById('pageReactWrap'),'page');
  }catch(e){}

  document.getElementById('backdrop').classList.add('open');
  const mini = document.getElementById('miniPanel'); mini.classList.add('open'); mini.setAttribute('aria-hidden','false');
}
function closeMini(){ document.getElementById('backdrop').classList.remove('open'); const mini=document.getElementById('miniPanel'); mini.classList.remove('open'); mini.setAttribute('aria-hidden','true'); }
document.getElementById('miniClose').addEventListener('click', closeMini);
document.getElementById('backdrop').addEventListener('click', closeMini);

// send in mini
function checkCooldown(key){ const last=parseInt(localStorage.getItem(key)||'0',10); const remain = COOLDOWN_S - (now()-last); return remain>0?remain:0; }
function setCooldown(key){ localStorage.setItem(key, String(now())); }
document.getElementById('panelSend').addEventListener('click', async ()=>{
  const body = document.getElementById('panelBody').value.trim();
  const msg  = document.getElementById('panelMsg');
  if(!body){ msg.textContent='Vi·∫øt g√¨ ƒë√≥ ƒë√£ nha'; return; }
  const cd = checkCooldown('cd_page'); if(cd){ msg.textContent='Ch·ªù '+cd+'s nha'; return; }
  const name = currentUser ? (currentUser.user_metadata?.user_name || currentUser.user_metadata?.full_name || currentUser.email || "GitHub") : anonLabel();
  const token=uuid();
  const row = await cmt_add({ chapter: currentChapter.index, page: currentPageForPanel, name, body, parent_id: null, edit_token: token });
  localStorage.setItem('cmt_token_'+row.id, token);
  commentsCache.unshift(row);
  msg.textContent='ƒê√£ g·ª≠i';
  setCooldown('cd_page');
  await openMini(currentPageForPanel);
  await renderAggregated(currentChapter);
});

// chapter composer
document.getElementById('chapSend').addEventListener('click', async ()=>{
  const body = document.getElementById('chapBody').value.trim();
  const msg  = document.getElementById('chapMsg');
  if(!body){ msg.textContent='Vi·∫øt g√¨ ƒë√≥ ƒë√£ nha'; return; }
  const cd = checkCooldown('cd_chap'); if(cd){ msg.textContent='Ch·ªù '+cd+'s nha'; return; }
  const name = currentUser ? (currentUser.user_metadata?.user_name || currentUser.user_metadata?.full_name || currentUser.email || "GitHub") : anonLabel();
  const token=uuid();
  const row = await cmt_add({ chapter: currentChapter.index, page: null, name, body, parent_id: null, edit_token: token });
  localStorage.setItem('cmt_token_'+row.id, token);
  commentsCache.unshift(row);
  document.getElementById('chapBody').value=''; msg.textContent='ƒê√£ g·ª≠i';
  setCooldown('cd_chap');
  await renderAggregated(currentChapter);
});

// agg feed
function renderAggAll(container, items, limit, moreBtn){
  const roots = items.filter(x=>x.parent_id==null);
  const arr = roots.sort((a,b)=>{
    const da = new Date(a.created_at).getTime(), db=new Date(b.created_at).getTime();
    return aggSort==='old' ? (da-db) : (db-da);
  });
  const list = arr.slice(0,limit);
  container.innerHTML = list.map(it=>commentHTML(it)).join('') || '<div class="meta">Ch∆∞a c√≥ b√¨nh lu·∫≠n.</div>';
  // attach and load replies for each
  bindCommentActions(container);
  // show/hide more
  moreBtn.style.display = roots.length>limit ? 'inline-block':'none';
}
async function renderAggregated(ch){
  commentsCache = await cmt_fetch(ch.index);
  pagesWithComments = new Set(commentsCache.filter(c=> c.page!=null).map(c=> c.page));
  renderAggAll(document.getElementById('aggAll'), commentsCache, allLimit, document.getElementById('moreAll'));
  document.querySelectorAll('.page-wrap').forEach((wrap, idx)=>{
    const p = idx+1; wrap.querySelector('.badge').style.display = pagesWithComments.has(p) ? 'flex' : 'none';
  });
}
document.getElementById('moreAll').addEventListener('click', ()=>{ allLimit+=20; renderAggregated(currentChapter); });
document.getElementById('aggSort').addEventListener('change', (e)=>{ aggSort = e.target.value==='old'?'old':'new'; renderAggregated(currentChapter); });

// Hearts
async function updateHeartUI(ch){
  const s = await heart_get({ chapter: ch.index });
  const btn = document.getElementById('heartBtn'), label=document.getElementById('heartLabel'), note=document.getElementById('heartNote');
  btn.classList.toggle('active', !!s.active);
  label.textContent = s.active ? 'ƒê√£ th·∫£ tim' : 'Th·∫£ tim';
  note.textContent  = `(${s.count||0})`;
  btn.onclick = async ()=>{
    const r = await heart_toggle({ chapter: ch.index });
    btn.classList.toggle('active', !!r.active);
    label.textContent = r.active ? 'ƒê√£ th·∫£ tim' : 'Th·∫£ tim';
    note.textContent  = `(${r.count||0})`;
  };
}

// UI misc
const toTopBtn = document.getElementById('toTopBtn');
function updateTopBtnVisibility(){ const show = window.scrollY>600 && document.getElementById('readerView').style.display!=='none'; toTopBtn.style.display= show?'flex':'none'; }
toTopBtn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
window.addEventListener('scroll', updateTopBtnVisibility);

// router + viewer
function populateSelect(id){ const sel=document.getElementById(id); sel.innerHTML=''; CHAPTERS.forEach(ch=>{ const o=document.createElement('option'); o.value=ch.id; o.textContent=ch.title; sel.appendChild(o); }); sel.addEventListener('change', ()=> location.hash = sel.value); }
function neighborChapter(id, dir){ const idx=CHAPTERS.findIndex(c=>c.id===id); const nx=CHAPTERS[idx+dir]; return nx?nx.id:null; }
function route(){ const h=getHash()||'home'; if(h==='home'){ document.getElementById('homeView').style.display='grid'; document.getElementById('readerView').style.display='none'; } else { const ch=CHAPTERS.find(c=>c.id===h) || CHAPTERS[0]; renderChapter(ch); } }
async function renderChapter(ch){
  document.getElementById('homeView').style.display='none'; document.getElementById('readerView').style.display='block'; currentChapter=ch;
  document.getElementById('chapTitle').textContent = `${SERIES_TITLE} ‚Äî ${ch.title}`;
  ['Top','Mid','Bottom'].forEach(pos=>{ const sel=document.getElementById('chapterSel'+pos); if(sel) sel.value=ch.id; });
  const viewer=document.getElementById('viewer'); viewer.innerHTML='';
  let missing=0;
  for(let i=1;i<=2000;i++){
    const url = await findExistingUrl(ch.path, ch.index, i);
    if(!url){ missing++; if(missing>=3 || i===1) break; continue; }
    missing=0;
    const wrap=document.createElement('div'); wrap.className='page-wrap';
    const img=document.createElement('img'); img.src=url; img.className='page'; img.loading='lazy'; img.alt=`${ch.title} ‚Äî trang ${i}`;
    img.addEventListener('click', ()=> openMini(i));
    const badge=document.createElement('div'); badge.className='badge'; badge.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>';
    wrap.appendChild(img); wrap.appendChild(badge); viewer.appendChild(wrap);
  }
  const prevId=neighborChapter(ch.id,-1), nextId=neighborChapter(ch.id,1);
  document.getElementById('prevTop').onclick = ()=> prevId && (location.hash=prevId);
  document.getElementById('nextTop').onclick = ()=> nextId && (location.hash=nextId);
  document.getElementById('prevBottom').onclick = ()=> prevId && (location.hash=prevId);
  document.getElementById('nextBottom').onclick = ()=> nextId && (location.hash=nextId);

  await updateHeartUI(ch); await renderAggregated(ch); await auth_refreshUI();
  window.scrollTo({top:0,behavior:'smooth'}); updateTopBtnVisibility();
}

(async function init(){
  await initDB();
  CHAPTERS = await buildChaptersAuto();
  function buildTOC(containerId){ const box=document.querySelector(containerId); box.innerHTML=''; CHAPTERS.forEach(ch=>{ const a=document.createElement('a'); a.href=`#${ch.id}`; a.textContent=ch.title; a.className='btn'; a.addEventListener('click',(e)=>{ e.preventDefault(); location.hash=ch.id; }); box.appendChild(a); }); }
  buildTOC('#homeTOC');
  ['chapterSelTop','chapterSelMid','chapterSelBottom'].forEach(populateSelect);
  document.querySelector('#fitSel').addEventListener('change', ()=>{
    document.querySelectorAll('.page').forEach(img=>{
      const mode=document.querySelector('#fitSel').value;
      if(mode==='fit'){ img.style.width='100%'; img.style.maxWidth='100%'; img.style.marginLeft='auto'; img.style.marginRight='auto'; }
      else{ img.style.width='auto'; img.style.maxWidth='none'; img.style.marginLeft='auto'; img.style.marginRight='auto'; }
    });
  });
  document.getElementById('authBtn').addEventListener('click', auth_toggle);
  window.addEventListener('hashchange', route);
  route();
  updateTopBtnVisibility();
  auth_refreshUI();
})();
</script>
</body>
</html>
